export var BinaryOperation;
(function (BinaryOperation) {
    BinaryOperation["EQ"] = "eq";
    BinaryOperation["NEQ"] = "neq";
    BinaryOperation["GT"] = "gt";
    BinaryOperation["LT"] = "lt";
    BinaryOperation["GE"] = "ge";
    BinaryOperation["LE"] = "le";
    BinaryOperation["OR"] = "or";
    BinaryOperation["AND"] = "and";
    BinaryOperation["MUL"] = "mul";
    BinaryOperation["DIV"] = "div";
    BinaryOperation["MOD"] = "mod";
    BinaryOperation["ADD"] = "add";
    BinaryOperation["SUB"] = "sub";
})(BinaryOperation || (BinaryOperation = {}));
export var UnaryOperation;
(function (UnaryOperation) {
    UnaryOperation["NOT"] = "not";
    UnaryOperation["NEG"] = "neg";
    UnaryOperation["IS_NULL"] = "null";
})(UnaryOperation || (UnaryOperation = {}));
export class ConvertVisitor {
    visitConst(expr) {
        return expr;
    }
    visitProp(expr) {
        return new Prop(expr.instance.accept(this), expr.name);
    }
    visitParam(expr) {
        return expr;
    }
    visitBinary(expr) {
        return new BinOp(expr.left.accept(this), expr.op, expr.right.accept(this));
    }
    visitUnary(expr) {
        return new UnOp(expr.op, expr.operand.accept(this));
    }
    visitCall(expr) {
        return new Call(expr.name, expr.args.map(e => e.accept(this)));
    }
    visitLambda(expr) {
        return new Lambda(expr.body.accept(this), expr.param);
    }
}
const emptyContext = () => {
    const keys = [];
    const names = [];
    let next = 0;
    return {
        symbolToString(symbol) {
            const index = keys.indexOf(symbol);
            if (-1 !== index) {
                return names[index];
            }
            const name = `e${++next}`;
            keys.push(symbol);
            names.push(name);
            return name;
        }
    };
};
export class Expr {
}
export class Const extends Expr {
    constructor(value) {
        super();
        this.value = value;
    }
    accept(visitor) { return visitor.visitConst(this); }
    eq(other) { return other instanceof Const && other.value === this.value; }
    toString() { return JSON.stringify(this.value); }
}
export class Prop extends Expr {
    constructor(instance, name) {
        super();
        this.instance = instance;
        this.name = name;
    }
    accept(visitor) { return visitor.visitProp(this); }
    eq(other) { return other instanceof Prop && other.instance.eq(this.instance) && other.name === this.name; }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.instance.toString(ctx)}.${this.name}`;
    }
}
export class Param extends Expr {
    constructor(name) {
        super();
        this.name = name;
    }
    accept(visitor) { return visitor.visitParam(this); }
    eq(other) { return other instanceof Param && other.name === this.name; }
    toString(context) {
        // in protocol v1 param may be string...
        if ('string' === typeof this.name) {
            return this.name;
        }
        const ctx = context || emptyContext();
        return ctx.symbolToString(this.name);
    }
}
export class BinOp extends Expr {
    constructor(left, op, right) {
        super();
        this.left = left;
        this.op = op;
        this.right = right;
    }
    static unwind(head, tail) {
        if (!tail || !tail.length) {
            return head;
        }
        return tail.reduce((left, vals) => {
            const op = vals[1];
            const right = vals[3];
            return new BinOp(left, op, right);
        }, head);
    }
    accept(visitor) { return visitor.visitBinary(this); }
    eq(other) {
        return other instanceof BinOp && other.op === this.op && other.left.eq(this.left) && other.right.eq(this.right);
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `(${this.left.toString(ctx)} ${BinOp.binOpStrings[this.op]} ${this.right.toString(ctx)})`;
    }
}
BinOp.binOpStrings = {
    [BinaryOperation.EQ]: '=',
    [BinaryOperation.NEQ]: '!=',
    [BinaryOperation.GT]: '>',
    [BinaryOperation.LT]: '<',
    [BinaryOperation.LE]: '>=',
    [BinaryOperation.GE]: '<=',
    [BinaryOperation.OR]: '||',
    [BinaryOperation.AND]: '&&',
    [BinaryOperation.MUL]: '*',
    [BinaryOperation.DIV]: '/',
    [BinaryOperation.MOD]: '%',
    [BinaryOperation.ADD]: '+',
    [BinaryOperation.SUB]: '-'
};
export class UnOp extends Expr {
    constructor(op, operand) {
        super();
        this.op = op;
        this.operand = operand;
    }
    accept(visitor) { return visitor.visitUnary(this); }
    eq(other) {
        return other instanceof UnOp && other.op === this.op && other.operand.eq(this.operand);
    }
    toString(context) {
        const ctx = context || emptyContext();
        if (this.op === UnaryOperation.NOT) {
            return `!(${this.operand.toString(ctx)})`;
        }
        return `${UnOp.unOpStrings[this.op]}(${this.operand.toString(ctx)})`;
    }
}
UnOp.unOpStrings = {
    [UnaryOperation.NOT]: 'not',
    [UnaryOperation.NEG]: 'neg',
    [UnaryOperation.IS_NULL]: 'isNull'
};
export class Call extends Expr {
    constructor(name, args) {
        super();
        if (Call.knownFunctions[name]) {
            const argCount = Call.knownFunctions[name];
            if ('number' === typeof argCount) {
                if (argCount !== args.length) {
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument count: ${argCount}`);
                }
            }
            else {
                if (-1 === argCount.indexOf(args.length)) {
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument counts: ${argCount.join(',')}`);
                }
            }
        }
        this.name = name;
        this.args = args;
    }
    accept(visitor) { return visitor.visitCall(this); }
    eq(other) {
        if (!(other instanceof Call)) {
            return false;
        }
        if (other.name !== this.name) {
            return false;
        }
        if (other.args.length !== this.args.length) {
            return false;
        }
        for (let i = 0; i < other.args.length; i = i + 1) {
            if (!other.args[i].eq(this.args[i])) {
                return false;
            }
        }
        return true;
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.name}(${this.args.map(arg => arg.toString(ctx)).join(',')})`;
    }
}
Call.knownFunctions = {
    contains: 2,
    substring: [2, 3]
};
export class Lambda extends Expr {
    constructor(body, param) {
        super();
        this.body = body;
        this.param = param;
    }
    accept(visitor) { return visitor.visitLambda(this); }
    eq(other) {
        if (!(other instanceof Lambda)) {
            return false;
        }
        throw new Error('Lambda equality is not implemented!');
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.param.toString(ctx)} => ${this.body.toString(ctx)}`;
    }
    substituteParameter(target) {
        return new Lambda(substituteParameter(this.param, target, this.body), target);
    }
    and(other) {
        if (this.param.eq(other.param)) {
            return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.body), this.param);
        }
        return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.substituteParameter(this.param).body), this.param);
    }
}
// export function parse (raw : string) : Expr {
//   return parser.parse(raw);
// }
export function substituteParameter(source, target, expression) {
    const visitor = new class extends ConvertVisitor {
        visitParam(p) { return p.eq(source) ? target : p; }
    };
    return expression.accept(visitor);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLENBQU4sSUFBWSxlQWNYO0FBZEQsV0FBWSxlQUFlO0lBQ3pCLDRCQUFTLENBQUE7SUFDVCw4QkFBVyxDQUFBO0lBQ1gsNEJBQVMsQ0FBQTtJQUNULDRCQUFTLENBQUE7SUFDVCw0QkFBUyxDQUFBO0lBQ1QsNEJBQVMsQ0FBQTtJQUNULDRCQUFTLENBQUE7SUFDVCw4QkFBVyxDQUFBO0lBQ1gsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7SUFDWCw4QkFBVyxDQUFBO0lBQ1gsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7QUFDYixDQUFDLEVBZFcsZUFBZSxLQUFmLGVBQWUsUUFjMUI7QUFFRCxNQUFNLENBQU4sSUFBWSxjQUlYO0FBSkQsV0FBWSxjQUFjO0lBQ3hCLDZCQUFXLENBQUE7SUFDWCw2QkFBVyxDQUFBO0lBQ1gsa0NBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUpXLGNBQWMsS0FBZCxjQUFjLFFBSXpCO0FBWUQsTUFBTSxPQUFPLGNBQWM7SUFDekIsVUFBVSxDQUFDLElBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELFNBQVMsQ0FBQyxJQUFVO1FBQ2hCLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFDRCxVQUFVLENBQUMsSUFBVztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsV0FBVyxDQUFDLElBQVc7UUFDbkIsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUNELFVBQVUsQ0FBQyxJQUFVO1FBQ2pCLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQ3hELENBQUM7SUFDRCxTQUFTLENBQUMsSUFBVTtRQUNoQixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBQ0QsV0FBVyxDQUFDLElBQVk7UUFDcEIsT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDMUQsQ0FBQztDQUNGO0FBTUQsTUFBTSxZQUFZLEdBQUcsR0FBb0IsRUFBRTtJQUN6QyxNQUFNLElBQUksR0FBYSxFQUFFLENBQUM7SUFDMUIsTUFBTSxLQUFLLEdBQWEsRUFBRSxDQUFDO0lBQzNCLElBQUksSUFBSSxHQUFHLENBQUMsQ0FBQztJQUNiLE9BQU87UUFDTCxjQUFjLENBQUMsTUFBYztZQUMzQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ25DLElBQUksQ0FBQyxDQUFDLEtBQUssS0FBSyxFQUFFO2dCQUNoQixPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUMsQ0FBQzthQUNyQjtZQUNELE1BQU0sSUFBSSxHQUFHLElBQUksRUFBRSxJQUFJLEVBQUUsQ0FBQztZQUMxQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBQ2xCLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDakIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO0tBQ0YsQ0FBQztBQUNKLENBQUMsQ0FBQTtBQUdELE1BQU0sT0FBZ0IsSUFBSTtDQUl6QjtBQUVELE1BQU0sT0FBTyxLQUFNLFNBQVEsSUFBSTtJQUU3QixZQUFZLEtBQW1CO1FBQzNCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztJQUNELE1BQU0sQ0FBSSxPQUF3QixJQUFJLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsRUFBRSxDQUFDLEtBQVksSUFBYyxPQUFPLEtBQUssWUFBWSxLQUFLLElBQUksS0FBSyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMzRixRQUFRLEtBQUssT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDbEQ7QUFFRCxNQUFNLE9BQU8sSUFBSyxTQUFRLElBQUk7SUFHNUIsWUFBWSxRQUFlLEVBQUUsSUFBYTtRQUN0QyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxNQUFNLENBQUksT0FBd0IsSUFBSSxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLEVBQUUsQ0FBQyxLQUFZLElBQWMsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVILFFBQVEsQ0FBQyxPQUF5QjtRQUNoQyxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEMsT0FBTyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztJQUN2RCxDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sS0FBTSxTQUFRLElBQUk7SUFFN0IsWUFBWSxJQUFhO1FBQ3JCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUM7SUFDckIsQ0FBQztJQUNELE1BQU0sQ0FBSSxPQUF3QixJQUFJLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsRUFBRSxDQUFDLEtBQVksSUFBYyxPQUFPLEtBQUssWUFBWSxLQUFLLElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN6RixRQUFRLENBQUMsT0FBeUI7UUFDaEMsd0NBQXdDO1FBQ3hDLElBQUksUUFBUSxLQUFLLE9BQU8sSUFBSSxDQUFDLElBQUksRUFBRTtZQUMvQixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUM7U0FDcEI7UUFDRCxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEMsT0FBTyxHQUFHLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUN2QyxDQUFDO0NBQ0Y7QUFFRCxNQUFNLE9BQU8sS0FBTSxTQUFRLElBQUk7SUE2QjdCLFlBQWEsSUFBVyxFQUFFLEVBQW9CLEVBQUUsS0FBWTtRQUMxRCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDckIsQ0FBQztJQWxCRCxNQUFNLENBQUMsTUFBTSxDQUFFLElBQVcsRUFBRSxJQUFzQztRQUNoRSxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN6QixPQUFPLElBQUksQ0FBQztTQUNiO1FBQ0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQ2hDLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQW1CLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxDQUFDLEVBQUUsSUFBSSxDQUFDLENBQUM7SUFDWCxDQUFDO0lBVUQsTUFBTSxDQUFJLE9BQXdCLElBQUksT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN6RSxFQUFFLENBQUMsS0FBWTtRQUNiLE9BQU8sS0FBSyxZQUFZLEtBQUssSUFBSSxLQUFLLENBQUMsRUFBRSxLQUFLLElBQUksQ0FBQyxFQUFFLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUNsSCxDQUFDO0lBQ0QsUUFBUSxDQUFDLE9BQXlCO1FBQ2hDLE1BQU0sR0FBRyxHQUFHLE9BQU8sSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN0QyxPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUNuRyxDQUFDOztBQXpDYyxrQkFBWSxHQUFHO0lBQzFCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUc7SUFDekIsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSTtJQUMzQixDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHO0lBQ3pCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUc7SUFDekIsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSTtJQUMxQixDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJO0lBQzFCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUk7SUFDMUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsSUFBSTtJQUMzQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHO0lBQzFCLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUc7SUFDMUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRztJQUMxQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHO0lBQzFCLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUc7Q0FDN0IsQ0FBQTtBQThCSCxNQUFNLE9BQU8sSUFBSyxTQUFRLElBQUk7SUFRNUIsWUFBWSxFQUFtQixFQUFFLE9BQWE7UUFDMUMsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO0lBQzNCLENBQUM7SUFDRCxNQUFNLENBQUksT0FBd0IsSUFBSSxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLEVBQUUsQ0FBQyxLQUFZO1FBQ2IsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLEtBQUssQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDekYsQ0FBQztJQUNELFFBQVEsQ0FBQyxPQUF5QjtRQUNoQyxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEMsSUFBSSxJQUFJLENBQUMsRUFBRSxLQUFLLGNBQWMsQ0FBQyxHQUFHLEVBQUU7WUFDbEMsT0FBTyxLQUFLLElBQUksQ0FBQyxPQUFPLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7U0FDM0M7UUFDRCxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQztJQUN2RSxDQUFDOztBQXRCYyxnQkFBVyxHQUFHO0lBQ3pCLENBQUMsY0FBYyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEtBQUs7SUFDM0IsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSztJQUMzQixDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsRUFBRSxRQUFRO0NBQ3JDLENBQUE7QUF5QkgsTUFBTSxPQUFPLElBQUssU0FBUSxJQUFJO0lBTzVCLFlBQVksSUFBWSxFQUFFLElBQWtCO1FBQ3hDLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQzNCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDM0MsSUFBSSxRQUFRLEtBQUssT0FBTyxRQUFRLEVBQUU7Z0JBQzlCLElBQUksUUFBUSxLQUFLLElBQUksQ0FBQyxNQUFNLEVBQUU7b0JBQzFCLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLElBQUksS0FBSyxJQUFJLENBQUMsTUFBTSw4QkFBOEIsUUFBUSxFQUFFLENBQUMsQ0FBQztpQkFDL0c7YUFDSjtpQkFBTTtnQkFDSCxJQUFJLENBQUMsQ0FBQyxLQUFLLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFO29CQUN0QyxNQUFNLElBQUksS0FBSyxDQUFDLDhCQUE4QixJQUFJLEtBQUssSUFBSSxDQUFDLE1BQU0sK0JBQStCLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO2lCQUMxSDthQUNKO1NBQ0o7UUFDRCxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNyQixDQUFDO0lBQ0QsTUFBTSxDQUFJLE9BQXVCLElBQUksT0FBTyxPQUFPLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN0RSxFQUFFLENBQUMsS0FBVztRQUNWLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxJQUFJLENBQUMsRUFBRTtZQUMxQixPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELElBQUksS0FBSyxDQUFDLElBQUksS0FBSyxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQzFCLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN4QyxPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsRUFBRTtZQUM5QyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFO2dCQUNqQyxPQUFPLEtBQUssQ0FBQzthQUNoQjtTQUNKO1FBQ0QsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELFFBQVEsQ0FBQyxPQUF5QjtRQUNoQyxNQUFNLEdBQUcsR0FBRyxPQUFPLElBQUksWUFBWSxFQUFFLENBQUM7UUFDdEMsT0FBTyxHQUFHLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7SUFDOUUsQ0FBQzs7QUE1Q00sbUJBQWMsR0FBdUI7SUFDeEMsUUFBUSxFQUFFLENBQUM7SUFDWCxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ3BCLENBQUE7QUE0Q0gsTUFBTSxPQUFPLE1BQU8sU0FBUSxJQUFJO0lBRzlCLFlBQVksSUFBVSxFQUFFLEtBQVk7UUFDaEMsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN2QixDQUFDO0lBQ0QsTUFBTSxDQUFJLE9BQXVCLElBQUksT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RSxFQUFFLENBQUMsS0FBVztRQUNWLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxNQUFNLENBQUMsRUFBRTtZQUM1QixPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBQ0QsUUFBUSxDQUFDLE9BQXlCO1FBQ2hDLE1BQU0sR0FBRyxHQUFHLE9BQU8sSUFBSSxZQUFZLEVBQUUsQ0FBQztRQUN0QyxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQztJQUNyRSxDQUFDO0lBQ0QsbUJBQW1CLENBQUMsTUFBYTtRQUM3QixPQUFPLElBQUksTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBQ0QsR0FBRyxDQUFDLEtBQWE7UUFDYixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM1QixPQUFPLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3hGO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekgsQ0FBQztDQUNGO0FBRUQsZ0RBQWdEO0FBQ2hELDhCQUE4QjtBQUM5QixJQUFJO0FBRUosTUFBTSxVQUFVLG1CQUFtQixDQUFFLE1BQWEsRUFBRSxNQUFhLEVBQUUsVUFBZ0I7SUFDakYsTUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFNLFNBQVEsY0FBYztRQUM1QyxVQUFVLENBQUMsQ0FBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzdELENBQUE7SUFDRCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDcEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBlbnVtIEJpbmFyeU9wZXJhdGlvbiB7XG4gIEVRID0gJ2VxJyxcbiAgTkVRID0gJ25lcScsXG4gIEdUID0gJ2d0JyxcbiAgTFQgPSAnbHQnLFxuICBHRSA9ICdnZScsXG4gIExFID0gJ2xlJyxcbiAgT1IgPSAnb3InLFxuICBBTkQgPSAnYW5kJyxcbiAgTVVMID0gJ211bCcsXG4gIERJViA9ICdkaXYnLFxuICBNT0QgPSAnbW9kJyxcbiAgQUREID0gJ2FkZCcsXG4gIFNVQiA9ICdzdWInXG59XG5cbmV4cG9ydCBlbnVtIFVuYXJ5T3BlcmF0aW9uIHtcbiAgTk9UID0gJ25vdCcsXG4gIE5FRyA9ICduZWcnLFxuICBJU19OVUxMID0gJ251bGwnXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhwclZpc2l0b3I8VD4ge1xuICB2aXNpdENvbnN0KGV4cHI6IENvbnN0KTogVFxuICB2aXNpdFByb3AoZXhwcjogUHJvcCkgOiBUXG4gIHZpc2l0UGFyYW0oZXhwcjogUGFyYW0pIDogVFxuICB2aXNpdEJpbmFyeShleHByOiBCaW5PcCkgOiBUXG4gIHZpc2l0VW5hcnkoZXhwcjogVW5PcCkgOiBUXG4gIHZpc2l0Q2FsbChleHByOiBDYWxsKSA6IFRcbiAgdmlzaXRMYW1iZGEoZXhwcjogTGFtYmRhKSA6IFRcbn1cblxuZXhwb3J0IGNsYXNzIENvbnZlcnRWaXNpdG9yIGltcGxlbWVudHMgRXhwclZpc2l0b3I8RXhwcj4ge1xuICB2aXNpdENvbnN0KGV4cHI6IENvbnN0KTogRXhwciB7XG4gICAgICByZXR1cm4gZXhwcjtcbiAgfVxuICB2aXNpdFByb3AoZXhwcjogUHJvcCk6IEV4cHIge1xuICAgICAgcmV0dXJuIG5ldyBQcm9wKGV4cHIuaW5zdGFuY2UuYWNjZXB0KHRoaXMpLCBleHByLm5hbWUpO1xuICB9XG4gIHZpc2l0UGFyYW0oZXhwcjogUGFyYW0pOiBFeHByIHtcbiAgICAgIHJldHVybiBleHByO1xuICB9XG4gIHZpc2l0QmluYXJ5KGV4cHI6IEJpbk9wKTogRXhwciB7XG4gICAgICByZXR1cm4gbmV3IEJpbk9wKGV4cHIubGVmdC5hY2NlcHQodGhpcyksIGV4cHIub3AsIGV4cHIucmlnaHQuYWNjZXB0KHRoaXMpKTtcbiAgfVxuICB2aXNpdFVuYXJ5KGV4cHI6IFVuT3ApOiBFeHByIHtcbiAgICAgIHJldHVybiBuZXcgVW5PcChleHByLm9wLCBleHByLm9wZXJhbmQuYWNjZXB0KHRoaXMpKTtcbiAgfVxuICB2aXNpdENhbGwoZXhwcjogQ2FsbCk6IEV4cHIge1xuICAgICAgcmV0dXJuIG5ldyBDYWxsKGV4cHIubmFtZSwgZXhwci5hcmdzLm1hcChlID0+IGUuYWNjZXB0KHRoaXMpKSk7XG4gIH1cbiAgdmlzaXRMYW1iZGEoZXhwcjogTGFtYmRhKTogRXhwciB7XG4gICAgICByZXR1cm4gbmV3IExhbWJkYShleHByLmJvZHkuYWNjZXB0KHRoaXMpLCBleHByLnBhcmFtKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvU3RyaW5nQ29udGV4dCB7XG4gIHN5bWJvbFRvU3RyaW5nKHN5bWJvbDogU3ltYm9sKTogc3RyaW5nO1xufVxuXG5jb25zdCBlbXB0eUNvbnRleHQgPSAoKTogVG9TdHJpbmdDb250ZXh0ID0+IHtcbiAgY29uc3Qga2V5czogU3ltYm9sW10gPSBbXTtcbiAgY29uc3QgbmFtZXM6IHN0cmluZ1tdID0gW107XG4gIGxldCBuZXh0ID0gMDtcbiAgcmV0dXJuIHtcbiAgICBzeW1ib2xUb1N0cmluZyhzeW1ib2w6IFN5bWJvbCkge1xuICAgICAgY29uc3QgaW5kZXggPSBrZXlzLmluZGV4T2Yoc3ltYm9sKTtcbiAgICAgIGlmICgtMSAhPT0gaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG5hbWVzW2luZGV4XTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5hbWUgPSBgZSR7KytuZXh0fWA7XG4gICAgICBrZXlzLnB1c2goc3ltYm9sKTtcbiAgICAgIG5hbWVzLnB1c2gobmFtZSk7XG4gICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gIH07XG59XG5cblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIEV4cHIge1xuICBhYnN0cmFjdCBhY2NlcHQ8VD4odmlzaXRvciA6IEV4cHJWaXNpdG9yPFQ+KSA6IFRcbiAgYWJzdHJhY3QgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW5cbiAgYWJzdHJhY3QgdG9TdHJpbmcoY29udGV4dD86IFRvU3RyaW5nQ29udGV4dCk6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENvbnN0IGV4dGVuZHMgRXhwciB7XG4gIHZhbHVlIDogc3RyaW5nfG51bGxcbiAgY29uc3RydWN0b3IodmFsdWUgOiBzdHJpbmd8bnVsbCkge1xuICAgICAgc3VwZXIoKTtcbiAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgfVxuICBhY2NlcHQ8VD4odmlzaXRvciA6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0Q29uc3QodGhpcyk7IH1cbiAgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW4geyByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBDb25zdCAmJiBvdGhlci52YWx1ZSA9PT0gdGhpcy52YWx1ZTsgfVxuICB0b1N0cmluZygpIHsgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHRoaXMudmFsdWUpOyB9XG59XG5cbmV4cG9ydCBjbGFzcyBQcm9wIGV4dGVuZHMgRXhwciB7XG4gIGluc3RhbmNlOiBFeHByXG4gIG5hbWU6IHN0cmluZ1xuICBjb25zdHJ1Y3RvcihpbnN0YW5jZSA6IEV4cHIsIG5hbWUgOiBzdHJpbmcpIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICB0aGlzLmluc3RhbmNlID0gaW5zdGFuY2U7XG4gICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICB9XG4gIGFjY2VwdDxUPih2aXNpdG9yIDogRXhwclZpc2l0b3I8VD4pIHsgcmV0dXJuIHZpc2l0b3IudmlzaXRQcm9wKHRoaXMpOyB9XG4gIGVxKG90aGVyIDogRXhwcikgOiBib29sZWFuIHsgcmV0dXJuIG90aGVyIGluc3RhbmNlb2YgUHJvcCAmJiBvdGhlci5pbnN0YW5jZS5lcSh0aGlzLmluc3RhbmNlKSAmJiBvdGhlci5uYW1lID09PSB0aGlzLm5hbWU7IH1cbiAgdG9TdHJpbmcoY29udGV4dD86IFRvU3RyaW5nQ29udGV4dCkge1xuICAgIGNvbnN0IGN0eCA9IGNvbnRleHQgfHwgZW1wdHlDb250ZXh0KCk7XG4gICAgcmV0dXJuIGAke3RoaXMuaW5zdGFuY2UudG9TdHJpbmcoY3R4KX0uJHt0aGlzLm5hbWV9YDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUGFyYW0gZXh0ZW5kcyBFeHByIHtcbiAgbmFtZSA6IFN5bWJvbFxuICBjb25zdHJ1Y3RvcihuYW1lIDogU3ltYm9sKSB7XG4gICAgICBzdXBlcigpO1xuICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfVxuICBhY2NlcHQ8VD4odmlzaXRvciA6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0UGFyYW0odGhpcyk7IH1cbiAgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW4geyByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBQYXJhbSAmJiBvdGhlci5uYW1lID09PSB0aGlzLm5hbWU7IH1cbiAgdG9TdHJpbmcoY29udGV4dD86IFRvU3RyaW5nQ29udGV4dCkge1xuICAgIC8vIGluIHByb3RvY29sIHYxIHBhcmFtIG1heSBiZSBzdHJpbmcuLi5cbiAgICBpZiAoJ3N0cmluZycgPT09IHR5cGVvZiB0aGlzLm5hbWUpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubmFtZTtcbiAgICB9XG4gICAgY29uc3QgY3R4ID0gY29udGV4dCB8fCBlbXB0eUNvbnRleHQoKTtcbiAgICByZXR1cm4gY3R4LnN5bWJvbFRvU3RyaW5nKHRoaXMubmFtZSk7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEJpbk9wIGV4dGVuZHMgRXhwciB7XG4gIHByaXZhdGUgc3RhdGljIGJpbk9wU3RyaW5ncyA9IHtcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uRVFdOiAnPScsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLk5FUV06ICchPScsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLkdUXTogJz4nLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5MVF06ICc8JyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uTEVdOiAnPj0nLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5HRV06ICc8PScsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLk9SXTogJ3x8JyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uQU5EXTogJyYmJyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uTVVMXTogJyonLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5ESVZdOiAnLycsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLk1PRF06ICclJyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uQUREXTogJysnLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5TVUJdOiAnLSdcbiAgfVxuICBzdGF0aWMgdW53aW5kIChoZWFkIDogRXhwciwgdGFpbCA6IEFycmF5PFthbnksIHN0cmluZywgYW55LCBFeHByXT4pIHtcbiAgICBpZiAoIXRhaWwgfHwgIXRhaWwubGVuZ3RoKSB7XG4gICAgICByZXR1cm4gaGVhZDtcbiAgICB9XG4gICAgcmV0dXJuIHRhaWwucmVkdWNlKChsZWZ0LCB2YWxzKSA9PiB7XG4gICAgICBjb25zdCBvcCA9IHZhbHNbMV07XG4gICAgICBjb25zdCByaWdodCA9IHZhbHNbM107XG4gICAgICByZXR1cm4gbmV3IEJpbk9wKGxlZnQsIDxCaW5hcnlPcGVyYXRpb24+b3AsIHJpZ2h0KTtcbiAgICB9LCBoZWFkKTtcbiAgfVxuICBsZWZ0IDogRXhwclxuICBvcCA6IEJpbmFyeU9wZXJhdGlvblxuICByaWdodCA6IEV4cHJcbiAgY29uc3RydWN0b3IgKGxlZnQgOiBFeHByLCBvcCA6IEJpbmFyeU9wZXJhdGlvbiwgcmlnaHQgOiBFeHByKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmxlZnQgPSBsZWZ0O1xuICAgIHRoaXMub3AgPSBvcDtcbiAgICB0aGlzLnJpZ2h0ID0gcmlnaHQ7XG4gIH1cbiAgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdEJpbmFyeSh0aGlzKTsgfVxuICBlcShvdGhlciA6IEV4cHIpIDogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG90aGVyIGluc3RhbmNlb2YgQmluT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIubGVmdC5lcSh0aGlzLmxlZnQpICYmIG90aGVyLnJpZ2h0LmVxKHRoaXMucmlnaHQpO1xuICB9XG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBgKCR7dGhpcy5sZWZ0LnRvU3RyaW5nKGN0eCl9ICR7QmluT3AuYmluT3BTdHJpbmdzW3RoaXMub3BdfSAke3RoaXMucmlnaHQudG9TdHJpbmcoY3R4KX0pYDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVW5PcCBleHRlbmRzIEV4cHIge1xuICBwcml2YXRlIHN0YXRpYyB1bk9wU3RyaW5ncyA9IHtcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5OT1RdOiAnbm90JyxcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5ORUddOiAnbmVnJyxcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5JU19OVUxMXTogJ2lzTnVsbCdcbiAgfVxuICBvcDogVW5hcnlPcGVyYXRpb25cbiAgb3BlcmFuZDogRXhwclxuICBjb25zdHJ1Y3RvcihvcCA6IFVuYXJ5T3BlcmF0aW9uLCBvcGVyYW5kOiBFeHByKSB7XG4gICAgICBzdXBlcigpO1xuICAgICAgdGhpcy5vcCA9IG9wO1xuICAgICAgdGhpcy5vcGVyYW5kID0gb3BlcmFuZDtcbiAgfVxuICBhY2NlcHQ8VD4odmlzaXRvciA6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0VW5hcnkodGhpcyk7IH1cbiAgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvdGhlciBpbnN0YW5jZW9mIFVuT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIub3BlcmFuZC5lcSh0aGlzLm9wZXJhbmQpO1xuICB9XG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIGlmICh0aGlzLm9wID09PSBVbmFyeU9wZXJhdGlvbi5OT1QpIHtcbiAgICAgIHJldHVybiBgISgke3RoaXMub3BlcmFuZC50b1N0cmluZyhjdHgpfSlgO1xuICAgIH1cbiAgICByZXR1cm4gYCR7VW5PcC51bk9wU3RyaW5nc1t0aGlzLm9wXX0oJHt0aGlzLm9wZXJhbmQudG9TdHJpbmcoY3R4KX0pYDtcbiAgfVxufVxuXG5pbnRlcmZhY2UgS25vd25GdW5jdGlvbkNhbGxzIHtcbiAgW25hbWUgOiBzdHJpbmddIDogQXJyYXk8bnVtYmVyPiB8IG51bWJlclxufVxuXG5leHBvcnQgY2xhc3MgQ2FsbCBleHRlbmRzIEV4cHIge1xuICBzdGF0aWMga25vd25GdW5jdGlvbnM6IEtub3duRnVuY3Rpb25DYWxscyA9IHtcbiAgICAgIGNvbnRhaW5zOiAyLFxuICAgICAgc3Vic3RyaW5nOiBbMiwgM11cbiAgfVxuICBuYW1lOiBzdHJpbmdcbiAgYXJnczogQXJyYXk8RXhwcj5cbiAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBhcmdzIDogQXJyYXk8RXhwcj4pIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICBpZiAoQ2FsbC5rbm93bkZ1bmN0aW9uc1tuYW1lXSkge1xuICAgICAgICAgIGNvbnN0IGFyZ0NvdW50ID0gQ2FsbC5rbm93bkZ1bmN0aW9uc1tuYW1lXTtcbiAgICAgICAgICBpZiAoJ251bWJlcicgPT09IHR5cGVvZiBhcmdDb3VudCkge1xuICAgICAgICAgICAgICBpZiAoYXJnQ291bnQgIT09IGFyZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgYXJndW1lbnQgY291bnQgZm9yICR7bmFtZX06ICR7YXJncy5sZW5ndGh9LCBhY2NlcHRlZCBhcmd1bWVudCBjb3VudDogJHthcmdDb3VudH1gKTtcbiAgICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGlmICgtMSA9PT0gYXJnQ291bnQuaW5kZXhPZihhcmdzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgIHRocm93IG5ldyBFcnJvcihgaW52YWxpZCBhcmd1bWVudCBjb3VudCBmb3IgJHtuYW1lfTogJHthcmdzLmxlbmd0aH0sIGFjY2VwdGVkIGFyZ3VtZW50IGNvdW50czogJHthcmdDb3VudC5qb2luKCcsJyl9YCk7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICAgICAgdGhpcy5hcmdzID0gYXJncztcbiAgfVxuICBhY2NlcHQ8VD4odmlzaXRvcjogRXhwclZpc2l0b3I8VD4pIHsgcmV0dXJuIHZpc2l0b3IudmlzaXRDYWxsKHRoaXMpOyB9XG4gIGVxKG90aGVyOiBFeHByKSB7XG4gICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIENhbGwpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKG90aGVyLm5hbWUgIT09IHRoaXMubmFtZSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdGhlci5hcmdzLmxlbmd0aCAhPT0gdGhpcy5hcmdzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3RoZXIuYXJncy5sZW5ndGg7IGkgPSBpICsgMSkge1xuICAgICAgICAgIGlmICghb3RoZXIuYXJnc1tpXS5lcSh0aGlzLmFyZ3NbaV0pKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuICB0b1N0cmluZyhjb250ZXh0PzogVG9TdHJpbmdDb250ZXh0KSB7XG4gICAgY29uc3QgY3R4ID0gY29udGV4dCB8fCBlbXB0eUNvbnRleHQoKTtcbiAgICByZXR1cm4gYCR7dGhpcy5uYW1lfSgke3RoaXMuYXJncy5tYXAoYXJnID0+IGFyZy50b1N0cmluZyhjdHgpKS5qb2luKCcsJyl9KWA7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIExhbWJkYSBleHRlbmRzIEV4cHIge1xuICBib2R5OiBFeHByXG4gIHBhcmFtOiBQYXJhbVxuICBjb25zdHJ1Y3Rvcihib2R5OiBFeHByLCBwYXJhbTogUGFyYW0pIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICB0aGlzLmJvZHkgPSBib2R5O1xuICAgICAgdGhpcy5wYXJhbSA9IHBhcmFtO1xuICB9XG4gIGFjY2VwdDxUPih2aXNpdG9yOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdExhbWJkYSh0aGlzKTsgfVxuICBlcShvdGhlcjogRXhwcikge1xuICAgICAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBMYW1iZGEpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdMYW1iZGEgZXF1YWxpdHkgaXMgbm90IGltcGxlbWVudGVkIScpO1xuICB9XG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBgJHt0aGlzLnBhcmFtLnRvU3RyaW5nKGN0eCl9ID0+ICR7dGhpcy5ib2R5LnRvU3RyaW5nKGN0eCl9YDtcbiAgfVxuICBzdWJzdGl0dXRlUGFyYW1ldGVyKHRhcmdldDogUGFyYW0pIHtcbiAgICAgIHJldHVybiBuZXcgTGFtYmRhKHN1YnN0aXR1dGVQYXJhbWV0ZXIodGhpcy5wYXJhbSwgdGFyZ2V0LCB0aGlzLmJvZHkpLCB0YXJnZXQpO1xuICB9XG4gIGFuZChvdGhlcjogTGFtYmRhKSB7XG4gICAgICBpZiAodGhpcy5wYXJhbS5lcShvdGhlci5wYXJhbSkpIHtcbiAgICAgICAgICByZXR1cm4gbmV3IExhbWJkYShuZXcgQmluT3AodGhpcy5ib2R5LCBCaW5hcnlPcGVyYXRpb24uQU5ELCBvdGhlci5ib2R5KSwgdGhpcy5wYXJhbSk7XG4gICAgICB9XG4gICAgICByZXR1cm4gbmV3IExhbWJkYShuZXcgQmluT3AodGhpcy5ib2R5LCBCaW5hcnlPcGVyYXRpb24uQU5ELCBvdGhlci5zdWJzdGl0dXRlUGFyYW1ldGVyKHRoaXMucGFyYW0pLmJvZHkpLCB0aGlzLnBhcmFtKTtcbiAgfVxufVxuXG4vLyBleHBvcnQgZnVuY3Rpb24gcGFyc2UgKHJhdyA6IHN0cmluZykgOiBFeHByIHtcbi8vICAgcmV0dXJuIHBhcnNlci5wYXJzZShyYXcpO1xuLy8gfVxuXG5leHBvcnQgZnVuY3Rpb24gc3Vic3RpdHV0ZVBhcmFtZXRlciAoc291cmNlOiBQYXJhbSwgdGFyZ2V0OiBQYXJhbSwgZXhwcmVzc2lvbjogRXhwcikge1xuICBjb25zdCB2aXNpdG9yID0gbmV3IGNsYXNzIGV4dGVuZHMgQ29udmVydFZpc2l0b3Ige1xuICAgICAgdmlzaXRQYXJhbShwOiBQYXJhbSkgeyByZXR1cm4gcC5lcShzb3VyY2UpID8gdGFyZ2V0IDogcDsgfVxuICB9XG4gIHJldHVybiBleHByZXNzaW9uLmFjY2VwdCh2aXNpdG9yKTtcbn0iXX0=
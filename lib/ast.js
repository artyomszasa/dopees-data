export var BinaryOperation;
(function (BinaryOperation) {
    BinaryOperation["EQ"] = "eq";
    BinaryOperation["NEQ"] = "neq";
    BinaryOperation["GT"] = "gt";
    BinaryOperation["LT"] = "lt";
    BinaryOperation["GE"] = "ge";
    BinaryOperation["LE"] = "le";
    BinaryOperation["OR"] = "or";
    BinaryOperation["AND"] = "and";
    BinaryOperation["MUL"] = "mul";
    BinaryOperation["DIV"] = "div";
    BinaryOperation["MOD"] = "mod";
    BinaryOperation["ADD"] = "add";
    BinaryOperation["SUB"] = "sub";
})(BinaryOperation || (BinaryOperation = {}));
export var UnaryOperation;
(function (UnaryOperation) {
    UnaryOperation["NOT"] = "not";
    UnaryOperation["NEG"] = "neg";
    UnaryOperation["IS_NULL"] = "null";
})(UnaryOperation || (UnaryOperation = {}));
export class ConvertVisitor {
    visitConst(expr) {
        return expr;
    }
    visitProp(expr) {
        return new Prop(expr.instance.accept(this), expr.name);
    }
    visitParam(expr) {
        return expr;
    }
    visitBinary(expr) {
        return new BinOp(expr.left.accept(this), expr.op, expr.right.accept(this));
    }
    visitUnary(expr) {
        return new UnOp(expr.op, expr.operand.accept(this));
    }
    visitCall(expr) {
        return new Call(expr.name, expr.args.map((e) => e.accept(this)));
    }
    visitLambda(expr) {
        return new Lambda(expr.body.accept(this), expr.param);
    }
}
const emptyContext = () => {
    const keys = [];
    const names = [];
    let next = 0;
    return {
        symbolToString(symbol) {
            const index = keys.indexOf(symbol);
            if (-1 !== index) {
                return names[index];
            }
            const name = `e${++next}`;
            keys.push(symbol);
            names.push(name);
            return name;
        }
    };
};
export class Expr {
}
export class Const extends Expr {
    constructor(value) {
        super();
        this.value = value;
    }
    accept(visitor) {
        return visitor.visitConst(this);
    }
    eq(other) {
        return other instanceof Const && other.value === this.value;
    }
    toString() {
        return JSON.stringify(this.value);
    }
}
export class Prop extends Expr {
    constructor(instance, name) {
        super();
        this.instance = instance;
        this.name = name;
    }
    accept(visitor) {
        return visitor.visitProp(this);
    }
    eq(other) {
        return other instanceof Prop && other.instance.eq(this.instance) && other.name === this.name;
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.instance.toString(ctx)}.${this.name}`;
    }
}
export class Param extends Expr {
    constructor(name) {
        super();
        this.name = name;
    }
    accept(visitor) {
        return visitor.visitParam(this);
    }
    eq(other) {
        return other instanceof Param && other.name === this.name;
    }
    toString(context) {
        // in protocol v1 param may be string...
        if ('string' === typeof this.name) {
            return this.name;
        }
        const ctx = context || emptyContext();
        return ctx.symbolToString(this.name);
    }
}
export class BinOp extends Expr {
    constructor(left, op, right) {
        super();
        this.left = left;
        this.op = op;
        this.right = right;
    }
    static unwind(head, tail) {
        if (!tail || !tail.length) {
            return head;
        }
        return tail.reduce((left, vals) => {
            const op = vals[1];
            const right = vals[3];
            return new BinOp(left, op, right);
        }, head);
    }
    accept(visitor) {
        return visitor.visitBinary(this);
    }
    eq(other) {
        return other instanceof BinOp && other.op === this.op && other.left.eq(this.left) && other.right.eq(this.right);
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `(${this.left.toString(ctx)} ${BinOp.binOpStrings[this.op]} ${this.right.toString(ctx)})`;
    }
}
BinOp.binOpStrings = {
    [BinaryOperation.EQ]: '=',
    [BinaryOperation.NEQ]: '!=',
    [BinaryOperation.GT]: '>',
    [BinaryOperation.LT]: '<',
    [BinaryOperation.LE]: '<=',
    [BinaryOperation.GE]: '>=',
    [BinaryOperation.OR]: '||',
    [BinaryOperation.AND]: '&&',
    [BinaryOperation.MUL]: '*',
    [BinaryOperation.DIV]: '/',
    [BinaryOperation.MOD]: '%',
    [BinaryOperation.ADD]: '+',
    [BinaryOperation.SUB]: '-'
};
export class UnOp extends Expr {
    constructor(op, operand) {
        super();
        this.op = op;
        this.operand = operand;
    }
    accept(visitor) {
        return visitor.visitUnary(this);
    }
    eq(other) {
        return other instanceof UnOp && other.op === this.op && other.operand.eq(this.operand);
    }
    toString(context) {
        const ctx = context || emptyContext();
        if (this.op === UnaryOperation.NOT) {
            return `!(${this.operand.toString(ctx)})`;
        }
        return `${UnOp.unOpStrings[this.op]}(${this.operand.toString(ctx)})`;
    }
}
UnOp.unOpStrings = {
    [UnaryOperation.NOT]: 'not',
    [UnaryOperation.NEG]: 'neg',
    [UnaryOperation.IS_NULL]: 'isNull'
};
export class Call extends Expr {
    constructor(name, args) {
        super();
        if (Call.knownFunctions[name]) {
            const argCount = Call.knownFunctions[name];
            if ('number' === typeof argCount) {
                if (argCount !== args.length) {
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument count: ${argCount}`);
                }
            }
            else {
                if (-1 === argCount.indexOf(args.length)) {
                    // tslint:disable-next-line:max-line-length
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument counts: ${argCount.join(',')}`);
                }
            }
        }
        this.name = name;
        this.args = args;
    }
    accept(visitor) {
        return visitor.visitCall(this);
    }
    eq(other) {
        if (!(other instanceof Call)) {
            return false;
        }
        if (other.name !== this.name) {
            return false;
        }
        if (other.args.length !== this.args.length) {
            return false;
        }
        for (let i = 0; i < other.args.length; i = i + 1) {
            if (!other.args[i].eq(this.args[i])) {
                return false;
            }
        }
        return true;
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.name}(${this.args.map((arg) => arg.toString(ctx)).join(',')})`;
    }
}
Call.knownFunctions = {
    contains: 2,
    substring: [2, 3]
};
export class Lambda extends Expr {
    constructor(body, param) {
        super();
        this.body = body;
        this.param = param;
    }
    accept(visitor) {
        return visitor.visitLambda(this);
    }
    eq(other) {
        if (!(other instanceof Lambda)) {
            return false;
        }
        throw new Error('Lambda equality is not implemented!');
    }
    toString(context) {
        const ctx = context || emptyContext();
        return `${this.param.toString(ctx)} => ${this.body.toString(ctx)}`;
    }
    substituteParameter(target) {
        return new Lambda(substituteParameter(this.param, target, this.body), target);
    }
    and(other) {
        if (this.param.eq(other.param)) {
            return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.body), this.param);
        }
        return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.substituteParameter(this.param).body), this.param);
    }
}
// export function parse (raw : string) : Expr {
//   return parser.parse(raw);
// }
export function substituteParameter(source, target, expression) {
    const visitor = new (class extends ConvertVisitor {
        visitParam(p) { return p.eq(source) ? target : p; }
    })();
    return expression.accept(visitor);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2FzdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxNQUFNLENBQU4sSUFBWSxlQWNYO0FBZEQsV0FBWSxlQUFlO0lBQ3pCLDRCQUFTLENBQUE7SUFDVCw4QkFBVyxDQUFBO0lBQ1gsNEJBQVMsQ0FBQTtJQUNULDRCQUFTLENBQUE7SUFDVCw0QkFBUyxDQUFBO0lBQ1QsNEJBQVMsQ0FBQTtJQUNULDRCQUFTLENBQUE7SUFDVCw4QkFBVyxDQUFBO0lBQ1gsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7SUFDWCw4QkFBVyxDQUFBO0lBQ1gsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7QUFDYixDQUFDLEVBZFcsZUFBZSxLQUFmLGVBQWUsUUFjMUI7QUFFRCxNQUFNLENBQU4sSUFBWSxjQUlYO0FBSkQsV0FBWSxjQUFjO0lBQ3hCLDZCQUFXLENBQUE7SUFDWCw2QkFBVyxDQUFBO0lBQ1gsa0NBQWdCLENBQUE7QUFDbEIsQ0FBQyxFQUpXLGNBQWMsS0FBZCxjQUFjLFFBSXpCO0FBWUQsTUFBTSxPQUFPLGNBQWM7SUFDekIsVUFBVSxDQUFDLElBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELFNBQVMsQ0FBQyxJQUFVO1FBQ2hCLE9BQU8sSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzNELENBQUM7SUFDRCxVQUFVLENBQUMsSUFBVztRQUNsQixPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsV0FBVyxDQUFDLElBQVc7UUFDbkIsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFD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QUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBRUQsR0FBRyxDQUFDLEtBQWE7UUFDZixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM5QixPQUFPLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3RGO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FDZixJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFDckYsSUFBSSxDQUFDLEtBQUssQ0FDWCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBRUQsZ0RBQWdEO0FBQ2hELDhCQUE4QjtBQUM5QixJQUFJO0FBRUosTUFBTSxVQUFVLG1CQUFtQixDQUFDLE1BQWEsRUFBRSxNQUFhLEVBQUUsVUFBZ0I7SUFDaEYsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLEtBQU0sU0FBUSxjQUFjO1FBQy9DLFVBQVUsQ0FBQyxDQUFRLElBQUksT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7S0FDM0QsQ0FBQyxFQUFFLENBQUM7SUFDTCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDcEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImV4cG9ydCBlbnVtIEJpbmFyeU9wZXJhdGlvbiB7XG4gIEVRID0gJ2VxJyxcbiAgTkVRID0gJ25lcScsXG4gIEdUID0gJ2d0JyxcbiAgTFQgPSAnbHQnLFxuICBHRSA9ICdnZScsXG4gIExFID0gJ2xlJyxcbiAgT1IgPSAnb3InLFxuICBBTkQgPSAnYW5kJyxcbiAgTVVMID0gJ211bCcsXG4gIERJViA9ICdkaXYnLFxuICBNT0QgPSAnbW9kJyxcbiAgQUREID0gJ2FkZCcsXG4gIFNVQiA9ICdzdWInXG59XG5cbmV4cG9ydCBlbnVtIFVuYXJ5T3BlcmF0aW9uIHtcbiAgTk9UID0gJ25vdCcsXG4gIE5FRyA9ICduZWcnLFxuICBJU19OVUxMID0gJ251bGwnXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgRXhwclZpc2l0b3I8VD4ge1xuICB2aXNpdENvbnN0KGV4cHI6IENvbnN0KTogVDtcbiAgdmlzaXRQcm9wKGV4cHI6IFByb3ApOiBUO1xuICB2aXNpdFBhcmFtKGV4cHI6IFBhcmFtKTogVDtcbiAgdmlzaXRCaW5hcnkoZXhwcjogQmluT3ApOiBUO1xuICB2aXNpdFVuYXJ5KGV4cHI6IFVuT3ApOiBUO1xuICB2aXNpdENhbGwoZXhwcjogQ2FsbCk6IFQ7XG4gIHZpc2l0TGFtYmRhKGV4cHI6IExhbWJkYSk6IFQ7XG59XG5cbmV4cG9ydCBjbGFzcyBDb252ZXJ0VmlzaXRvciBpbXBsZW1lbnRzIEV4cHJWaXNpdG9yPEV4cHI+IHtcbiAgdmlzaXRDb25zdChleHByOiBDb25zdCk6IEV4cHIge1xuICAgICAgcmV0dXJuIGV4cHI7XG4gIH1cbiAgdmlzaXRQcm9wKGV4cHI6IFByb3ApOiBFeHByIHtcbiAgICAgIHJldHVybiBuZXcgUHJvcChleHByLmluc3RhbmNlLmFjY2VwdCh0aGlzKSwgZXhwci5uYW1lKTtcbiAgfVxuICB2aXNpdFBhcmFtKGV4cHI6IFBhcmFtKTogRXhwciB7XG4gICAgICByZXR1cm4gZXhwcjtcbiAgfVxuICB2aXNpdEJpbmFyeShleHByOiBCaW5PcCk6IEV4cHIge1xuICAgICAgcmV0dXJuIG5ldyBCaW5PcChleHByLmxlZnQuYWNjZXB0KHRoaXMpLCBleHByLm9wLCBleHByLnJpZ2h0LmFjY2VwdCh0aGlzKSk7XG4gIH1cbiAgdmlzaXRVbmFyeShleHByOiBVbk9wKTogRXhwciB7XG4gICAgICByZXR1cm4gbmV3IFVuT3AoZXhwci5vcCwgZXhwci5vcGVyYW5kLmFjY2VwdCh0aGlzKSk7XG4gIH1cbiAgdmlzaXRDYWxsKGV4cHI6IENhbGwpOiBFeHByIHtcbiAgICAgIHJldHVybiBuZXcgQ2FsbChleHByLm5hbWUsIGV4cHIuYXJncy5tYXAoKGUpID0+IGUuYWNjZXB0KHRoaXMpKSk7XG4gIH1cbiAgdmlzaXRMYW1iZGEoZXhwcjogTGFtYmRhKTogRXhwciB7XG4gICAgICByZXR1cm4gbmV3IExhbWJkYShleHByLmJvZHkuYWNjZXB0KHRoaXMpLCBleHByLnBhcmFtKTtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFRvU3RyaW5nQ29udGV4dCB7XG4gIHN5bWJvbFRvU3RyaW5nKHN5bWJvbDogU3ltYm9sKTogc3RyaW5nO1xufVxuXG5jb25zdCBlbXB0eUNvbnRleHQgPSAoKTogVG9TdHJpbmdDb250ZXh0ID0+IHtcbiAgY29uc3Qga2V5czogU3ltYm9sW10gPSBbXTtcbiAgY29uc3QgbmFtZXM6IHN0cmluZ1tdID0gW107XG4gIGxldCBuZXh0ID0gMDtcbiAgcmV0dXJuIHtcbiAgICBzeW1ib2xUb1N0cmluZyhzeW1ib2w6IFN5bWJvbCkge1xuICAgICAgY29uc3QgaW5kZXggPSBrZXlzLmluZGV4T2Yoc3ltYm9sKTtcbiAgICAgIGlmICgtMSAhPT0gaW5kZXgpIHtcbiAgICAgICAgcmV0dXJuIG5hbWVzW2luZGV4XTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5hbWUgPSBgZSR7KytuZXh0fWA7XG4gICAgICBrZXlzLnB1c2goc3ltYm9sKTtcbiAgICAgIG5hbWVzLnB1c2gobmFtZSk7XG4gICAgICByZXR1cm4gbmFtZTtcbiAgICB9XG4gIH07XG59O1xuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXhwciB7XG4gIGFic3RyYWN0IGFjY2VwdDxUPih2aXNpdG9yOiBFeHByVmlzaXRvcjxUPik6IFQ7XG4gIGFic3RyYWN0IGVxKG90aGVyOiBFeHByKTogYm9vbGVhbjtcbiAgYWJzdHJhY3QgdG9TdHJpbmcoY29udGV4dD86IFRvU3RyaW5nQ29udGV4dCk6IHN0cmluZztcbn1cblxuZXhwb3J0IGNsYXNzIENvbnN0IGV4dGVuZHMgRXhwciB7XG4gIHJlYWRvbmx5IHZhbHVlOiBzdHJpbmd8bnVsbDtcblxuICBjb25zdHJ1Y3Rvcih2YWx1ZTogc3RyaW5nfG51bGwpIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICB0aGlzLnZhbHVlID0gdmFsdWU7XG4gIH1cblxuICBhY2NlcHQ8VD4odmlzaXRvcjogRXhwclZpc2l0b3I8VD4pIHtcbiAgICByZXR1cm4gdmlzaXRvci52aXNpdENvbnN0KHRoaXMpO1xuICB9XG5cbiAgZXEob3RoZXI6IEV4cHIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBDb25zdCAmJiBvdGhlci52YWx1ZSA9PT0gdGhpcy52YWx1ZTtcbiAgfVxuXG4gIHRvU3RyaW5nKCkge1xuICAgIHJldHVybiBKU09OLnN0cmluZ2lmeSh0aGlzLnZhbHVlKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgUHJvcCBleHRlbmRzIEV4cHIge1xuICByZWFkb25seSBpbnN0YW5jZTogRXhwcjtcbiAgcmVhZG9ubHkgbmFtZTogc3RyaW5nO1xuXG4gIGNvbnN0cnVjdG9yKGluc3RhbmNlOiBFeHByLCBuYW1lOiBzdHJpbmcpIHtcbiAgICAgIHN1cGVyKCk7XG4gICAgICB0aGlzLmluc3RhbmNlID0gaW5zdGFuY2U7XG4gICAgICB0aGlzLm5hbWUgPSBuYW1lO1xuICB9XG5cbiAgYWNjZXB0PFQ+KHZpc2l0b3I6IEV4cHJWaXNpdG9yPFQ+KSB7XG4gICAgcmV0dXJuIHZpc2l0b3IudmlzaXRQcm9wKHRoaXMpO1xuICB9XG5cbiAgZXEob3RoZXI6IEV4cHIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBQcm9wICYmIG90aGVyLmluc3RhbmNlLmVxKHRoaXMuaW5zdGFuY2UpICYmIG90aGVyLm5hbWUgPT09IHRoaXMubmFtZTtcbiAgfVxuXG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBgJHt0aGlzLmluc3RhbmNlLnRvU3RyaW5nKGN0eCl9LiR7dGhpcy5uYW1lfWA7XG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIFBhcmFtIGV4dGVuZHMgRXhwciB7XG4gIHJlYWRvbmx5IG5hbWU6IFN5bWJvbDtcbiAgY29uc3RydWN0b3IobmFtZTogU3ltYm9sKSB7XG4gICAgICBzdXBlcigpO1xuICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgfVxuICBhY2NlcHQ8VD4odmlzaXRvcjogRXhwclZpc2l0b3I8VD4pIHtcbiAgICByZXR1cm4gdmlzaXRvci52aXNpdFBhcmFtKHRoaXMpO1xuICB9XG5cbiAgZXEob3RoZXI6IEV4cHIpOiBib29sZWFuIHtcbiAgICByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBQYXJhbSAmJiBvdGhlci5uYW1lID09PSB0aGlzLm5hbWU7XG4gIH1cblxuICB0b1N0cmluZyhjb250ZXh0PzogVG9TdHJpbmdDb250ZXh0KSB7XG4gICAgLy8gaW4gcHJvdG9jb2wgdjEgcGFyYW0gbWF5IGJlIHN0cmluZy4uLlxuICAgIGlmICgnc3RyaW5nJyA9PT0gdHlwZW9mIHRoaXMubmFtZSkge1xuICAgICAgICByZXR1cm4gdGhpcy5uYW1lO1xuICAgIH1cbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBjdHguc3ltYm9sVG9TdHJpbmcodGhpcy5uYW1lKTtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgQmluT3AgZXh0ZW5kcyBFeHByIHtcbiAgcHJpdmF0ZSBzdGF0aWMgYmluT3BTdHJpbmdzID0ge1xuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5FUV06ICc9JyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uTkVRXTogJyE9JyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uR1RdOiAnPicsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLkxUXTogJzwnLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5MRV06ICc8PScsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLkdFXTogJz49JyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uT1JdOiAnfHwnLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5BTkRdOiAnJiYnLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5NVUxdOiAnKicsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLkRJVl06ICcvJyxcbiAgICAgIFtCaW5hcnlPcGVyYXRpb24uTU9EXTogJyUnLFxuICAgICAgW0JpbmFyeU9wZXJhdGlvbi5BRERdOiAnKycsXG4gICAgICBbQmluYXJ5T3BlcmF0aW9uLlNVQl06ICctJ1xuICB9O1xuXG4gIHN0YXRpYyB1bndpbmQoaGVhZDogRXhwciwgdGFpbDogQXJyYXk8W2FueSwgc3RyaW5nLCBhbnksIEV4cHJdPikge1xuICAgIGlmICghdGFpbCB8fCAhdGFpbC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBoZWFkO1xuICAgIH1cbiAgICByZXR1cm4gdGFpbC5yZWR1Y2UoKGxlZnQsIHZhbHMpID0+IHtcbiAgICAgIGNvbnN0IG9wID0gdmFsc1sxXTtcbiAgICAgIGNvbnN0IHJpZ2h0ID0gdmFsc1szXTtcbiAgICAgIHJldHVybiBuZXcgQmluT3AobGVmdCwgPEJpbmFyeU9wZXJhdGlvbj4gb3AsIHJpZ2h0KTtcbiAgICB9LCBoZWFkKTtcbiAgfVxuXG4gIHJlYWRvbmx5IGxlZnQ6IEV4cHI7XG4gIHJlYWRvbmx5IG9wOiBCaW5hcnlPcGVyYXRpb247XG4gIHJlYWRvbmx5IHJpZ2h0OiBFeHByO1xuXG4gIGNvbnN0cnVjdG9yKGxlZnQ6IEV4cHIsIG9wOiBCaW5hcnlPcGVyYXRpb24sIHJpZ2h0OiBFeHByKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmxlZnQgPSBsZWZ0O1xuICAgIHRoaXMub3AgPSBvcDtcbiAgICB0aGlzLnJpZ2h0ID0gcmlnaHQ7XG4gIH1cblxuICBhY2NlcHQ8VD4odmlzaXRvcjogRXhwclZpc2l0b3I8VD4pIHtcbiAgICByZXR1cm4gdmlzaXRvci52aXNpdEJpbmFyeSh0aGlzKTtcbiAgfVxuXG4gIGVxKG90aGVyOiBFeHByKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIG90aGVyIGluc3RhbmNlb2YgQmluT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIubGVmdC5lcSh0aGlzLmxlZnQpICYmIG90aGVyLnJpZ2h0LmVxKHRoaXMucmlnaHQpO1xuICB9XG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBgKCR7dGhpcy5sZWZ0LnRvU3RyaW5nKGN0eCl9ICR7QmluT3AuYmluT3BTdHJpbmdzW3RoaXMub3BdfSAke3RoaXMucmlnaHQudG9TdHJpbmcoY3R4KX0pYDtcbiAgfVxufVxuXG5leHBvcnQgY2xhc3MgVW5PcCBleHRlbmRzIEV4cHIge1xuICBwcml2YXRlIHN0YXRpYyB1bk9wU3RyaW5ncyA9IHtcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5OT1RdOiAnbm90JyxcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5ORUddOiAnbmVnJyxcbiAgICAgIFtVbmFyeU9wZXJhdGlvbi5JU19OVUxMXTogJ2lzTnVsbCdcbiAgfTtcblxuICBvcDogVW5hcnlPcGVyYXRpb247XG4gIG9wZXJhbmQ6IEV4cHI7XG5cbiAgY29uc3RydWN0b3Iob3A6IFVuYXJ5T3BlcmF0aW9uLCBvcGVyYW5kOiBFeHByKSB7XG4gICAgICBzdXBlcigpO1xuICAgICAgdGhpcy5vcCA9IG9wO1xuICAgICAgdGhpcy5vcGVyYW5kID0gb3BlcmFuZDtcbiAgfVxuXG4gIGFjY2VwdDxUPih2aXNpdG9yOiBFeHByVmlzaXRvcjxUPikge1xuICAgIHJldHVybiB2aXNpdG9yLnZpc2l0VW5hcnkodGhpcyk7XG4gIH1cblxuICBlcShvdGhlcjogRXhwcik6IGJvb2xlYW4ge1xuICAgIHJldHVybiBvdGhlciBpbnN0YW5jZW9mIFVuT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIub3BlcmFuZC5lcSh0aGlzLm9wZXJhbmQpO1xuICB9XG5cbiAgdG9TdHJpbmcoY29udGV4dD86IFRvU3RyaW5nQ29udGV4dCkge1xuICAgIGNvbnN0IGN0eCA9IGNvbnRleHQgfHwgZW1wdHlDb250ZXh0KCk7XG4gICAgaWYgKHRoaXMub3AgPT09IFVuYXJ5T3BlcmF0aW9uLk5PVCkge1xuICAgICAgcmV0dXJuIGAhKCR7dGhpcy5vcGVyYW5kLnRvU3RyaW5nKGN0eCl9KWA7XG4gICAgfVxuICAgIHJldHVybiBgJHtVbk9wLnVuT3BTdHJpbmdzW3RoaXMub3BdfSgke3RoaXMub3BlcmFuZC50b1N0cmluZyhjdHgpfSlgO1xuICB9XG59XG5cbmludGVyZmFjZSBLbm93bkZ1bmN0aW9uQ2FsbHMge1xuICBbbmFtZTogc3RyaW5nXTogbnVtYmVyW118bnVtYmVyO1xufVxuXG5leHBvcnQgY2xhc3MgQ2FsbCBleHRlbmRzIEV4cHIge1xuICBzdGF0aWMga25vd25GdW5jdGlvbnM6IEtub3duRnVuY3Rpb25DYWxscyA9IHtcbiAgICAgIGNvbnRhaW5zOiAyLFxuICAgICAgc3Vic3RyaW5nOiBbMiwgM11cbiAgfTtcblxuICByZWFkb25seSBuYW1lOiBzdHJpbmc7XG4gIHJlYWRvbmx5IGFyZ3M6IEV4cHJbXTtcblxuICBjb25zdHJ1Y3RvcihuYW1lOiBzdHJpbmcsIGFyZ3M6IEV4cHJbXSkge1xuICAgIHN1cGVyKCk7XG4gICAgaWYgKENhbGwua25vd25GdW5jdGlvbnNbbmFtZV0pIHtcbiAgICAgIGNvbnN0IGFyZ0NvdW50ID0gQ2FsbC5rbm93bkZ1bmN0aW9uc1tuYW1lXTtcbiAgICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIGFyZ0NvdW50KSB7XG4gICAgICAgIGlmIChhcmdDb3VudCAhPT0gYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgYXJndW1lbnQgY291bnQgZm9yICR7bmFtZX06ICR7YXJncy5sZW5ndGh9LCBhY2NlcHRlZCBhcmd1bWVudCBjb3VudDogJHthcmdDb3VudH1gKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgaWYgKC0xID09PSBhcmdDb3VudC5pbmRleE9mKGFyZ3MubGVuZ3RoKSkge1xuICAgICAgICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgYXJndW1lbnQgY291bnQgZm9yICR7bmFtZX06ICR7YXJncy5sZW5ndGh9LCBhY2NlcHRlZCBhcmd1bWVudCBjb3VudHM6ICR7YXJnQ291bnQuam9pbignLCcpfWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIHRoaXMubmFtZSA9IG5hbWU7XG4gICAgdGhpcy5hcmdzID0gYXJncztcbiAgfVxuXG4gIGFjY2VwdDxUPih2aXNpdG9yOiBFeHByVmlzaXRvcjxUPikge1xuICAgIHJldHVybiB2aXNpdG9yLnZpc2l0Q2FsbCh0aGlzKTtcbiAgfVxuXG4gIGVxKG90aGVyOiBFeHByKSB7XG4gICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIENhbGwpKSB7XG4gICAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgICAgaWYgKG90aGVyLm5hbWUgIT09IHRoaXMubmFtZSkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGlmIChvdGhlci5hcmdzLmxlbmd0aCAhPT0gdGhpcy5hcmdzLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgIH1cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgb3RoZXIuYXJncy5sZW5ndGg7IGkgPSBpICsgMSkge1xuICAgICAgICAgIGlmICghb3RoZXIuYXJnc1tpXS5lcSh0aGlzLmFyZ3NbaV0pKSB7XG4gICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICB9XG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIHRvU3RyaW5nKGNvbnRleHQ/OiBUb1N0cmluZ0NvbnRleHQpIHtcbiAgICBjb25zdCBjdHggPSBjb250ZXh0IHx8IGVtcHR5Q29udGV4dCgpO1xuICAgIHJldHVybiBgJHt0aGlzLm5hbWV9KCR7dGhpcy5hcmdzLm1hcCgoYXJnKSA9PiBhcmcudG9TdHJpbmcoY3R4KSkuam9pbignLCcpfSlgO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMYW1iZGEgZXh0ZW5kcyBFeHByIHtcbiAgcmVhZG9ubHkgYm9keTogRXhwcjtcbiAgcmVhZG9ubHkgcGFyYW06IFBhcmFtO1xuXG4gIGNvbnN0cnVjdG9yKGJvZHk6IEV4cHIsIHBhcmFtOiBQYXJhbSkge1xuICAgICAgc3VwZXIoKTtcbiAgICAgIHRoaXMuYm9keSA9IGJvZHk7XG4gICAgICB0aGlzLnBhcmFtID0gcGFyYW07XG4gIH1cblxuICBhY2NlcHQ8VD4odmlzaXRvcjogRXhwclZpc2l0b3I8VD4pIHtcbiAgICByZXR1cm4gdmlzaXRvci52aXNpdExhbWJkYSh0aGlzKTtcbiAgfVxuXG4gIGVxKG90aGVyOiBFeHByKSB7XG4gICAgICBpZiAoIShvdGhlciBpbnN0YW5jZW9mIExhbWJkYSkpIHtcbiAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0xhbWJkYSBlcXVhbGl0eSBpcyBub3QgaW1wbGVtZW50ZWQhJyk7XG4gIH1cblxuICB0b1N0cmluZyhjb250ZXh0PzogVG9TdHJpbmdDb250ZXh0KSB7XG4gICAgY29uc3QgY3R4ID0gY29udGV4dCB8fCBlbXB0eUNvbnRleHQoKTtcbiAgICByZXR1cm4gYCR7dGhpcy5wYXJhbS50b1N0cmluZyhjdHgpfSA9PiAke3RoaXMuYm9keS50b1N0cmluZyhjdHgpfWA7XG4gIH1cblxuICBzdWJzdGl0dXRlUGFyYW1ldGVyKHRhcmdldDogUGFyYW0pIHtcbiAgICAgIHJldHVybiBuZXcgTGFtYmRhKHN1YnN0aXR1dGVQYXJhbWV0ZXIodGhpcy5wYXJhbSwgdGFyZ2V0LCB0aGlzLmJvZHkpLCB0YXJnZXQpO1xuICB9XG5cbiAgYW5kKG90aGVyOiBMYW1iZGEpIHtcbiAgICBpZiAodGhpcy5wYXJhbS5lcShvdGhlci5wYXJhbSkpIHtcbiAgICAgIHJldHVybiBuZXcgTGFtYmRhKG5ldyBCaW5PcCh0aGlzLmJvZHksIEJpbmFyeU9wZXJhdGlvbi5BTkQsIG90aGVyLmJvZHkpLCB0aGlzLnBhcmFtKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBMYW1iZGEoXG4gICAgICBuZXcgQmluT3AodGhpcy5ib2R5LCBCaW5hcnlPcGVyYXRpb24uQU5ELCBvdGhlci5zdWJzdGl0dXRlUGFyYW1ldGVyKHRoaXMucGFyYW0pLmJvZHkpLFxuICAgICAgdGhpcy5wYXJhbVxuICAgICk7XG4gIH1cbn1cblxuLy8gZXhwb3J0IGZ1bmN0aW9uIHBhcnNlIChyYXcgOiBzdHJpbmcpIDogRXhwciB7XG4vLyAgIHJldHVybiBwYXJzZXIucGFyc2UocmF3KTtcbi8vIH1cblxuZXhwb3J0IGZ1bmN0aW9uIHN1YnN0aXR1dGVQYXJhbWV0ZXIoc291cmNlOiBQYXJhbSwgdGFyZ2V0OiBQYXJhbSwgZXhwcmVzc2lvbjogRXhwcikge1xuICBjb25zdCB2aXNpdG9yID0gbmV3IChjbGFzcyBleHRlbmRzIENvbnZlcnRWaXNpdG9yIHtcbiAgICB2aXNpdFBhcmFtKHA6IFBhcmFtKSB7IHJldHVybiBwLmVxKHNvdXJjZSkgPyB0YXJnZXQgOiBwOyB9XG4gIH0pKCk7XG4gIHJldHVybiBleHByZXNzaW9uLmFjY2VwdCh2aXNpdG9yKTtcbn1cbiJdfQ==
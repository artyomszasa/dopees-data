import { generate as generateParser } from 'pegjs/lib/peg';
const grammar = ['Lambda = source:Ident _ Arrow _ expr:Expr {return new dope.Q.Lambda(expr,new dope.Q.Param(source));}',
    'Ident = [a-zA-Z][a-zA-Z0-9]* {return text();}',
    'Arrow = "=>"',
    'Atom = Call/Var/NotExpr/Parens/NegExpr/IsNullExpr/CInt/CString',
    'ExprLvl0 = head:Atom tail:(_? op:(Mul/Div/Mod) _? expr:Atom)* { return dope.Q.BinExpr.unwind(head, tail); }',
    'ExprLvl1 = head:ExprLvl0 tail:(_? op:(Add/Sub) _? expr:ExprLvl0)* { return dope.Q.BinExpr.unwind(head, tail); }',
    'ExprLvl2 = head:ExprLvl1 tail:(_? op:(Eq/Neq/Gt/Lt/Ge/Le) _? expr:ExprLvl1)* { return dope.Q.BinExpr.unwind(head, tail); }',
    'ExprLvl3 = head:ExprLvl2 tail:(_? op:(And/Or) _? expr:ExprLvl2)* { return dope.Q.BinExpr.unwind(head, tail); }',
    // 'ExprPrefix = Var/NotExpr/Parens/NegExpr/IsNullExpr/Call/CInt/CString',
    // 'Expr = left:ExprPrefix opt:(_ Op _ Expr)? {return((left && opt && opt.length > 0)?new dope.Q.BinExpr(left,opt[1],opt[3]):left);}',
    'Expr = expr:ExprLvl3 { return expr; }',
    'Parens = "(" e:Expr ")" {return e;}',
    'NegExpr = "neg(" e:Expr ")" {return dope.Q.UnExpr(dope.Q.unOps.NEG,e);}',
    'IsNullExpr = "isNull(" e:Expr ")" {return dope.Q.UnExpr(dope.Q.unOps.IS_NULL,e);}',
    'Call = name0:[a-zA-Z]name:[a-zA-Z0-9]* "(" arg1:Expr args:(_? "," _? Expr)* ")" { return new dope.Q.Call([name0].concat(name).join(\'\'),[arg1].concat(args.map(arg => arg[3]))); }',
    'NotExpr = "!" arg:Expr {return new dope.Q.UnExpr(dope.Q.unOps.NOT,arg);}',
    'Var = x:(Ident ("." Ident)*) {var prop=new dope.Q.Param(x[0]);for(var index=0;index<x[1].length;index=index+1){prop=new dope.Q.Prop(prop,x[1][index][1]);}return prop;}',
    'Op = x:(Eq/Neq/Gt/Lt/Ge/Le/Or/And) {return x;}',
    'Or = "||" {return dope.Q.binOps.OR;}',
    'And = "&&" {return dope.Q.binOps.AND;}',
    'Eq = "=" {return dope.Q.binOps.EQ;}',
    'Neq = "!=" {return dope.Q.binOps.NEQ;}',
    'Gt = ">" {return dope.Q.binOps.GT;}',
    'Lt = "<" {return dope.Q.binOps.LT;}',
    'Ge = ">=" {return dope.Q.binOps.GE;}',
    'Le = "<=" {return dope.Q.binOps.LE;}',
    'Mul = "*" {return dope.Q.binOps.MUL;}',
    'Div = "/" {return dope.Q.binOps.DIV;}',
    'Mod = "<=" {return dope.Q.binOps.MOD;}',
    'Add = "+" {return dope.Q.binOps.ADD;}',
    'Sub = "-" {return dope.Q.binOps.SUB;}',
    'CInt = [0-9]+ {return new dope.Q.Const(text());}',
    'CString = "\\"" ([^"] / "\\\\" "\\"")* "\\"" {return new dope.Q.Const(JSON.parse(text()));}',
    '_ "whitespace"  = [ \\t\\n\\r]*'].join("\n");
const parser = generateParser(grammar);
export var BinaryOperation;
(function (BinaryOperation) {
    BinaryOperation["EQ"] = "eq";
    BinaryOperation["NEQ"] = "neq";
    BinaryOperation["GT"] = "gt";
    BinaryOperation["LT"] = "lt";
    BinaryOperation["GE"] = "ge";
    BinaryOperation["LE"] = "le";
    BinaryOperation["OR"] = "or";
    BinaryOperation["AND"] = "and";
    BinaryOperation["MUL"] = "mul";
    BinaryOperation["DIV"] = "div";
    BinaryOperation["MOD"] = "mod";
    BinaryOperation["ADD"] = "add";
    BinaryOperation["SUB"] = "sub";
})(BinaryOperation || (BinaryOperation = {}));
export var UnaryOperation;
(function (UnaryOperation) {
    UnaryOperation["NOT"] = "not";
    UnaryOperation["NEG"] = "neg";
    UnaryOperation["IS_NULL"] = "null";
})(UnaryOperation || (UnaryOperation = {}));
export class ConvertVisitor {
    visitConst(expr) {
        return expr;
    }
    visitProp(expr) {
        return new Prop(expr.instance.accept(this), expr.name);
    }
    visitParam(expr) {
        return expr;
    }
    visitBinary(expr) {
        return new BinOp(expr.left.accept(this), expr.op, expr.right.accept(this));
    }
    visitUnary(expr) {
        return new UnOp(expr.op, expr.operand.accept(this));
    }
    visitCall(expr) {
        return new Call(expr.name, expr.args.map(e => e.accept(this)));
    }
    visitLambda(expr) {
        return new Lambda(expr.body.accept(this), expr.param);
    }
}
export class Expr {
}
export class Const extends Expr {
    constructor(value) {
        super();
        this.value = value;
    }
    accept(visitor) { return visitor.visitConst(this); }
    eq(other) { return other instanceof Const && other.value === this.value; }
    toString() { return JSON.stringify(this.value); }
}
export class Prop extends Expr {
    constructor(instance, name) {
        super();
        this.instance = instance;
        this.name = name;
    }
    accept(visitor) { return visitor.visitProp(this); }
    eq(other) { return other instanceof Prop && other.instance.eq(this.instance) && other.name === this.name; }
    toString() { return `${this.instance.toString()}.${this.name}`; }
}
export class Param extends Expr {
    constructor(name) {
        super();
        this.name = name;
    }
    accept(visitor) { return visitor.visitParam(this); }
    eq(other) { return other instanceof Param && other.name === this.name; }
    toString() { return this.name.toString(); }
}
export class BinOp extends Expr {
    constructor(left, op, right) {
        super();
        this.left = left;
        this.op = op;
        this.right = right;
    }
    static unwind(head, tail) {
        if (!tail || !tail.length) {
            return head;
        }
        return tail.reduce((left, vals) => {
            const op = vals[1];
            const right = vals[3];
            return new BinOp(left, op, right);
        }, head);
    }
    accept(visitor) { return visitor.visitBinary(this); }
    eq(other) {
        return other instanceof BinOp && other.op === this.op && other.left.eq(this.left) && other.right.eq(this.right);
    }
    toString() {
        return `(${this.left.toString()} ${BinOp.binOpStrings[this.op]} ${this.right.toString()})`;
    }
}
BinOp.binOpStrings = {
    [BinaryOperation.EQ]: '=',
    [BinaryOperation.NEQ]: '!=',
    [BinaryOperation.GT]: '>',
    [BinaryOperation.LT]: '<',
    [BinaryOperation.LE]: '>=',
    [BinaryOperation.GE]: '<=',
    [BinaryOperation.OR]: '||',
    [BinaryOperation.AND]: '&&',
    [BinaryOperation.MUL]: '*',
    [BinaryOperation.DIV]: '/',
    [BinaryOperation.MOD]: '%',
    [BinaryOperation.ADD]: '+',
    [BinaryOperation.SUB]: '-'
};
export class UnOp extends Expr {
    constructor(op, operand) {
        super();
        this.op = op;
        this.operand = operand;
    }
    accept(visitor) { return visitor.visitUnary(this); }
    eq(other) {
        return other instanceof UnOp && other.op === this.op && other.operand.eq(this.operand);
    }
    toString() {
        if (this.op === UnaryOperation.NOT) {
            return `!(${this.operand})`;
        }
        return `${UnOp.unOpStrings[this.op]}(${this.operand})`;
    }
}
UnOp.unOpStrings = {
    [UnaryOperation.NOT]: 'not',
    [UnaryOperation.NEG]: 'neg',
    [UnaryOperation.IS_NULL]: 'isNull'
};
export class Call extends Expr {
    constructor(name, args) {
        super();
        if (Call.knownFunctions[name]) {
            const argCount = Call.knownFunctions[name];
            if ('number' === typeof argCount) {
                if (argCount !== args.length) {
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument count: ${argCount}`);
                }
            }
            else {
                if (-1 === argCount.indexOf(args.length)) {
                    throw new Error(`invalid argument count for ${name}: ${args.length}, accepted argument counts: ${argCount.join(',')}`);
                }
            }
        }
        this.name = name;
        this.args = args;
    }
    accept(visitor) { return visitor.visitCall(this); }
    eq(other) {
        if (!(other instanceof Call)) {
            return false;
        }
        if (other.name !== this.name) {
            return false;
        }
        if (other.args.length !== this.args.length) {
            return false;
        }
        for (let i = 0; i < other.args.length; i = i + 1) {
            if (!other.args[i].eq(this.args[i])) {
                return false;
            }
        }
        return true;
    }
    toString() {
        return `${this.name}(${this.args.map(arg => arg.toString()).join(',')})`;
    }
}
Call.knownFunctions = {
    contains: 2,
    substring: [2, 3]
};
export class Lambda extends Expr {
    constructor(body, param) {
        super();
        this.body = body;
        this.param = param;
    }
    accept(visitor) { return visitor.visitLambda(this); }
    eq(other) {
        if (!(other instanceof Lambda)) {
            return false;
        }
        throw new Error('Lambda equality is not implemented!');
    }
    toString() { return `${this.param} => ${this.body}`; }
    substituteParameter(target) {
        return new Lambda(substituteParameter(this.param, target, this.body), target);
    }
    and(other) {
        if (this.param.eq(other.param)) {
            return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.body), this.param);
        }
        return new Lambda(new BinOp(this.body, BinaryOperation.AND, other.substituteParameter(this.param).body), this.param);
    }
}
export function parse(raw) {
    return parser.parse(raw);
}
export function substituteParameter(source, target, expression) {
    const visitor = new class extends ConvertVisitor {
        visitParam(p) { return p.eq(source) ? target : p; }
    };
    return expression.accept(visitor);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvdG9jb2wuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvcHJvdG9jb2wudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFFBQVEsSUFBSSxjQUFjLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFM0QsTUFBTSxPQUFPLEdBQ1QsQ0FBRSxzR0FBc0c7SUFDcEcsK0NBQStDO0lBQy9DLGNBQWM7SUFFZCxnRUFBZ0U7SUFFaEUsNkdBQTZHO0lBQzdHLGlIQUFpSDtJQUNqSCw0SEFBNEg7SUFDNUgsZ0hBQWdIO0lBRWhILDBFQUEwRTtJQUMxRSxzSUFBc0k7SUFDdEksdUNBQXVDO0lBQ3ZDLHFDQUFxQztJQUNyQyx5RUFBeUU7SUFDekUsbUZBQW1GO0lBQ25GLHFMQUFxTDtJQUNyTCwwRUFBMEU7SUFDMUUseUtBQXlLO0lBQ3pLLGdEQUFnRDtJQUNoRCxzQ0FBc0M7SUFDdEMsd0NBQXdDO0lBQ3hDLHFDQUFxQztJQUNyQyx3Q0FBd0M7SUFDeEMscUNBQXFDO0lBQ3JDLHFDQUFxQztJQUNyQyxzQ0FBc0M7SUFDdEMsc0NBQXNDO0lBQ3RDLHVDQUF1QztJQUN2Qyx1Q0FBdUM7SUFDdkMsd0NBQXdDO0lBQ3hDLHVDQUF1QztJQUN2Qyx1Q0FBdUM7SUFDdkMsa0RBQWtEO0lBQ2xELDZGQUE2RjtJQUM3RixpQ0FBaUMsQ0FBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUV2RCxNQUFNLE1BQU0sR0FBRyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUM7QUFFdkMsTUFBTSxDQUFOLElBQVksZUFjWDtBQWRELFdBQVksZUFBZTtJQUN2Qiw0QkFBUyxDQUFBO0lBQ1QsOEJBQVcsQ0FBQTtJQUNYLDRCQUFTLENBQUE7SUFDVCw0QkFBUyxDQUFBO0lBQ1QsNEJBQVMsQ0FBQTtJQUNULDRCQUFTLENBQUE7SUFDVCw0QkFBUyxDQUFBO0lBQ1QsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7SUFDWCw4QkFBVyxDQUFBO0lBQ1gsOEJBQVcsQ0FBQTtJQUNYLDhCQUFXLENBQUE7SUFDWCw4QkFBVyxDQUFBO0FBQ2YsQ0FBQyxFQWRXLGVBQWUsS0FBZixlQUFlLFFBYzFCO0FBRUQsTUFBTSxDQUFOLElBQVksY0FJWDtBQUpELFdBQVksY0FBYztJQUN0Qiw2QkFBVyxDQUFBO0lBQ1gsNkJBQVcsQ0FBQTtJQUNYLGtDQUFnQixDQUFBO0FBQ3BCLENBQUMsRUFKVyxjQUFjLEtBQWQsY0FBYyxRQUl6QjtBQVlELE1BQU0sT0FBTyxjQUFjO0lBQ3ZCLFVBQVUsQ0FBQyxJQUFXO1FBQ2xCLE9BQU8sSUFBSSxDQUFDO0lBQ2hCLENBQUM7SUFDRCxTQUFTLENBQUMsSUFBVTtRQUNoQixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBQ0QsVUFBVSxDQUFDLElBQVc7UUFDbEIsT0FBTyxJQUFJLENBQUM7SUFDaEIsQ0FBQztJQUNELFdBQVcsQ0FBQyxJQUFXO1FBQ25CLE9BQU8sSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQy9FLENBQUM7SUFDRCxVQUFVLENBQUMsSUFBVTtRQUNqQixPQUFPLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUN4RCxDQUFDO0lBQ0QsU0FBUyxDQUFDLElBQVU7UUFDaEIsT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDbkUsQ0FBQztJQUNELFdBQVcsQ0FBQyxJQUFZO1FBQ3BCLE9BQU8sSUFBSSxNQUFNLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQzFELENBQUM7Q0FDSjtBQUVELE1BQU0sT0FBZ0IsSUFBSTtDQUl6QjtBQUVELE1BQU0sT0FBTyxLQUFNLFNBQVEsSUFBSTtJQUUzQixZQUFZLEtBQW1CO1FBQzNCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztJQUNELE1BQU0sQ0FBSSxPQUF3QixJQUFJLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsRUFBRSxDQUFDLEtBQVksSUFBYyxPQUFPLEtBQUssWUFBWSxLQUFLLElBQUksS0FBSyxDQUFDLEtBQUssS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQztJQUMzRixRQUFRLEtBQUssT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDcEQ7QUFFRCxNQUFNLE9BQU8sSUFBSyxTQUFRLElBQUk7SUFHMUIsWUFBWSxRQUFlLEVBQUUsSUFBYTtRQUN0QyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxRQUFRLEdBQUcsUUFBUSxDQUFDO1FBQ3pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxNQUFNLENBQUksT0FBd0IsSUFBSSxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3ZFLEVBQUUsQ0FBQyxLQUFZLElBQWMsT0FBTyxLQUFLLFlBQVksSUFBSSxJQUFJLEtBQUssQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDO0lBQzVILFFBQVEsS0FBSyxPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDO0NBQ3BFO0FBRUQsTUFBTSxPQUFPLEtBQU0sU0FBUSxJQUFJO0lBRTNCLFlBQVksSUFBYTtRQUNyQixLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxNQUFNLENBQUksT0FBd0IsSUFBSSxPQUFPLE9BQU8sQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3hFLEVBQUUsQ0FBQyxLQUFZLElBQWMsT0FBTyxLQUFLLFlBQVksS0FBSyxJQUFJLEtBQUssQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDekYsUUFBUSxLQUFLLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsQ0FBQyxDQUFDLENBQUM7Q0FDOUM7QUFFRCxNQUFNLE9BQU8sS0FBTSxTQUFRLElBQUk7SUE2QjNCLFlBQWEsSUFBVyxFQUFFLEVBQW9CLEVBQUUsS0FBWTtRQUN4RCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7SUFDdkIsQ0FBQztJQWxCRCxNQUFNLENBQUMsTUFBTSxDQUFFLElBQVcsRUFBRSxJQUF3QjtRQUNoRCxJQUFJLENBQUMsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRTtZQUN2QixPQUFPLElBQUksQ0FBQztTQUNmO1FBQ0QsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsSUFBSSxFQUFFLElBQUksRUFBRSxFQUFFO1lBQzlCLE1BQU0sRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNuQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDdEIsT0FBTyxJQUFJLEtBQUssQ0FBQyxJQUFJLEVBQUUsRUFBRSxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQ3RDLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztJQUNiLENBQUM7SUFVRCxNQUFNLENBQUksT0FBd0IsSUFBSSxPQUFPLE9BQU8sQ0FBQyxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3pFLEVBQUUsQ0FBQyxLQUFZO1FBQ1gsT0FBTyxLQUFLLFlBQVksS0FBSyxJQUFJLEtBQUssQ0FBQyxFQUFFLEtBQUssSUFBSSxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO0lBQ3BILENBQUM7SUFDRCxRQUFRO1FBQ0osT0FBTyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDO0lBQy9GLENBQUM7O0FBeENjLGtCQUFZLEdBQUc7SUFDMUIsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRztJQUN6QixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJO0lBQzNCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUc7SUFDekIsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRztJQUN6QixDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUMsRUFBRSxJQUFJO0lBQzFCLENBQUMsZUFBZSxDQUFDLEVBQUUsQ0FBQyxFQUFFLElBQUk7SUFDMUIsQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDLEVBQUUsSUFBSTtJQUMxQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxJQUFJO0lBQzNCLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUc7SUFDMUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRztJQUMxQixDQUFDLGVBQWUsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHO0lBQzFCLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUc7SUFDMUIsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLEVBQUUsR0FBRztDQUM3QixDQUFBO0FBNkJMLE1BQU0sT0FBTyxJQUFLLFNBQVEsSUFBSTtJQVExQixZQUFZLEVBQW1CLEVBQUUsT0FBYTtRQUMxQyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLE9BQU8sR0FBRyxPQUFPLENBQUM7SUFDM0IsQ0FBQztJQUNELE1BQU0sQ0FBSSxPQUF3QixJQUFJLE9BQU8sT0FBTyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDeEUsRUFBRSxDQUFDLEtBQVk7UUFDWCxPQUFPLEtBQUssWUFBWSxJQUFJLElBQUksS0FBSyxDQUFDLEVBQUUsS0FBSyxJQUFJLENBQUMsRUFBRSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUMzRixDQUFDO0lBQ0QsUUFBUTtRQUNKLElBQUksSUFBSSxDQUFDLEVBQUUsS0FBSyxjQUFjLENBQUMsR0FBRyxFQUFFO1lBQ2hDLE9BQU8sS0FBSyxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUM7U0FDL0I7UUFDRCxPQUFPLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sR0FBRyxDQUFDO0lBQzNELENBQUM7O0FBckJjLGdCQUFXLEdBQUc7SUFDekIsQ0FBQyxjQUFjLENBQUMsR0FBRyxDQUFDLEVBQUUsS0FBSztJQUMzQixDQUFDLGNBQWMsQ0FBQyxHQUFHLENBQUMsRUFBRSxLQUFLO0lBQzNCLENBQUMsY0FBYyxDQUFDLE9BQU8sQ0FBQyxFQUFFLFFBQVE7Q0FDckMsQ0FBQTtBQXdCTCxNQUFNLE9BQU8sSUFBSyxTQUFRLElBQUk7SUFPMUIsWUFBWSxJQUFZLEVBQUUsSUFBa0I7UUFDeEMsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLEVBQUU7WUFDM0IsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMzQyxJQUFJLFFBQVEsS0FBSyxPQUFPLFFBQVEsRUFBRTtnQkFDOUIsSUFBSSxRQUFRLEtBQUssSUFBSSxDQUFDLE1BQU0sRUFBRTtvQkFDMUIsTUFBTSxJQUFJLEtBQUssQ0FBQyw4QkFBOEIsSUFBSSxLQUFLLElBQUksQ0FBQyxNQUFNLDhCQUE4QixRQUFRLEVBQUUsQ0FBQyxDQUFDO2lCQUMvRzthQUNKO2lCQUFNO2dCQUNILElBQUksQ0FBQyxDQUFDLEtBQUssUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLEVBQUU7b0JBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsOEJBQThCLElBQUksS0FBSyxJQUFJLENBQUMsTUFBTSwrQkFBK0IsUUFBUSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLENBQUM7aUJBQzFIO2FBQ0o7U0FDSjtRQUNELElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO0lBQ3JCLENBQUM7SUFDRCxNQUFNLENBQUksT0FBdUIsSUFBSSxPQUFPLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ3RFLEVBQUUsQ0FBQyxLQUFXO1FBQ1YsSUFBSSxDQUFDLENBQUMsS0FBSyxZQUFZLElBQUksQ0FBQyxFQUFFO1lBQzFCLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsSUFBSSxLQUFLLENBQUMsSUFBSSxLQUFLLElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDMUIsT0FBTyxLQUFLLENBQUM7U0FDaEI7UUFDRCxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxLQUFLLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO1lBQ3hDLE9BQU8sS0FBSyxDQUFDO1NBQ2hCO1FBQ0QsS0FBSyxJQUFJLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFO1lBQzlDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUU7Z0JBQ2pDLE9BQU8sS0FBSyxDQUFDO2FBQ2hCO1NBQ0o7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNoQixDQUFDO0lBQ0QsUUFBUTtRQUNKLE9BQU8sR0FBRyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUM7SUFDN0UsQ0FBQzs7QUEzQ00sbUJBQWMsR0FBdUI7SUFDeEMsUUFBUSxFQUFFLENBQUM7SUFDWCxTQUFTLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0NBQ3BCLENBQUE7QUEyQ0wsTUFBTSxPQUFPLE1BQU8sU0FBUSxJQUFJO0lBRzVCLFlBQVksSUFBVSxFQUFFLEtBQVk7UUFDaEMsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNqQixJQUFJLENBQUMsS0FBSyxHQUFHLEtBQUssQ0FBQztJQUN2QixDQUFDO0lBQ0QsTUFBTSxDQUFJLE9BQXVCLElBQUksT0FBTyxPQUFPLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUN4RSxFQUFFLENBQUMsS0FBVztRQUNWLElBQUksQ0FBQyxDQUFDLEtBQUssWUFBWSxNQUFNLENBQUMsRUFBRTtZQUM1QixPQUFPLEtBQUssQ0FBQztTQUNoQjtRQUNELE1BQU0sSUFBSSxLQUFLLENBQUMscUNBQXFDLENBQUMsQ0FBQztJQUMzRCxDQUFDO0lBQ0QsUUFBUSxLQUFLLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxPQUFPLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDdEQsbUJBQW1CLENBQUMsTUFBYTtRQUM3QixPQUFPLElBQUksTUFBTSxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUNsRixDQUFDO0lBQ0QsR0FBRyxDQUFDLEtBQWE7UUFDYixJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUM1QixPQUFPLElBQUksTUFBTSxDQUFDLElBQUksS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLEVBQUUsZUFBZSxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsSUFBSSxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ3hGO1FBQ0QsT0FBTyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxFQUFFLGVBQWUsQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDekgsQ0FBQztDQUNKO0FBRUQsTUFBTSxVQUFVLEtBQUssQ0FBRSxHQUFZO0lBQy9CLE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztBQUM3QixDQUFDO0FBRUQsTUFBTSxVQUFVLG1CQUFtQixDQUFFLE1BQWEsRUFBRSxNQUFhLEVBQUUsVUFBZ0I7SUFDL0UsTUFBTSxPQUFPLEdBQUcsSUFBSSxLQUFNLFNBQVEsY0FBYztRQUM1QyxVQUFVLENBQUMsQ0FBUSxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0tBQzdELENBQUE7SUFDRCxPQUFPLFVBQVUsQ0FBQyxNQUFNLENBQUMsT0FBTyxDQUFDLENBQUM7QUFDdEMsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGdlbmVyYXRlIGFzIGdlbmVyYXRlUGFyc2VyIH0gZnJvbSAncGVnanMvbGliL3BlZyc7XG5cbmNvbnN0IGdyYW1tYXIgPVxuICAgIFsgJ0xhbWJkYSA9IHNvdXJjZTpJZGVudCBfIEFycm93IF8gZXhwcjpFeHByIHtyZXR1cm4gbmV3IGRvcGUuUS5MYW1iZGEoZXhwcixuZXcgZG9wZS5RLlBhcmFtKHNvdXJjZSkpO30nLFxuICAgICAgICAnSWRlbnQgPSBbYS16QS1aXVthLXpBLVowLTldKiB7cmV0dXJuIHRleHQoKTt9JyxcbiAgICAgICAgJ0Fycm93ID0gXCI9PlwiJyxcblxuICAgICAgICAnQXRvbSA9IENhbGwvVmFyL05vdEV4cHIvUGFyZW5zL05lZ0V4cHIvSXNOdWxsRXhwci9DSW50L0NTdHJpbmcnLFxuXG4gICAgICAgICdFeHByTHZsMCA9IGhlYWQ6QXRvbSB0YWlsOihfPyBvcDooTXVsL0Rpdi9Nb2QpIF8/IGV4cHI6QXRvbSkqIHsgcmV0dXJuIGRvcGUuUS5CaW5FeHByLnVud2luZChoZWFkLCB0YWlsKTsgfScsXG4gICAgICAgICdFeHByTHZsMSA9IGhlYWQ6RXhwckx2bDAgdGFpbDooXz8gb3A6KEFkZC9TdWIpIF8/IGV4cHI6RXhwckx2bDApKiB7IHJldHVybiBkb3BlLlEuQmluRXhwci51bndpbmQoaGVhZCwgdGFpbCk7IH0nLFxuICAgICAgICAnRXhwckx2bDIgPSBoZWFkOkV4cHJMdmwxIHRhaWw6KF8/IG9wOihFcS9OZXEvR3QvTHQvR2UvTGUpIF8/IGV4cHI6RXhwckx2bDEpKiB7IHJldHVybiBkb3BlLlEuQmluRXhwci51bndpbmQoaGVhZCwgdGFpbCk7IH0nLFxuICAgICAgICAnRXhwckx2bDMgPSBoZWFkOkV4cHJMdmwyIHRhaWw6KF8/IG9wOihBbmQvT3IpIF8/IGV4cHI6RXhwckx2bDIpKiB7IHJldHVybiBkb3BlLlEuQmluRXhwci51bndpbmQoaGVhZCwgdGFpbCk7IH0nLFxuXG4gICAgICAgIC8vICdFeHByUHJlZml4ID0gVmFyL05vdEV4cHIvUGFyZW5zL05lZ0V4cHIvSXNOdWxsRXhwci9DYWxsL0NJbnQvQ1N0cmluZycsXG4gICAgICAgIC8vICdFeHByID0gbGVmdDpFeHByUHJlZml4IG9wdDooXyBPcCBfIEV4cHIpPyB7cmV0dXJuKChsZWZ0ICYmIG9wdCAmJiBvcHQubGVuZ3RoID4gMCk/bmV3IGRvcGUuUS5CaW5FeHByKGxlZnQsb3B0WzFdLG9wdFszXSk6bGVmdCk7fScsXG4gICAgICAgICdFeHByID0gZXhwcjpFeHByTHZsMyB7IHJldHVybiBleHByOyB9JyxcbiAgICAgICAgJ1BhcmVucyA9IFwiKFwiIGU6RXhwciBcIilcIiB7cmV0dXJuIGU7fScsXG4gICAgICAgICdOZWdFeHByID0gXCJuZWcoXCIgZTpFeHByIFwiKVwiIHtyZXR1cm4gZG9wZS5RLlVuRXhwcihkb3BlLlEudW5PcHMuTkVHLGUpO30nLFxuICAgICAgICAnSXNOdWxsRXhwciA9IFwiaXNOdWxsKFwiIGU6RXhwciBcIilcIiB7cmV0dXJuIGRvcGUuUS5VbkV4cHIoZG9wZS5RLnVuT3BzLklTX05VTEwsZSk7fScsXG4gICAgICAgICdDYWxsID0gbmFtZTA6W2EtekEtWl1uYW1lOlthLXpBLVowLTldKiBcIihcIiBhcmcxOkV4cHIgYXJnczooXz8gXCIsXCIgXz8gRXhwcikqIFwiKVwiIHsgcmV0dXJuIG5ldyBkb3BlLlEuQ2FsbChbbmFtZTBdLmNvbmNhdChuYW1lKS5qb2luKFxcJ1xcJyksW2FyZzFdLmNvbmNhdChhcmdzLm1hcChhcmcgPT4gYXJnWzNdKSkpOyB9JyxcbiAgICAgICAgJ05vdEV4cHIgPSBcIiFcIiBhcmc6RXhwciB7cmV0dXJuIG5ldyBkb3BlLlEuVW5FeHByKGRvcGUuUS51bk9wcy5OT1QsYXJnKTt9JyxcbiAgICAgICAgJ1ZhciA9IHg6KElkZW50IChcIi5cIiBJZGVudCkqKSB7dmFyIHByb3A9bmV3IGRvcGUuUS5QYXJhbSh4WzBdKTtmb3IodmFyIGluZGV4PTA7aW5kZXg8eFsxXS5sZW5ndGg7aW5kZXg9aW5kZXgrMSl7cHJvcD1uZXcgZG9wZS5RLlByb3AocHJvcCx4WzFdW2luZGV4XVsxXSk7fXJldHVybiBwcm9wO30nLFxuICAgICAgICAnT3AgPSB4OihFcS9OZXEvR3QvTHQvR2UvTGUvT3IvQW5kKSB7cmV0dXJuIHg7fScsXG4gICAgICAgICdPciA9IFwifHxcIiB7cmV0dXJuIGRvcGUuUS5iaW5PcHMuT1I7fScsXG4gICAgICAgICdBbmQgPSBcIiYmXCIge3JldHVybiBkb3BlLlEuYmluT3BzLkFORDt9JyxcbiAgICAgICAgJ0VxID0gXCI9XCIge3JldHVybiBkb3BlLlEuYmluT3BzLkVRO30nLFxuICAgICAgICAnTmVxID0gXCIhPVwiIHtyZXR1cm4gZG9wZS5RLmJpbk9wcy5ORVE7fScsXG4gICAgICAgICdHdCA9IFwiPlwiIHtyZXR1cm4gZG9wZS5RLmJpbk9wcy5HVDt9JyxcbiAgICAgICAgJ0x0ID0gXCI8XCIge3JldHVybiBkb3BlLlEuYmluT3BzLkxUO30nLFxuICAgICAgICAnR2UgPSBcIj49XCIge3JldHVybiBkb3BlLlEuYmluT3BzLkdFO30nLFxuICAgICAgICAnTGUgPSBcIjw9XCIge3JldHVybiBkb3BlLlEuYmluT3BzLkxFO30nLFxuICAgICAgICAnTXVsID0gXCIqXCIge3JldHVybiBkb3BlLlEuYmluT3BzLk1VTDt9JyxcbiAgICAgICAgJ0RpdiA9IFwiL1wiIHtyZXR1cm4gZG9wZS5RLmJpbk9wcy5ESVY7fScsXG4gICAgICAgICdNb2QgPSBcIjw9XCIge3JldHVybiBkb3BlLlEuYmluT3BzLk1PRDt9JyxcbiAgICAgICAgJ0FkZCA9IFwiK1wiIHtyZXR1cm4gZG9wZS5RLmJpbk9wcy5BREQ7fScsXG4gICAgICAgICdTdWIgPSBcIi1cIiB7cmV0dXJuIGRvcGUuUS5iaW5PcHMuU1VCO30nLFxuICAgICAgICAnQ0ludCA9IFswLTldKyB7cmV0dXJuIG5ldyBkb3BlLlEuQ29uc3QodGV4dCgpKTt9JyxcbiAgICAgICAgJ0NTdHJpbmcgPSBcIlxcXFxcIlwiIChbXlwiXSAvIFwiXFxcXFxcXFxcIiBcIlxcXFxcIlwiKSogXCJcXFxcXCJcIiB7cmV0dXJuIG5ldyBkb3BlLlEuQ29uc3QoSlNPTi5wYXJzZSh0ZXh0KCkpKTt9JyxcbiAgICAgICAgJ18gXCJ3aGl0ZXNwYWNlXCIgID0gWyBcXFxcdFxcXFxuXFxcXHJdKicgXS5qb2luKFwiXFxuXCIpO1xuXG5jb25zdCBwYXJzZXIgPSBnZW5lcmF0ZVBhcnNlcihncmFtbWFyKTtcblxuZXhwb3J0IGVudW0gQmluYXJ5T3BlcmF0aW9uIHtcbiAgICBFUSA9ICdlcScsXG4gICAgTkVRID0gJ25lcScsXG4gICAgR1QgPSAnZ3QnLFxuICAgIExUID0gJ2x0JyxcbiAgICBHRSA9ICdnZScsXG4gICAgTEUgPSAnbGUnLFxuICAgIE9SID0gJ29yJyxcbiAgICBBTkQgPSAnYW5kJyxcbiAgICBNVUwgPSAnbXVsJyxcbiAgICBESVYgPSAnZGl2JyxcbiAgICBNT0QgPSAnbW9kJyxcbiAgICBBREQgPSAnYWRkJyxcbiAgICBTVUIgPSAnc3ViJ1xufVxuXG5leHBvcnQgZW51bSBVbmFyeU9wZXJhdGlvbiB7XG4gICAgTk9UID0gJ25vdCcsXG4gICAgTkVHID0gJ25lZycsXG4gICAgSVNfTlVMTCA9ICdudWxsJ1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEV4cHJWaXNpdG9yPFQ+IHtcbiAgICB2aXNpdENvbnN0KGV4cHI6IENvbnN0KTogVFxuICAgIHZpc2l0UHJvcChleHByOiBQcm9wKSA6IFRcbiAgICB2aXNpdFBhcmFtKGV4cHI6IFBhcmFtKSA6IFRcbiAgICB2aXNpdEJpbmFyeShleHByOiBCaW5PcCkgOiBUXG4gICAgdmlzaXRVbmFyeShleHByOiBVbk9wKSA6IFRcbiAgICB2aXNpdENhbGwoZXhwcjogQ2FsbCkgOiBUXG4gICAgdmlzaXRMYW1iZGEoZXhwcjogTGFtYmRhKSA6IFRcbn1cblxuZXhwb3J0IGNsYXNzIENvbnZlcnRWaXNpdG9yIGltcGxlbWVudHMgRXhwclZpc2l0b3I8RXhwcj4ge1xuICAgIHZpc2l0Q29uc3QoZXhwcjogQ29uc3QpOiBFeHByIHtcbiAgICAgICAgcmV0dXJuIGV4cHI7XG4gICAgfVxuICAgIHZpc2l0UHJvcChleHByOiBQcm9wKTogRXhwciB7XG4gICAgICAgIHJldHVybiBuZXcgUHJvcChleHByLmluc3RhbmNlLmFjY2VwdCh0aGlzKSwgZXhwci5uYW1lKTtcbiAgICB9XG4gICAgdmlzaXRQYXJhbShleHByOiBQYXJhbSk6IEV4cHIge1xuICAgICAgICByZXR1cm4gZXhwcjtcbiAgICB9XG4gICAgdmlzaXRCaW5hcnkoZXhwcjogQmluT3ApOiBFeHByIHtcbiAgICAgICAgcmV0dXJuIG5ldyBCaW5PcChleHByLmxlZnQuYWNjZXB0KHRoaXMpLCBleHByLm9wLCBleHByLnJpZ2h0LmFjY2VwdCh0aGlzKSk7XG4gICAgfVxuICAgIHZpc2l0VW5hcnkoZXhwcjogVW5PcCk6IEV4cHIge1xuICAgICAgICByZXR1cm4gbmV3IFVuT3AoZXhwci5vcCwgZXhwci5vcGVyYW5kLmFjY2VwdCh0aGlzKSk7XG4gICAgfVxuICAgIHZpc2l0Q2FsbChleHByOiBDYWxsKTogRXhwciB7XG4gICAgICAgIHJldHVybiBuZXcgQ2FsbChleHByLm5hbWUsIGV4cHIuYXJncy5tYXAoZSA9PiBlLmFjY2VwdCh0aGlzKSkpO1xuICAgIH1cbiAgICB2aXNpdExhbWJkYShleHByOiBMYW1iZGEpOiBFeHByIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMYW1iZGEoZXhwci5ib2R5LmFjY2VwdCh0aGlzKSwgZXhwci5wYXJhbSk7XG4gICAgfVxufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgRXhwciB7XG4gICAgYWJzdHJhY3QgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgOiBUXG4gICAgYWJzdHJhY3QgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW5cbiAgICBhYnN0cmFjdCB0b1N0cmluZygpIDogc3RyaW5nXG59XG5cbmV4cG9ydCBjbGFzcyBDb25zdCBleHRlbmRzIEV4cHIge1xuICAgIHZhbHVlIDogc3RyaW5nfG51bGxcbiAgICBjb25zdHJ1Y3Rvcih2YWx1ZSA6IHN0cmluZ3xudWxsKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMudmFsdWUgPSB2YWx1ZTtcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdENvbnN0KHRoaXMpOyB9XG4gICAgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW4geyByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBDb25zdCAmJiBvdGhlci52YWx1ZSA9PT0gdGhpcy52YWx1ZTsgfVxuICAgIHRvU3RyaW5nKCkgeyByZXR1cm4gSlNPTi5zdHJpbmdpZnkodGhpcy52YWx1ZSk7IH1cbn1cblxuZXhwb3J0IGNsYXNzIFByb3AgZXh0ZW5kcyBFeHByIHtcbiAgICBpbnN0YW5jZSA6IEV4cHJcbiAgICBuYW1lIDogc3RyaW5nXG4gICAgY29uc3RydWN0b3IoaW5zdGFuY2UgOiBFeHByLCBuYW1lIDogc3RyaW5nKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuaW5zdGFuY2UgPSBpbnN0YW5jZTtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdFByb3AodGhpcyk7IH1cbiAgICBlcShvdGhlciA6IEV4cHIpIDogYm9vbGVhbiB7IHJldHVybiBvdGhlciBpbnN0YW5jZW9mIFByb3AgJiYgb3RoZXIuaW5zdGFuY2UuZXEodGhpcy5pbnN0YW5jZSkgJiYgb3RoZXIubmFtZSA9PT0gdGhpcy5uYW1lOyB9XG4gICAgdG9TdHJpbmcoKSB7IHJldHVybiBgJHt0aGlzLmluc3RhbmNlLnRvU3RyaW5nKCl9LiR7dGhpcy5uYW1lfWA7IH1cbn1cblxuZXhwb3J0IGNsYXNzIFBhcmFtIGV4dGVuZHMgRXhwciB7XG4gICAgbmFtZSA6IFN5bWJvbFxuICAgIGNvbnN0cnVjdG9yKG5hbWUgOiBTeW1ib2wpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdFBhcmFtKHRoaXMpOyB9XG4gICAgZXEob3RoZXIgOiBFeHByKSA6IGJvb2xlYW4geyByZXR1cm4gb3RoZXIgaW5zdGFuY2VvZiBQYXJhbSAmJiBvdGhlci5uYW1lID09PSB0aGlzLm5hbWU7IH1cbiAgICB0b1N0cmluZygpIHsgcmV0dXJuIHRoaXMubmFtZS50b1N0cmluZygpOyB9XG59XG5cbmV4cG9ydCBjbGFzcyBCaW5PcCBleHRlbmRzIEV4cHIge1xuICAgIHByaXZhdGUgc3RhdGljIGJpbk9wU3RyaW5ncyA9IHtcbiAgICAgICAgW0JpbmFyeU9wZXJhdGlvbi5FUV06ICc9JyxcbiAgICAgICAgW0JpbmFyeU9wZXJhdGlvbi5ORVFdOiAnIT0nLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLkdUXTogJz4nLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLkxUXTogJzwnLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLkxFXTogJz49JyxcbiAgICAgICAgW0JpbmFyeU9wZXJhdGlvbi5HRV06ICc8PScsXG4gICAgICAgIFtCaW5hcnlPcGVyYXRpb24uT1JdOiAnfHwnLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLkFORF06ICcmJicsXG4gICAgICAgIFtCaW5hcnlPcGVyYXRpb24uTVVMXTogJyonLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLkRJVl06ICcvJyxcbiAgICAgICAgW0JpbmFyeU9wZXJhdGlvbi5NT0RdOiAnJScsXG4gICAgICAgIFtCaW5hcnlPcGVyYXRpb24uQUREXTogJysnLFxuICAgICAgICBbQmluYXJ5T3BlcmF0aW9uLlNVQl06ICctJ1xuICAgIH1cbiAgICBzdGF0aWMgdW53aW5kIChoZWFkIDogRXhwciwgdGFpbCA6IEFycmF5PEFycmF5PGFueT4+KSB7XG4gICAgICAgIGlmICghdGFpbCB8fCAhdGFpbC5sZW5ndGgpIHtcbiAgICAgICAgICAgIHJldHVybiBoZWFkO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB0YWlsLnJlZHVjZSgobGVmdCwgdmFscykgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3AgPSB2YWxzWzFdO1xuICAgICAgICAgICAgY29uc3QgcmlnaHQgPSB2YWxzWzNdO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBCaW5PcChsZWZ0LCBvcCwgcmlnaHQpO1xuICAgICAgICB9LCBoZWFkKTtcbiAgICB9XG4gICAgbGVmdCA6IEV4cHJcbiAgICBvcCA6IEJpbmFyeU9wZXJhdGlvblxuICAgIHJpZ2h0IDogRXhwclxuICAgIGNvbnN0cnVjdG9yIChsZWZ0IDogRXhwciwgb3AgOiBCaW5hcnlPcGVyYXRpb24sIHJpZ2h0IDogRXhwcikge1xuICAgICAgICBzdXBlcigpO1xuICAgICAgICB0aGlzLmxlZnQgPSBsZWZ0O1xuICAgICAgICB0aGlzLm9wID0gb3A7XG4gICAgICAgIHRoaXMucmlnaHQgPSByaWdodDtcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3IgOiBFeHByVmlzaXRvcjxUPikgeyByZXR1cm4gdmlzaXRvci52aXNpdEJpbmFyeSh0aGlzKTsgfVxuICAgIGVxKG90aGVyIDogRXhwcikgOiBib29sZWFuIHtcbiAgICAgICAgcmV0dXJuIG90aGVyIGluc3RhbmNlb2YgQmluT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIubGVmdC5lcSh0aGlzLmxlZnQpICYmIG90aGVyLnJpZ2h0LmVxKHRoaXMucmlnaHQpO1xuICAgIH1cbiAgICB0b1N0cmluZygpIHtcbiAgICAgICAgcmV0dXJuIGAoJHt0aGlzLmxlZnQudG9TdHJpbmcoKX0gJHtCaW5PcC5iaW5PcFN0cmluZ3NbdGhpcy5vcF19ICR7dGhpcy5yaWdodC50b1N0cmluZygpfSlgO1xuICAgIH1cbn1cblxuZXhwb3J0IGNsYXNzIFVuT3AgZXh0ZW5kcyBFeHByIHtcbiAgICBwcml2YXRlIHN0YXRpYyB1bk9wU3RyaW5ncyA9IHtcbiAgICAgICAgW1VuYXJ5T3BlcmF0aW9uLk5PVF06ICdub3QnLFxuICAgICAgICBbVW5hcnlPcGVyYXRpb24uTkVHXTogJ25lZycsXG4gICAgICAgIFtVbmFyeU9wZXJhdGlvbi5JU19OVUxMXTogJ2lzTnVsbCdcbiAgICB9XG4gICAgb3A6IFVuYXJ5T3BlcmF0aW9uXG4gICAgb3BlcmFuZDogRXhwclxuICAgIGNvbnN0cnVjdG9yKG9wIDogVW5hcnlPcGVyYXRpb24sIG9wZXJhbmQ6IEV4cHIpIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgdGhpcy5vcCA9IG9wO1xuICAgICAgICB0aGlzLm9wZXJhbmQgPSBvcGVyYW5kO1xuICAgIH1cbiAgICBhY2NlcHQ8VD4odmlzaXRvciA6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0VW5hcnkodGhpcyk7IH1cbiAgICBlcShvdGhlciA6IEV4cHIpIDogYm9vbGVhbiB7XG4gICAgICAgIHJldHVybiBvdGhlciBpbnN0YW5jZW9mIFVuT3AgJiYgb3RoZXIub3AgPT09IHRoaXMub3AgJiYgb3RoZXIub3BlcmFuZC5lcSh0aGlzLm9wZXJhbmQpO1xuICAgIH1cbiAgICB0b1N0cmluZygpIHtcbiAgICAgICAgaWYgKHRoaXMub3AgPT09IFVuYXJ5T3BlcmF0aW9uLk5PVCkge1xuICAgICAgICAgICAgcmV0dXJuIGAhKCR7dGhpcy5vcGVyYW5kfSlgO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBgJHtVbk9wLnVuT3BTdHJpbmdzW3RoaXMub3BdfSgke3RoaXMub3BlcmFuZH0pYDtcbiAgICB9XG59XG5cbmludGVyZmFjZSBLbm93bkZ1bmN0aW9uQ2FsbHMge1xuICAgIFtuYW1lIDogc3RyaW5nXSA6IEFycmF5PG51bWJlcj4gfCBudW1iZXJcbn1cblxuZXhwb3J0IGNsYXNzIENhbGwgZXh0ZW5kcyBFeHByIHtcbiAgICBzdGF0aWMga25vd25GdW5jdGlvbnM6IEtub3duRnVuY3Rpb25DYWxscyA9IHtcbiAgICAgICAgY29udGFpbnM6IDIsXG4gICAgICAgIHN1YnN0cmluZzogWzIsIDNdXG4gICAgfVxuICAgIG5hbWU6IHN0cmluZ1xuICAgIGFyZ3M6IEFycmF5PEV4cHI+XG4gICAgY29uc3RydWN0b3IobmFtZTogc3RyaW5nLCBhcmdzIDogQXJyYXk8RXhwcj4pIHtcbiAgICAgICAgc3VwZXIoKTtcbiAgICAgICAgaWYgKENhbGwua25vd25GdW5jdGlvbnNbbmFtZV0pIHtcbiAgICAgICAgICAgIGNvbnN0IGFyZ0NvdW50ID0gQ2FsbC5rbm93bkZ1bmN0aW9uc1tuYW1lXTtcbiAgICAgICAgICAgIGlmICgnbnVtYmVyJyA9PT0gdHlwZW9mIGFyZ0NvdW50KSB7XG4gICAgICAgICAgICAgICAgaWYgKGFyZ0NvdW50ICE9PSBhcmdzLmxlbmd0aCkge1xuICAgICAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYGludmFsaWQgYXJndW1lbnQgY291bnQgZm9yICR7bmFtZX06ICR7YXJncy5sZW5ndGh9LCBhY2NlcHRlZCBhcmd1bWVudCBjb3VudDogJHthcmdDb3VudH1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIGlmICgtMSA9PT0gYXJnQ291bnQuaW5kZXhPZihhcmdzLmxlbmd0aCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBpbnZhbGlkIGFyZ3VtZW50IGNvdW50IGZvciAke25hbWV9OiAke2FyZ3MubGVuZ3RofSwgYWNjZXB0ZWQgYXJndW1lbnQgY291bnRzOiAke2FyZ0NvdW50LmpvaW4oJywnKX1gKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5uYW1lID0gbmFtZTtcbiAgICAgICAgdGhpcy5hcmdzID0gYXJncztcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3I6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0Q2FsbCh0aGlzKTsgfVxuICAgIGVxKG90aGVyOiBFeHByKSB7XG4gICAgICAgIGlmICghKG90aGVyIGluc3RhbmNlb2YgQ2FsbCkpIHtcbiAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgfVxuICAgICAgICBpZiAob3RoZXIubmFtZSAhPT0gdGhpcy5uYW1lKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKG90aGVyLmFyZ3MubGVuZ3RoICE9PSB0aGlzLmFyZ3MubGVuZ3RoKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBvdGhlci5hcmdzLmxlbmd0aDsgaSA9IGkgKyAxKSB7XG4gICAgICAgICAgICBpZiAoIW90aGVyLmFyZ3NbaV0uZXEodGhpcy5hcmdzW2ldKSkge1xuICAgICAgICAgICAgICAgIHJldHVybiBmYWxzZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gICAgdG9TdHJpbmcoKSB7XG4gICAgICAgIHJldHVybiBgJHt0aGlzLm5hbWV9KCR7dGhpcy5hcmdzLm1hcChhcmcgPT4gYXJnLnRvU3RyaW5nKCkpLmpvaW4oJywnKX0pYDtcbiAgICB9XG59XG5cbmV4cG9ydCBjbGFzcyBMYW1iZGEgZXh0ZW5kcyBFeHByIHtcbiAgICBib2R5OiBFeHByXG4gICAgcGFyYW06IFBhcmFtXG4gICAgY29uc3RydWN0b3IoYm9keTogRXhwciwgcGFyYW06IFBhcmFtKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMuYm9keSA9IGJvZHk7XG4gICAgICAgIHRoaXMucGFyYW0gPSBwYXJhbTtcbiAgICB9XG4gICAgYWNjZXB0PFQ+KHZpc2l0b3I6IEV4cHJWaXNpdG9yPFQ+KSB7IHJldHVybiB2aXNpdG9yLnZpc2l0TGFtYmRhKHRoaXMpOyB9XG4gICAgZXEob3RoZXI6IEV4cHIpIHtcbiAgICAgICAgaWYgKCEob3RoZXIgaW5zdGFuY2VvZiBMYW1iZGEpKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgIH1cbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdMYW1iZGEgZXF1YWxpdHkgaXMgbm90IGltcGxlbWVudGVkIScpO1xuICAgIH1cbiAgICB0b1N0cmluZygpIHsgcmV0dXJuIGAke3RoaXMucGFyYW19ID0+ICR7dGhpcy5ib2R5fWA7IH1cbiAgICBzdWJzdGl0dXRlUGFyYW1ldGVyKHRhcmdldDogUGFyYW0pIHtcbiAgICAgICAgcmV0dXJuIG5ldyBMYW1iZGEoc3Vic3RpdHV0ZVBhcmFtZXRlcih0aGlzLnBhcmFtLCB0YXJnZXQsIHRoaXMuYm9keSksIHRhcmdldCk7XG4gICAgfVxuICAgIGFuZChvdGhlcjogTGFtYmRhKSB7XG4gICAgICAgIGlmICh0aGlzLnBhcmFtLmVxKG90aGVyLnBhcmFtKSkge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBMYW1iZGEobmV3IEJpbk9wKHRoaXMuYm9keSwgQmluYXJ5T3BlcmF0aW9uLkFORCwgb3RoZXIuYm9keSksIHRoaXMucGFyYW0pO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgTGFtYmRhKG5ldyBCaW5PcCh0aGlzLmJvZHksIEJpbmFyeU9wZXJhdGlvbi5BTkQsIG90aGVyLnN1YnN0aXR1dGVQYXJhbWV0ZXIodGhpcy5wYXJhbSkuYm9keSksIHRoaXMucGFyYW0pO1xuICAgIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnNlIChyYXcgOiBzdHJpbmcpIDogRXhwciB7XG4gICAgcmV0dXJuIHBhcnNlci5wYXJzZShyYXcpO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc3Vic3RpdHV0ZVBhcmFtZXRlciAoc291cmNlOiBQYXJhbSwgdGFyZ2V0OiBQYXJhbSwgZXhwcmVzc2lvbjogRXhwcikge1xuICAgIGNvbnN0IHZpc2l0b3IgPSBuZXcgY2xhc3MgZXh0ZW5kcyBDb252ZXJ0VmlzaXRvciB7XG4gICAgICAgIHZpc2l0UGFyYW0ocDogUGFyYW0pIHsgcmV0dXJuIHAuZXEoc291cmNlKSA/IHRhcmdldCA6IHA7IH1cbiAgICB9XG4gICAgcmV0dXJuIGV4cHJlc3Npb24uYWNjZXB0KHZpc2l0b3IpO1xufSJdfQ==
import { Query, QuerySortDirection } from "./repositories";
import * as Q from './protocol';
import { decoratedFetch as fetch } from 'dopees-core/lib/fetch';
const checkNum = (n, message) => {
    if (n % 1 !== 0 || n <= 0) {
        throw new TypeError(message);
    }
};
const supportsAbortController = (function () {
    if (window.AbortController) {
        return true;
    }
    return false;
}());
function linkAbortion(cancellation) {
    let signal;
    let subscription;
    if (undefined !== cancellation && supportsAbortController) {
        const abortController = new AbortController();
        signal = abortController.signal;
        subscription = cancellation.subscribe(() => abortController.abort());
    }
    else {
        signal = undefined;
        subscription = { remove() { } };
    }
    return { signal, subscription };
}
export class KeyRestRepository {
    constructor(options) {
        this.options = options;
    }
    get collectionEndpoint() {
        return `${this.endpoint}/${this.type}`;
    }
    get protocolVersion() {
        return this.options.protocolVersion || 2;
    }
    get type() {
        return this.options.type;
    }
    get endpoint() {
        return this.options.endpoint;
    }
    get keyProperty() {
        return this.options.keyProperty || 'id';
    }
    get items() {
        return new RestQuery(this, 0, RestQuery.defaultCount);
    }
    getKey(item) {
        return item[this.keyProperty];
    }
    hasKey(item) {
        return !!this.getKey(item);
    }
    itemEndpoint(item) {
        return `${this.endpoint}/${this.type}/${this.getKey(item)}`;
    }
    __getErrors(response) {
        const messages = response.headers.get('X-Message');
        if (messages) {
            const msgs = messages.split(',').map(decodeURIComponent);
            if (msgs.length === 1) {
                return msgs[0];
            }
            return msgs;
        }
        return response.statusText;
    }
    async lookup(key, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const uri = `${this.endpoint}/${this.type}/${key}`;
            const response = await fetch(uri, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                signal: abortion.signal
            });
            if (response.ok) {
                return await response.json();
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    async update(item, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const response = await fetch(this.itemEndpoint(item), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item),
                signal: abortion.signal
            });
            if (response.ok) {
                return await this.lookup(this.getKey(item), cancellation);
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    async insert(item, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const response = await fetch(this.collectionEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item),
                signal: abortion.signal
            });
            if (response.ok) {
                const uri = response.headers.get('Location');
                if (!uri) {
                    throw new Error('rest insert did not return a location');
                }
                const lookupAbortion = linkAbortion(cancellation);
                try {
                    const resp = await fetch(uri, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: lookupAbortion.signal
                    });
                    if (resp.ok) {
                        return await resp.json();
                    }
                    throw this.__getErrors(resp);
                }
                finally {
                    lookupAbortion.subscription.remove();
                }
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    remove(item, cancellation) {
        throw new Error("Method not implemented.");
    }
    async total(predicate, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const headers = new Headers();
            headers.append('Accept', 'application/json');
            headers.append('X-Filter', predicate);
            const response = await fetch(this.collectionEndpoint, { headers, signal: abortion.signal });
            if (response.ok) {
                const header = response.headers.get('X-Total-Count');
                return header ? (parseInt(header, 10) || 0) : 0;
            }
            else {
                throw new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
            }
        }
        finally {
            abortion.subscription.remove();
        }
    }
    exec(offset, count, predicate, sortBy, sortByDirection) {
        const repo = this;
        let error = null;
        let items = null;
        let index = 0;
        return {
            async next(cancellation) {
                cancellation && cancellation.throwIfCancelled();
                if (null !== error) {
                    throw error;
                }
                if (!items) {
                    // Első next() meghívásakor ez fut le.
                    const abortion = linkAbortion(cancellation);
                    try {
                        const headers = new Headers();
                        headers.append('Accept', 'application/json');
                        headers.append('X-Offset', String(offset));
                        headers.append('X-Count', String(count));
                        headers.append('X-Filter', predicate);
                        headers.append('X-Sort-By', sortBy || '');
                        headers.append('X-Sort-By-Direction', sortByDirection || '');
                        const response = await fetch(repo.collectionEndpoint, { headers, signal: abortion.signal });
                        if (response.ok) {
                            items = await response.json();
                        }
                        else {
                            error = new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
                            throw error;
                        }
                    }
                    finally {
                        abortion.subscription.remove();
                    }
                }
                if (!items) {
                    throw new Error('should never happen');
                }
                if (index >= items.length) {
                    return { done: true, value: undefined };
                }
                const value = items[index];
                ++index;
                return {
                    done: false,
                    value: value
                };
            },
            cancel() {
                //FIXME: implement
            }
        };
    }
}
class RestQuery extends Query {
    constructor(repo, offset, count, predicate, sortBy, sortByDirection) {
        super();
        this.repo = repo;
        this.offset = offset || 0;
        this.count = 0 === count ? count : (count || RestQuery.defaultCount);
        this.predicate = predicate || null;
        this.sortBy = sortBy || '';
        this.sortByDirection = sortByDirection || QuerySortDirection.Asc;
    }
    escape(input) {
        if (!input) {
            return '';
        }
        const inp = input instanceof Q.Expr ? input.toString() : input;
        // return window.utf8.encode(inp).replace(regex, m => '%' + ('0' + m.charCodeAt(0).toString(16).toUpperCase()).slice(-2));
        return inp;
    }
    get escapedPredicate() {
        return this.escape(this.predicate);
    }
    get escapedSortBy() {
        return this.escape(this.sortBy);
    }
    filter(predicate) {
        const p = 'string' === typeof predicate ? Q.parse(predicate) : predicate;
        if (!(p instanceof Q.Lambda)) {
            throw TypeError('predicate must be a lambda expression');
        }
        return new RestQuery(this.repo, this.offset, this.count, this.predicate ? this.predicate.and(p) : p, this.sortBy, this.sortByDirection);
    }
    skip(n) {
        if (0 === n) {
            return this;
        }
        checkNum(n, 'skip parameter must be non-negative whole number.');
        return new RestQuery(this.repo, n, // TODO: Ezt végig kell gondolni, mert lehet (this.offset + n) kellene ide?
        this.count, this.predicate, this.sortBy, this.sortByDirection);
    }
    take(n) {
        checkNum(n, 'take parameter must be non-negative whole number.');
        return new RestQuery(this.repo, this.offset, n, this.predicate, this.sortBy, this.sortByDirection);
    }
    orderBy(selector, direction) {
        return new RestQuery(this.repo, this.offset, this.count, this.predicate, selector, direction || QuerySortDirection.Asc);
    }
    async total(cancellation) {
        return this.repo.total(this.escapedPredicate, cancellation);
    }
    exec() {
        return this.repo.exec(this.offset, this.count, this.escapedPredicate, this.sortBy, this.sortByDirection);
    }
}
RestQuery.defaultCount = 100000;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQXdDLGtCQUFrQixFQUErQixNQUFNLGdCQUFnQixDQUFBO0FBQzdILE9BQU8sS0FBSyxDQUFDLE1BQU0sWUFBWSxDQUFBO0FBQy9CLE9BQU8sRUFBRSxjQUFjLElBQUksS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFHaEUsTUFBTSxRQUFRLEdBQUcsQ0FBQyxDQUFTLEVBQUUsT0FBZSxFQUFFLEVBQUU7SUFDOUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1FBQ3pCLE1BQU0sSUFBSSxTQUFTLENBQUMsT0FBTyxDQUFDLENBQUM7S0FDOUI7QUFDSCxDQUFDLENBQUE7QUFTRCxNQUFNLHVCQUF1QixHQUFHLENBQUM7SUFDL0IsSUFBSyxNQUFjLENBQUMsZUFBZSxFQUFFO1FBQ25DLE9BQU8sSUFBSSxDQUFDO0tBQ2I7SUFDRCxPQUFPLEtBQUssQ0FBQztBQUNmLENBQUMsRUFBRSxDQUFDLENBQUM7QUFPTCxTQUFTLFlBQVksQ0FBQyxZQUEyQjtJQUMvQyxJQUFJLE1BQTZCLENBQUM7SUFDbEMsSUFBSSxZQUFnQyxDQUFDO0lBQ3JDLElBQUksU0FBUyxLQUFLLFlBQVksSUFBSSx1QkFBdUIsRUFBRTtRQUN6RCxNQUFNLGVBQWUsR0FBRyxJQUFJLGVBQWUsRUFBRSxDQUFDO1FBQzlDLE1BQU0sR0FBRyxlQUFlLENBQUMsTUFBTSxDQUFDO1FBQ2hDLFlBQVksR0FBRyxZQUFZLENBQUMsU0FBUyxDQUFDLEdBQUcsRUFBRSxDQUFDLGVBQWUsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDO0tBQ3RFO1NBQU07UUFDTCxNQUFNLEdBQUcsU0FBUyxDQUFDO1FBQ25CLFlBQVksR0FBRyxFQUFFLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztL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WyJpbXBvcnQgeyBRdWVyeSwgUmVwb3NpdG9yeSwgQ2FuY2VsbGFibGVBc3luY0l0ZXJhdG9yLCBRdWVyeVNvcnREaXJlY3Rpb24sIEtleVJlcG9zaXRvcnksIENhbmNlbGxhdGlvbiB9IGZyb20gXCIuL3JlcG9zaXRvcmllc1wiXG5pbXBvcnQgKiBhcyBRIGZyb20gJy4vcHJvdG9jb2wnXG5pbXBvcnQgeyBkZWNvcmF0ZWRGZXRjaCBhcyBmZXRjaCB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi9mZXRjaCc7XG5cblxuY29uc3QgY2hlY2tOdW0gPSAobjogbnVtYmVyLCBtZXNzYWdlOiBzdHJpbmcpID0+IHtcbiAgaWYgKG4gJSAxICE9PSAwIHx8IG4gPD0gMCkge1xuICAgIHRocm93IG5ldyBUeXBlRXJyb3IobWVzc2FnZSk7XG4gIH1cbn1cblxuaW50ZXJmYWNlIFJlc3RSZXBvc2l0b3J5T3B0aW9ucyB7XG4gIHR5cGU6IHN0cmluZztcbiAgZW5kcG9pbnQ6IHN0cmluZztcbiAga2V5UHJvcGVydHk/OiBzdHJpbmc7XG4gIHByb3RvY29sVmVyc2lvbj86IG51bWJlcjtcbn1cblxuY29uc3Qgc3VwcG9ydHNBYm9ydENvbnRyb2xsZXIgPSAoZnVuY3Rpb24gKCkge1xuICBpZiAoKHdpbmRvdyBhcyBhbnkpLkFib3J0Q29udHJvbGxlcikge1xuICAgIHJldHVybiB0cnVlO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn0oKSk7XG5cbmludGVyZmFjZSBBYm9ydGlvbiB7XG4gIHNpZ25hbDogQWJvcnRTaWduYWx8dW5kZWZpbmVkXG4gIHN1YnNjcmlwdGlvbjogeyByZW1vdmUoKTogdm9pZCB9XG59XG5cbmZ1bmN0aW9uIGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBBYm9ydGlvbiB7XG4gIGxldCBzaWduYWw6IEFib3J0U2lnbmFsfHVuZGVmaW5lZDtcbiAgbGV0IHN1YnNjcmlwdGlvbjogeyByZW1vdmUoKTogdm9pZCB9O1xuICBpZiAodW5kZWZpbmVkICE9PSBjYW5jZWxsYXRpb24gJiYgc3VwcG9ydHNBYm9ydENvbnRyb2xsZXIpIHtcbiAgICBjb25zdCBhYm9ydENvbnRyb2xsZXIgPSBuZXcgQWJvcnRDb250cm9sbGVyKCk7XG4gICAgc2lnbmFsID0gYWJvcnRDb250cm9sbGVyLnNpZ25hbDtcbiAgICBzdWJzY3JpcHRpb24gPSBjYW5jZWxsYXRpb24uc3Vic2NyaWJlKCgpID0+IGFib3J0Q29udHJvbGxlci5hYm9ydCgpKTtcbiAgfSBlbHNlIHtcbiAgICBzaWduYWwgPSB1bmRlZmluZWQ7XG4gICAgc3Vic2NyaXB0aW9uID0geyByZW1vdmUoKSB7IH0gfTtcbiAgfVxuICByZXR1cm4geyBzaWduYWwsIHN1YnNjcmlwdGlvbiB9O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlc3RSZXBvc2l0b3J5PFQ+IGV4dGVuZHMgUmVwb3NpdG9yeTxUPiB7XG4gIGV4ZWMob2Zmc2V0OiBudW1iZXIsIGNvdW50OiBudW1iZXIsIHByZWRpY2F0ZTogc3RyaW5nLCBzb3J0Qnk/OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbik6IENhbmNlbGxhYmxlQXN5bmNJdGVyYXRvcjxUPjtcbiAgdG90YWwocHJlZGljYXRlOiBzdHJpbmcsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxudW1iZXI+O1xufVxuXG5leHBvcnQgY2xhc3MgS2V5UmVzdFJlcG9zaXRvcnk8VERhdGEsIFRLZXk+IGltcGxlbWVudHMgS2V5UmVwb3NpdG9yeTxURGF0YSwgVEtleT4sIFJlc3RSZXBvc2l0b3J5PFREYXRhPiB7XG4gIHJlYWRvbmx5IG9wdGlvbnMgOiBSZXN0UmVwb3NpdG9yeU9wdGlvbnNcbiAgY29uc3RydWN0b3Iob3B0aW9uczogUmVzdFJlcG9zaXRvcnlPcHRpb25zKSB7XG4gICAgdGhpcy5vcHRpb25zID0gb3B0aW9ucztcbiAgfVxuICBwcml2YXRlIGdldCBjb2xsZWN0aW9uRW5kcG9pbnQgKCkge1xuICAgIHJldHVybiBgJHt0aGlzLmVuZHBvaW50fS8ke3RoaXMudHlwZX1gO1xuICB9XG4gIGdldCBwcm90b2NvbFZlcnNpb24gKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMucHJvdG9jb2xWZXJzaW9uIHx8IDI7XG4gIH1cbiAgZ2V0IHR5cGUgKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMudHlwZTtcbiAgfVxuICBnZXQgZW5kcG9pbnQgKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMuZW5kcG9pbnQ7XG4gIH1cbiAgZ2V0IGtleVByb3BlcnR5ICgpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmtleVByb3BlcnR5IHx8ICdpZCc7XG4gIH1cbiAgZ2V0IGl0ZW1zKCk6IFF1ZXJ5PFREYXRhPiB7XG4gICAgcmV0dXJuIG5ldyBSZXN0UXVlcnk8VERhdGE+KHRoaXMsIDAsIFJlc3RRdWVyeS5kZWZhdWx0Q291bnQpO1xuICB9XG4gIHByaXZhdGUgZ2V0S2V5KGl0ZW06IFREYXRhKSB7XG4gICAgcmV0dXJuIChpdGVtIGFzIGFueSlbdGhpcy5rZXlQcm9wZXJ0eV0gYXMgVEtleTtcbiAgfVxuICBwcml2YXRlIGhhc0tleShpdGVtOiBURGF0YSkge1xuICAgIHJldHVybiAhIXRoaXMuZ2V0S2V5KGl0ZW0pO1xuICB9XG4gIHByaXZhdGUgaXRlbUVuZHBvaW50KGl0ZW06IFREYXRhKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuZW5kcG9pbnR9LyR7dGhpcy50eXBlfS8ke3RoaXMuZ2V0S2V5KGl0ZW0pfWA7XG4gIH1cbiAgcHJpdmF0ZSBfX2dldEVycm9ycyAocmVzcG9uc2U6IFJlc3BvbnNlKSB7XG4gICAgY29uc3QgbWVzc2FnZXMgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnWC1NZXNzYWdlJyk7XG4gICAgaWYgKG1lc3NhZ2VzKSB7XG4gICAgICBjb25zdCBtc2dzID0gbWVzc2FnZXMuc3BsaXQoJywnKS5tYXAoZGVjb2RlVVJJQ29tcG9uZW50KTtcbiAgICAgIGlmIChtc2dzLmxlbmd0aCA9PT0gMSkge1xuICAgICAgICByZXR1cm4gbXNnc1swXTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBtc2dzO1xuICAgIH1cbiAgICByZXR1cm4gcmVzcG9uc2Uuc3RhdHVzVGV4dDtcbiAgfVxuICBhc3luYyBsb29rdXAoa2V5OiBUS2V5LCBjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFREYXRhPiB7XG4gICAgY29uc3QgYWJvcnRpb24gPSBsaW5rQWJvcnRpb24oY2FuY2VsbGF0aW9uKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgdXJpID0gYCR7dGhpcy5lbmRwb2ludH0vJHt0aGlzLnR5cGV9LyR7a2V5fWA7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHVyaSwge1xuICAgICAgICBtZXRob2Q6ICdHRVQnLFxuICAgICAgICBoZWFkZXJzOiB7ICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgc2lnbmFsOiBhYm9ydGlvbi5zaWduYWxcbiAgICAgIH0pO1xuICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHJldHVybiBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICB9XG4gICAgICB0aHJvdyB0aGlzLl9fZ2V0RXJyb3JzKHJlc3BvbnNlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuICBhc3luYyB1cGRhdGUoaXRlbTogVERhdGEsIGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+IHtcbiAgICBjb25zdCBhYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHRoaXMuaXRlbUVuZHBvaW50KGl0ZW0pLCB7XG4gICAgICAgIG1ldGhvZDogJ1BVVCcsXG4gICAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nXG4gICAgICAgIH0sXG4gICAgICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGl0ZW0pLFxuICAgICAgICBzaWduYWw6IGFib3J0aW9uLnNpZ25hbFxuICAgICAgfSk7XG4gICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubG9va3VwKHRoaXMuZ2V0S2V5KGl0ZW0pLCBjYW5jZWxsYXRpb24pO1xuICAgICAgfVxuICAgICAgdGhyb3cgdGhpcy5fX2dldEVycm9ycyhyZXNwb25zZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGFib3J0aW9uLnN1YnNjcmlwdGlvbi5yZW1vdmUoKTtcbiAgICB9XG4gIH1cbiAgYXN5bmMgaW5zZXJ0KGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+IHtcbiAgICBjb25zdCBhYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHRoaXMuY29sbGVjdGlvbkVuZHBvaW50LCB7XG4gICAgICAgIG1ldGhvZDogJ1BPU1QnLFxuICAgICAgICBoZWFkZXJzOiB7ICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoaXRlbSksXG4gICAgICAgIHNpZ25hbDogYWJvcnRpb24uc2lnbmFsXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgICBjb25zdCB1cmkgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnTG9jYXRpb24nKTtcbiAgICAgICAgaWYgKCF1cmkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jlc3QgaW5zZXJ0IGRpZCBub3QgcmV0dXJuIGEgbG9jYXRpb24nKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBsb29rdXBBYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGNvbnN0IHJlc3AgPSBhd2FpdCBmZXRjaCh1cmksIHtcbiAgICAgICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgICAgICBoZWFkZXJzOiB7ICdBY2NlcHQnOiAnYXBwbGljYXRpb24vanNvbicgfSxcbiAgICAgICAgICAgIHNpZ25hbDogbG9va3VwQWJvcnRpb24uc2lnbmFsXG4gICAgICAgICAgfSlcbiAgICAgICAgICBpZiAocmVzcC5vaykge1xuICAgICAgICAgICAgcmV0dXJuIGF3YWl0IHJlc3AuanNvbigpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyB0aGlzLl9fZ2V0RXJyb3JzKHJlc3ApO1xuICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgIGxvb2t1cEFib3J0aW9uLnN1YnNjcmlwdGlvbi5yZW1vdmUoKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgdGhyb3cgdGhpcy5fX2dldEVycm9ycyhyZXNwb25zZSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGFib3J0aW9uLnN1YnNjcmlwdGlvbi5yZW1vdmUoKTtcbiAgICB9XG4gIH1cbiAgcmVtb3ZlKGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8dm9pZD4ge1xuICAgIHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xuICB9XG4gIGFzeW5jIHRvdGFsKHByZWRpY2F0ZTogc3RyaW5nLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgYWJvcnRpb24gPSBsaW5rQWJvcnRpb24oY2FuY2VsbGF0aW9uKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7XG4gICAgICBoZWFkZXJzLmFwcGVuZCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLUZpbHRlcicsIHByZWRpY2F0ZSk7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHRoaXMuY29sbGVjdGlvbkVuZHBvaW50LCB7IGhlYWRlcnMsIHNpZ25hbDogYWJvcnRpb24uc2lnbmFsIH0pO1xuICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgIGNvbnN0IGhlYWRlciA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdYLVRvdGFsLUNvdW50Jyk7XG4gICAgICAgIHJldHVybiBoZWFkZXIgPyAocGFyc2VJbnQoaGVhZGVyLCAxMCkgfHwgMCkgOiAwO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIaWJhIGzDqXBldHQgZmVsIGFkYXRvayBsZWvDqXJkZXrDqXNlIGvDtnpiZW46ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgYWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuICBleGVjKG9mZnNldDogbnVtYmVyLCBjb3VudDogbnVtYmVyLCBwcmVkaWNhdGU6IHN0cmluZywgc29ydEJ5Pzogc3RyaW5nLCBzb3J0QnlEaXJlY3Rpb24/OiBRdWVyeVNvcnREaXJlY3Rpb24pOiBDYW5jZWxsYWJsZUFzeW5jSXRlcmF0b3I8VERhdGE+IHtcbiAgICBjb25zdCByZXBvID0gdGhpcztcbiAgICBsZXQgZXJyb3IgOiBhbnkgPSBudWxsO1xuICAgIGxldCBpdGVtcyA6IFREYXRhW118bnVsbCA9IG51bGw7XG4gICAgbGV0IGluZGV4ID0gMDtcbiAgICByZXR1cm4ge1xuICAgICAgYXN5bmMgbmV4dChjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPEl0ZXJhdG9yUmVzdWx0PFREYXRhPj4ge1xuICAgICAgICBjYW5jZWxsYXRpb24gJiYgY2FuY2VsbGF0aW9uLnRocm93SWZDYW5jZWxsZWQoKTtcbiAgICAgICAgaWYgKG51bGwgIT09IGVycm9yKSB7XG4gICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFpdGVtcykge1xuICAgICAgICAgIC8vIEVsc8WRIG5leHQoKSBtZWdow612w6FzYWtvciBleiBmdXQgbGUuXG4gICAgICAgICAgY29uc3QgYWJvcnRpb24gPSBsaW5rQWJvcnRpb24oY2FuY2VsbGF0aW9uKTtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7XG4gICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLU9mZnNldCcsIFN0cmluZyhvZmZzZXQpKTtcbiAgICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLUNvdW50JywgU3RyaW5nKGNvdW50KSk7XG4gICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1GaWx0ZXInLCBwcmVkaWNhdGUpO1xuICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtU29ydC1CeScsIHNvcnRCeSB8fCAnJyk7XG4gICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1Tb3J0LUJ5LURpcmVjdGlvbicsIHNvcnRCeURpcmVjdGlvbiB8fCAnJyk7XG4gICAgICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGZldGNoKHJlcG8uY29sbGVjdGlvbkVuZHBvaW50LCB7IGhlYWRlcnMsIHNpZ25hbDogYWJvcnRpb24uc2lnbmFsIH0pO1xuICAgICAgICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgICAgICAgIGl0ZW1zID0gYXdhaXQgcmVzcG9uc2UuanNvbigpO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgZXJyb3IgPSBuZXcgRXJyb3IoYEhpYmEgbMOpcGV0dCBmZWwgYWRhdG9rIGxla8OpcmRlesOpc2Uga8O2emJlbjogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGZpbmFsbHkge1xuICAgICAgICAgICAgYWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBpZiAoIWl0ZW1zKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaG91bGQgbmV2ZXIgaGFwcGVuJyk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKGluZGV4ID49IGl0ZW1zLmxlbmd0aCkge1xuICAgICAgICAgIHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlOiA8VERhdGE+PHVua25vd24+dW5kZWZpbmVkIH1cbiAgICAgICAgfVxuICAgICAgICBjb25zdCB2YWx1ZSA9IGl0ZW1zW2luZGV4XTtcbiAgICAgICAgKytpbmRleDtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBkb25lOiBmYWxzZSxcbiAgICAgICAgICB2YWx1ZTogdmFsdWVcbiAgICAgICAgfTtcbiAgICAgIH0sXG4gICAgICBjYW5jZWwoKSB7XG4gICAgICAgICAgLy9GSVhNRTogaW1wbGVtZW50XG4gICAgICB9XG4gICAgfVxuICB9XG59XG5cbmNsYXNzIFJlc3RRdWVyeTxUPiBleHRlbmRzIFF1ZXJ5PFQ+IHtcbiAgc3RhdGljIGRlZmF1bHRDb3VudCA9IDEwMDAwMFxuICByZWFkb25seSByZXBvOiBSZXN0UmVwb3NpdG9yeTxUPlxuICByZWFkb25seSBvZmZzZXQ6IG51bWJlclxuICByZWFkb25seSBjb3VudDogbnVtYmVyXG4gIHJlYWRvbmx5IHByZWRpY2F0ZTogUS5MYW1iZGF8bnVsbFxuICByZWFkb25seSBzb3J0Qnk6IHN0cmluZ1xuICByZWFkb25seSBzb3J0QnlEaXJlY3Rpb246IFF1ZXJ5U29ydERpcmVjdGlvblxuICBjb25zdHJ1Y3RvciAocmVwbzogUmVzdFJlcG9zaXRvcnk8VD4sIG9mZnNldDogbnVtYmVyLCBjb3VudDogbnVtYmVyLCBwcmVkaWNhdGU/OiBRLkxhbWJkYXxudWxsLCBzb3J0Qnk/OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZXBvID0gcmVwbztcbiAgICB0aGlzLm9mZnNldCA9IG9mZnNldCB8fCAwO1xuICAgIHRoaXMuY291bnQgPSAwID09PSBjb3VudCA/IGNvdW50IDogKGNvdW50IHx8IFJlc3RRdWVyeS5kZWZhdWx0Q291bnQpO1xuICAgIHRoaXMucHJlZGljYXRlID0gcHJlZGljYXRlIHx8IG51bGw7XG4gICAgdGhpcy5zb3J0QnkgPSBzb3J0QnkgfHwgJyc7XG4gICAgdGhpcy5zb3J0QnlEaXJlY3Rpb24gPSBzb3J0QnlEaXJlY3Rpb24gfHwgUXVlcnlTb3J0RGlyZWN0aW9uLkFzYztcbiAgfVxuICBwcml2YXRlIGVzY2FwZSAoaW5wdXQ6IHN0cmluZ3xRLkV4cHJ8bnVsbCkge1xuICAgIGlmICghaW5wdXQpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gICAgY29uc3QgaW5wID0gaW5wdXQgaW5zdGFuY2VvZiBRLkV4cHIgPyBpbnB1dC50b1N0cmluZygpIDogaW5wdXQ7XG4gICAgLy8gcmV0dXJuIHdpbmRvdy51dGY4LmVuY29kZShpbnApLnJlcGxhY2UocmVnZXgsIG0gPT4gJyUnICsgKCcwJyArIG0uY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKSkuc2xpY2UoLTIpKTtcbiAgICByZXR1cm4gaW5wO1xuICB9XG4gIGdldCBlc2NhcGVkUHJlZGljYXRlICgpIHtcbiAgICByZXR1cm4gdGhpcy5lc2NhcGUodGhpcy5wcmVkaWNhdGUpO1xuICB9XG4gIGdldCBlc2NhcGVkU29ydEJ5ICgpIHtcbiAgICByZXR1cm4gdGhpcy5lc2NhcGUodGhpcy5zb3J0QnkpO1xuICB9XG4gIGZpbHRlciAocHJlZGljYXRlOiBzdHJpbmd8US5MYW1iZGEpOiBRdWVyeTxUPiB7XG4gICAgY29uc3QgcCA9ICdzdHJpbmcnID09PSB0eXBlb2YgcHJlZGljYXRlID8gUS5wYXJzZShwcmVkaWNhdGUpIDogcHJlZGljYXRlO1xuICAgIGlmICghKHAgaW5zdGFuY2VvZiBRLkxhbWJkYSkpIHtcbiAgICAgIHRocm93IFR5cGVFcnJvcigncHJlZGljYXRlIG11c3QgYmUgYSBsYW1iZGEgZXhwcmVzc2lvbicpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIHRoaXMub2Zmc2V0LFxuICAgICAgdGhpcy5jb3VudCxcbiAgICAgIHRoaXMucHJlZGljYXRlID8gdGhpcy5wcmVkaWNhdGUuYW5kKHApIDogcCxcbiAgICAgIHRoaXMuc29ydEJ5LFxuICAgICAgdGhpcy5zb3J0QnlEaXJlY3Rpb25cbiAgICApO1xuICB9XG4gIHNraXAobjogbnVtYmVyKTogUXVlcnk8VD4ge1xuICAgIGlmICgwID09PSBuKSB7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gICAgY2hlY2tOdW0obiwgJ3NraXAgcGFyYW1ldGVyIG11c3QgYmUgbm9uLW5lZ2F0aXZlIHdob2xlIG51bWJlci4nKTtcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIG4sIC8vIFRPRE86IEV6dCB2w6lnaWcga2VsbCBnb25kb2xuaSwgbWVydCBsZWhldCAodGhpcy5vZmZzZXQgKyBuKSBrZWxsZW5lIGlkZT9cbiAgICAgIHRoaXMuY291bnQsXG4gICAgICB0aGlzLnByZWRpY2F0ZSxcbiAgICAgIHRoaXMuc29ydEJ5LFxuICAgICAgdGhpcy5zb3J0QnlEaXJlY3Rpb24sXG4gICAgKTtcbiAgfVxuICB0YWtlKG46IG51bWJlcik6IFF1ZXJ5PFQ+IHtcbiAgICBjaGVja051bShuLCAndGFrZSBwYXJhbWV0ZXIgbXVzdCBiZSBub24tbmVnYXRpdmUgd2hvbGUgbnVtYmVyLicpO1xuICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5PFQ+KFxuICAgICAgdGhpcy5yZXBvLFxuICAgICAgdGhpcy5vZmZzZXQsXG4gICAgICBuLFxuICAgICAgdGhpcy5wcmVkaWNhdGUsXG4gICAgICB0aGlzLnNvcnRCeSxcbiAgICAgIHRoaXMuc29ydEJ5RGlyZWN0aW9uKTtcbiAgfVxuICBvcmRlckJ5KHNlbGVjdG9yOiBzdHJpbmcsIGRpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbik6IFF1ZXJ5PFQ+IHtcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIHRoaXMub2Zmc2V0LFxuICAgICAgdGhpcy5jb3VudCxcbiAgICAgIHRoaXMucHJlZGljYXRlLFxuICAgICAgc2VsZWN0b3IsXG4gICAgICBkaXJlY3Rpb24gfHwgUXVlcnlTb3J0RGlyZWN0aW9uLkFzYyk7XG4gIH1cbiAgYXN5bmMgdG90YWwoY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIHJldHVybiB0aGlzLnJlcG8udG90YWwodGhpcy5lc2NhcGVkUHJlZGljYXRlLCBjYW5jZWxsYXRpb24pO1xuICB9XG4gIGV4ZWMoKTogQ2FuY2VsbGFibGVBc3luY0l0ZXJhdG9yPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5yZXBvLmV4ZWModGhpcy5vZmZzZXQsIHRoaXMuY291bnQsIHRoaXMuZXNjYXBlZFByZWRpY2F0ZSwgdGhpcy5zb3J0QnksIHRoaXMuc29ydEJ5RGlyZWN0aW9uKTtcbiAgfVxufTsiXX0=
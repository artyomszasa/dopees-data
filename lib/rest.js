import { Query, QuerySortDirection } from './repositories';
import * as Q from './protocol';
import { HttpError } from 'dopees-core/lib/fetch';
import * as utf8 from 'dopees-core/lib/utf8';
import { HttpClient, httpClientConfiguration } from 'dopees-core/lib/http';
import { Uri } from 'dopees-core/lib/uri';
const checkNum = (n, message) => {
    if (n % 1 !== 0 || n <= 0) {
        throw new TypeError(message);
    }
};
export class KeyRestRepository {
    constructor(options) {
        this.options = options;
        const restMessageHandler = httpClientConfiguration.getHandler((options && options.configuration) || 'rest');
        this.clientFactory = () => new HttpClient(restMessageHandler);
    }
    get collectionEndpoint() {
        return `${this.endpoint}/${this.type}`;
    }
    get protocolVersion() {
        return this.options.protocolVersion || 2;
    }
    get type() {
        return this.options.type;
    }
    get endpoint() {
        return this.options.endpoint;
    }
    get keyProperty() {
        return this.options.keyProperty || 'id';
    }
    get items() {
        // tslint:disable-next-line:max-line-length
        return new RestQuery(this, 0, RestQuery.defaultCount, null, undefined, undefined, {}, this.options.protocolVersion);
    }
    getKey(item) {
        return item[this.keyProperty];
    }
    hasKey(item) {
        return !!this.getKey(item);
    }
    itemEndpoint(item) {
        return `${this.endpoint}/${this.type}/${this.getKey(item)}`;
    }
    __getError(response) {
        const messages = response.headers.get('X-Message');
        if (messages) {
            return new HttpError(response, messages);
        }
        return new HttpError(response);
    }
    async lookup(key, cancellation) {
        const uri = `${this.endpoint}/${this.type}/${key}`;
        return this.clientFactory().getJson(uri, cancellation);
    }
    async update(item, cancellation) {
        if (!item) {
            throw new TypeError('unable to update empty value');
        }
        const response = await this.clientFactory().put(this.itemEndpoint(item), item, cancellation);
        if (response.ok) {
            return await this.lookup(this.getKey(item), cancellation);
        }
        throw this.__getError(response);
    }
    async insert(item, cancellation) {
        if (!item) {
            throw new TypeError('unable to insert empty value');
        }
        const response = await this.clientFactory().post(this.collectionEndpoint, item, cancellation);
        if (response.ok) {
            const uri = response.headers.get('Location');
            if (!uri) {
                throw new Error('rest insert did not return a location');
            }
            return this.clientFactory().getJson(uri, cancellation);
        }
        throw this.__getError(response);
    }
    async remove(item, cancellation) {
        const response = await this.clientFactory().delete(this.itemEndpoint(item), cancellation);
        if (200 === response.status || 202 === response.status || 204 === response.status) {
            // success;
            return;
        }
        throw this.__getError(response);
    }
    // tslint:disable-next-line:max-line-length
    async total(predicate, query, customOptions, cancellation) {
        const headers = new Headers();
        headers.append('Accept', 'application/json');
        headers.append('X-Filter', predicate);
        headers.append('X-Count', '0');
        if (query && query.query) {
            headers.append('X-Query', query.query);
            headers.append('X-SearchType', query.type || 'partial');
        }
        const customKeys = Object.keys(customOptions || {});
        customKeys.forEach((key) => {
            const value = customOptions[key];
            if (value) {
                headers.append(key, value);
            }
        });
        const response = await this.clientFactory().send({
            uri: new Uri(this.collectionEndpoint),
            headers
        }, cancellation);
        if (response.ok) {
            const header = response.headers.get('X-Total-Count');
            return header ? (parseInt(header, 10) || 0) : 0;
        }
        else {
            throw new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
        }
    }
    exec(offset, count, predicate, sortBy, sortByDirection, query, customOptions, cancellation) {
        const repo = this;
        let error = null;
        let items = null;
        let index = 0;
        return {
            [Symbol.asyncIterator]() {
                return {
                    async next() {
                        if (cancellation) {
                            cancellation.throwIfCancelled();
                        }
                        if (null !== error) {
                            throw error;
                        }
                        if (!items) {
                            // Első next() meghívásakor ez fut le.
                            const headers = new Headers();
                            headers.append('Accept', 'application/json');
                            headers.append('X-Offset', String(offset));
                            headers.append('X-Count', String(count));
                            headers.append('X-Filter', predicate);
                            headers.append('X-Sort-By', sortBy || '');
                            headers.append('X-Sort-By-Direction', sortByDirection || '');
                            if (query && query.query) {
                                headers.append('X-Query', query.query);
                                headers.append('X-SearchType', query.type || 'partial');
                            }
                            const customKeys = Object.keys(customOptions || {});
                            customKeys.forEach((key) => {
                                const val = (customOptions || {})[key];
                                if (val) {
                                    headers.append(key, val);
                                }
                            });
                            // const response = await fetch(repo.collectionEndpoint, { headers, signal: abortion.signal });
                            const response = await repo.clientFactory().send({
                                uri: Uri.from(repo.collectionEndpoint),
                                headers
                            }, cancellation);
                            if (response.ok && response.content) {
                                items = await response.content.json();
                            }
                            else {
                                error = new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
                                throw error;
                            }
                        }
                        if (!items) {
                            throw new Error('should never happen');
                        }
                        if (index >= items.length) {
                            return { done: true, value: undefined };
                        }
                        const value = items[index];
                        ++index;
                        return { done: false, value };
                    }
                };
            }
        };
    }
}
const regex = /[\0-\x08\n-\x1F\x7F-\uFFFF]/g;
export class RestQuery extends Query {
    // tslint:disable-next-line:max-line-length
    constructor(repo, offset, count, predicate, sortBy, sortByDirection, customOptions, protocolVersion) {
        super();
        this.repo = repo;
        this.offset = offset || 0;
        this.count = 0 === count ? count : (count || RestQuery.defaultCount);
        this.predicate = predicate || null;
        this.sortBy = sortBy || '';
        this.sortByDirection = sortByDirection || QuerySortDirection.Asc;
        this.customOptions = customOptions || {};
        this.protocolVersion = protocolVersion || 2;
    }
    escape(input) {
        if (!input) {
            return '';
        }
        const inp = input instanceof Q.Expr ? this.applyProtocol(input).toString() : input;
        return utf8
            .utf8encode(inp)
            .replace(regex, (m) => '%' + ('0' + m.charCodeAt(0).toString(16).toUpperCase()).slice(-2));
    }
    applyProtocol(expr) {
        if (this.protocolVersion < 2 && expr instanceof Q.Lambda) {
            const param = expr.param;
            return expr.body.accept({
                visitConst(c) { return c; },
                visitParam(p) { return p; },
                // tslint:disable-next-line:max-line-length
                visitProp(p) { return p.instance.eq(param) ? new Q.Param(p.name) : new Q.Prop(p.instance.accept(this), p.name); },
                visitBinary(b) { return new Q.BinOp(b.left.accept(this), b.op, b.right.accept(this)); },
                visitUnary(u) { return new Q.UnOp(u.op, u.operand.accept(this)); },
                visitCall(c) { return new Q.Call(c.name, c.args.map((arg) => arg.accept(this))); },
                visitLambda(l) { return new Q.Lambda(l.body.accept(this), l.param); }
            });
        }
        return expr;
    }
    extractV1Query(expr) {
        const q = {};
        const v1Expr = expr.accept({
            visitConst(c) { return c; },
            visitParam(p) { return p; },
            visitProp(p) { return new Q.Prop(p.instance.accept(this), p.name); },
            visitBinary(b) {
                const l = b.left.accept(this);
                const r = b.right.accept(this);
                if (l instanceof Q.Const && (l.value === true || l.value === 'true')) {
                    return r;
                }
                if (r instanceof Q.Const && (r.value === true || r.value === 'true')) {
                    return l;
                }
                return new Q.BinOp(l, b.op, r);
            },
            visitUnary(u) { return new Q.UnOp(u.op, u.operand.accept(this)); },
            visitCall(c) {
                if ('partialMatch' === c.name && 2 === c.args.length) {
                    const arg = c.args[1];
                    if (arg instanceof Q.Const && arg.value) {
                        q.query = arg.value;
                        return new Q.Const(true);
                    }
                    throw new Error('not supported partial match in protocol v1');
                }
                return new Q.Call(c.name, c.args.map((arg) => arg.accept(this)));
            },
            visitLambda(l) { return new Q.Lambda(l.body.accept(this), l.param); }
        });
        return {
            expr: v1Expr,
            query: q
        };
    }
    get escapedPredicate() {
        return this.escape(this.predicate);
    }
    get escapedSortBy() {
        return this.escape(this.sortBy);
    }
    filter(predicate) {
        const p = 'string' === typeof predicate ? Q.parse(predicate) : predicate;
        if (!(p instanceof Q.Lambda)) {
            throw TypeError('predicate must be a lambda expression');
        }
        return new RestQuery(this.repo, this.offset, this.count, this.predicate ? this.predicate.and(p) : p, this.sortBy, this.sortByDirection, this.customOptions, this.protocolVersion);
    }
    skip(n) {
        if (0 === n) {
            return this;
        }
        checkNum(n, 'skip parameter must be non-negative whole number.');
        return new RestQuery(this.repo, n, // TODO: Ezt végig kell gondolni, mert lehet (this.offset + n) kellene ide?
        this.count, this.predicate, this.sortBy, this.sortByDirection, this.customOptions, this.protocolVersion);
    }
    take(n) {
        checkNum(n, 'take parameter must be non-negative whole number.');
        return new RestQuery(this.repo, this.offset, n, this.predicate, this.sortBy, this.sortByDirection, this.customOptions, this.protocolVersion);
    }
    orderBy(selector, direction) {
        return new RestQuery(this.repo, this.offset, this.count, this.predicate, selector, direction || QuerySortDirection.Asc, this.customOptions, this.protocolVersion);
    }
    setCustomOptions(options, replace) {
        const opts = replace ? (options || {}) : Object.assign({}, this.customOptions, options);
        return new RestQuery(this.repo, this.offset, this.count, this.predicate, this.sortBy, this.sortByDirection, opts, this.protocolVersion);
    }
    async total(cancellation) {
        let predicate;
        let v1Query;
        if (!this.predicate) {
            predicate = '';
        }
        else {
            if (this.protocolVersion < 2) {
                const data = this.extractV1Query(this.predicate);
                predicate = this.escape(data.expr);
                v1Query = data.query;
                if (predicate && predicate.startsWith('(') && predicate.endsWith(')')) {
                    predicate = predicate.substr(1, predicate.length - 2);
                }
            }
            else {
                predicate = this.escape(this.predicate);
            }
        }
        return this.repo.total(predicate, v1Query, this.customOptions, cancellation);
    }
    exec() {
        let predicate;
        let v1Query;
        if (!this.predicate) {
            predicate = '';
        }
        else {
            if (this.protocolVersion < 2) {
                const data = this.extractV1Query(this.predicate);
                predicate = this.escape(data.expr);
                v1Query = data.query;
                if (predicate && predicate.startsWith('(') && predicate.endsWith(')')) {
                    predicate = predicate.substr(1, predicate.length - 2);
                }
            }
            else {
                predicate = this.escape(this.predicate);
            }
        }
        // tslint:disable-next-line:max-line-length
        return this.repo.exec(this.offset, this.count, predicate, this.sortBy, this.sortByDirection, v1Query, this.customOptions);
    }
}
RestQuery.defaultCount = 100000;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQWMsa0JBQWtCLEVBQWlCLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEYsT0FBTyxLQUFLLENBQUMsTUFBTSxZQUFZLENBQUM7QUFDaEMsT0FBTyxFQUEyQixTQUFTLEVBQWdCLE1BQU0sdUJBQXVCLENBQUM7QUFDekYsT0FBTyxLQUFLLElBQUksTUFBTSxzQkFBc0IsQ0FBQztBQUU3QyxPQUFPLEVBQUUsVUFBVSxFQUFFLHVCQUF1QixFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDM0UsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLHFCQUFxQixDQUFDO0FBRTFDLE1BQU0sUUFBUSxHQUFHLENBQUMsQ0FBUyxFQUFFLE9BQWUsRUFBRSxFQUFFO0lBQzlDLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsRUFBRTtRQUN6QixNQUFNLElBQUksU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDO0tBQzlCO0FBQ0gsQ0FBQyxDQUFDO0FBb0NGLE1BQU0sT0FBTyxpQkFBaUI7SUFJNUIsWUFBWSxPQUE4QjtRQUN4QyxJQUFJLENBQUMsT0FBTyxHQUFHLE9BQU8sQ0FBQztRQUN2QixNQUFNLGtCQUFrQixHQUFHLHVCQUF1QixDQUFDLFVBQVUsQ0FBQyxDQUFDLE9BQU8sSUFBSSxPQUFPLENBQUMsYUFBYSxDQUFDLElBQUksTUFBTSxDQUFDLENBQUM7UUFDNUcsSUFBSSxDQUFDLGFBQWEsR0FBRyxHQUFHLEVBQUUsQ0FBQyxJQUFJLFVBQVUsQ0FBQyxrQkFBa0IsQ0FBQyxDQUFDO0lBQ2hFLENBQUM7SUFFRCxJQUFZLGtCQUFrQjtRQUM1QixPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxFQUFFLENBQUM7SUFDekMsQ0FBQztJQUVELElBQUksZUFBZTtRQUNqQixPQUFPLElBQUksQ0FBQyxPQUFPLENBQUMsZUFBZSxJQUFJLENBQUMsQ0FBQztJQUMzQyxDQUFDO0lBRUQsSUFBSSxJQUFJO1FBQ04sT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQztJQUMzQixDQUFDO0lBRUQsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQztJQUMvQixDQUFDO0lBRUQsSUFBSSxXQUFXO1FBQ2IsT0FBTyxJQUFJLENBQUMsT0FBTyxDQUFDLFdBQVcsSUFBSSxJQUFJLENBQUM7SUFDMUMsQ0FBQztJQUVELElBQUksS0FBSztRQUNQLDJDQUEyQztRQUMzQyxPQUFPLElBQUksU0FBUyxDQUFRLElBQUksRUFBRSxDQUFDLEVBQUUsU0FBUyxDQUFDLFlBQVksRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxFQUFFLEVBQUUsSUFBSSxDQUFDLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUM3SCxDQUFDO0lBRVMsTUFBTSxDQUFDLElBQVc7UUFDMUIsT0FBUSxJQUFZLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBUyxDQUFDO0lBQ2pELENBQUM7SUFFTyxNQUFNLENBQUMsSUFBVztRQUN4QixPQUFPLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzdCLENBQUM7SUFFTyxZQUFZLENBQUMsSUFBVztRQUM5QixPQUFPLEdBQUcsSUFBSSxDQUFDLFFBQVEsSUFBSSxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQztJQUM5RCxDQUFDO0lBRU8sVUFBVSxDQUFDLFFBQXNCO1FBQ3ZDLE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ25ELElBQUksUUFBUSxFQUFFO1lBQ1osT0FBTyxJQUFJLFNBQVMsQ0FBQyxRQUFRLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDMUM7UUFDRCxPQUFPLElBQUksU0FBUyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQVMsRUFBRSxZQUEyQjtRQUNqRCxNQUFNLEdBQUcsR0FBRyxHQUFHLElBQUksQ0FBQyxRQUFRLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUNuRCxPQUFPLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxPQUFPLENBQUMsR0FBRyxFQUFFLFlBQVksQ0FBQyxDQUFDO0lBQ3pELENBQUM7SUFFRCxLQUFLLENBQUMsTUFBTSxDQUFDLElBQVcsRUFBRSxZQUEyQjtRQUNuRCxJQUFJLENBQUMsSUFBSSxFQUFFO1lBQ1QsTUFBTSxJQUFJLFNBQVMsQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDO1NBQ3JEO1FBQ0QsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLEVBQVEsSUFBSSxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQ25HLElBQUksUUFBUSxDQUFDLEVBQUUsRUFBRTtZQUNmLE9BQU8sTUFBTSxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDM0Q7UUFDRCxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBVyxFQUFFLFlBQTBCO1FBQ2xELElBQUksQ0FBQyxJQUFJLEVBQUU7WUFDVCxNQUFNLElBQUksU0FBUyxDQUFDLDhCQUE4QixDQUFDLENBQUM7U0FDckQ7UUFDRCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixFQUFRLElBQUksRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNwRyxJQUFJLFFBQVEsQ0FBQyxFQUFFLEVBQUU7WUFDZixNQUFNLEdBQUcsR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsR0FBRyxFQUFFO2dCQUNSLE1BQU0sSUFBSSxLQUFLLENBQUMsdUNBQXVDLENBQUMsQ0FBQzthQUMxRDtZQUNELE9BQU8sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxHQUFHLEVBQUUsWUFBWSxDQUFDLENBQUM7U0FDeEQ7UUFDRCxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLENBQUM7SUFDbEMsQ0FBQztJQUVELEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBVyxFQUFFLFlBQTBCO1FBQ2xELE1BQU0sUUFBUSxHQUFHLE1BQU0sSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxFQUFFLFlBQVksQ0FBQyxDQUFDO1FBQzFGLElBQUksR0FBRyxLQUFLLFFBQVEsQ0FBQyxNQUFNLElBQUksR0FBRyxLQUFLLFFBQVEsQ0FBQyxNQUFNLElBQUksR0FBRyxLQUFLLFFBQVEsQ0FBQyxNQUFNLEVBQUU7WUFDakYsV0FBVztZQUNYLE9BQU87U0FDUjtRQUNELE1BQU0sSUFBSSxDQUFDLFVBQVUsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBRUQsMkNBQTJDO0lBQzNDLEtBQUssQ0FBQyxLQUFLLENBQUMsU0FBaUIsRUFBRSxLQUF3QixFQUFFLGFBQWtELEVBQUUsWUFBMEI7UUFDckksTUFBTSxPQUFPLEdBQUcsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUM5QixPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDO1FBQzdDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sQ0FBQyxNQUFNLENBQUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxDQUFDO1FBQy9CLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxLQUFLLEVBQUU7WUFDeEIsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBQ3ZDLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLENBQUM7U0FDekQ7UUFDRCxNQUFNLFVBQVUsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUNwRCxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7WUFDekIsTUFBTSxLQUFLLEdBQUcsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ2pDLElBQUksS0FBSyxFQUFFO2dCQUNULE9BQU8sQ0FBQyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxDQUFDO2FBQzVCO1FBQ0gsQ0FBQyxDQUFDLENBQUM7UUFDSCxNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUM7WUFDL0MsR0FBRyxFQUFFLElBQUksR0FBRyxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztZQUNyQyxPQUFPO1NBQ1IsRUFBRSxZQUFZLENBQUMsQ0FBQztRQUNqQixJQUFJLFFBQVEsQ0FBQyxFQUFFLEVBQUU7WUFDZixNQUFNLE1BQU0sR0FBRyxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUNyRCxPQUFPLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDakQ7YUFBTTtZQUNMLE1BQU0sSUFBSSxLQUFLLENBQUMsOENBQThDLFFBQVEsQ0FBQyxVQUFVLEVBQUUsQ0FBQyxDQUFDO1NBQ3RGO0lBQ0gsQ0FBQztJQUVELElBQUksQ0FDRixNQUFjLEVBQ2QsS0FBYSxFQUNiLFNBQWlCLEVBQ2pCLE1BQWUsRUFDZixlQUFvQyxFQUNwQyxLQUFlLEVBQ2YsYUFBbUQsRUFDbkQsWUFBMkI7UUFFM0IsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2xCLElBQUksS0FBSyxHQUFRLElBQUksQ0FBQztRQUN0QixJQUFJLEtBQUssR0FBaUIsSUFBSSxDQUFDO1FBQy9CLElBQUksS0FBSyxHQUFHLENBQUMsQ0FBQztRQUNkLE9BQU87WUFDTCxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUM7Z0JBQ3BCLE9BQU87b0JBQ0wsS0FBSyxDQUFDLElBQUk7d0JBQ1IsSUFBSSxZQUFZLEVBQUU7NEJBQ2hCLFlBQVksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO3lCQUNqQzt3QkFDRCxJQUFJLElBQUksS0FBSyxLQUFLLEVBQUU7NEJBQ2xCLE1BQU0sS0FBSyxDQUFDO3lCQUNiO3dCQUNELElBQUksQ0FBQyxLQUFLLEVBQUU7NEJBQ1Ysc0NBQXNDOzRCQUN0QyxNQUFNLE9BQU8sR0FBRyxJQUFJLE9BQU8sRUFBRSxDQUFDOzRCQUM5QixPQUFPLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxrQkFBa0IsQ0FBQyxDQUFDOzRCQUM3QyxPQUFPLENBQUMsTUFBTSxDQUFDLFVBQVUsRUFBRSxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQzs0QkFDM0MsT0FBTyxDQUFDLE1BQU0sQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUM7NEJBQ3pDLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxFQUFFLFNBQVMsQ0FBQyxDQUFDOzRCQUN0QyxPQUFPLENBQUMsTUFBTSxDQUFDLFdBQVcsRUFBRSxNQUFNLElBQUksRUFBRSxDQUFDLENBQUM7NEJBQzFDLE9BQU8sQ0FBQyxNQUFNLENBQUMscUJBQXFCLEVBQUUsZUFBZSxJQUFJLEVBQUUsQ0FBQyxDQUFDOzRCQUM3RCxJQUFJLEtBQUssSUFBSSxLQUFLLENBQUMsS0FBSyxFQUFFO2dDQUN4QixPQUFPLENBQUMsTUFBTSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUM7Z0NBQ3ZDLE9BQU8sQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksU0FBUyxDQUFDLENBQUM7NkJBQ3pEOzRCQUNELE1BQU0sVUFBVSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQyxDQUFDOzRCQUNwRCxVQUFVLENBQUMsT0FBTyxDQUFDLENBQUMsR0FBRyxFQUFFLEVBQUU7Z0NBQ3pCLE1BQU0sR0FBRyxHQUFHLENBQUMsYUFBYSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dDQUN2QyxJQUFJLEdBQUcsRUFBRTtvQ0FDUCxPQUFPLENBQUMsTUFBTSxDQUFDLEdBQUcsRUFBRSxHQUFHLENBQUMsQ0FBQztpQ0FDMUI7NEJBQ0gsQ0FBQyxDQUFDLENBQUM7NEJBQ0gsK0ZBQStGOzRCQUMvRixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQyxJQUFJLENBQUM7Z0NBQy9DLEdBQUcsRUFBRSxHQUFHLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQztnQ0FDdEMsT0FBTzs2QkFDUixFQUFFLFlBQVksQ0FBQyxDQUFDOzRCQUNqQixJQUFJLFFBQVEsQ0FBQyxFQUFFLElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRTtnQ0FDbkMsS0FBSyxHQUFHLE1BQU0sUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQzs2QkFDdkM7aUNBQU07Z0NBQ0wsS0FBSyxHQUFHLElBQUksS0FBSyxDQUFDLDhDQUE4QyxRQUFRLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQztnQ0FDdkYsTUFBTSxLQUFLLENBQUM7NkJBQ2I7eUJBQ0Y7d0JBQ0QsSUFBSSxDQUFDLEtBQUssRUFBRTs0QkFDVixNQUFNLElBQUksS0FBSyxDQUFDLHFCQUFxQixDQUFDLENBQUM7eUJBQ3hDO3dCQUNELElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxNQUFNLEVBQUU7NEJBQ3pCLE9BQU8sRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBUSxTQUFTLEVBQUUsQ0FBQzt5QkFDL0M7d0JBQ0QsTUFBTSxLQUFLLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO3dCQUMzQixFQUFFLEtBQUssQ0FBQzt3QkFDUixPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxLQUFLLEVBQUUsQ0FBQztvQkFDaEMsQ0FBQztpQkFDRixDQUFDO1lBQ0osQ0FBQztTQUNGLENBQUM7SUFDSixDQUFDO0NBQ0Y7QUFFRCxNQUFNLEtBQUssR0FBRyw4QkFBOEIsQ0FBQztBQUU3QyxNQUFNLE9BQU8sU0FBYSxTQUFRLEtBQVE7SUFVeEMsMkNBQTJDO0lBQzNDLFlBQVksSUFBdUIsRUFBRSxNQUFjLEVBQUUsS0FBYSxFQUFFLFNBQXlCLEVBQUUsTUFBZSxFQUFFLGVBQW9DLEVBQUUsYUFBbUQsRUFBRSxlQUF3QjtRQUNqTyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDO1FBQ2pCLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxJQUFJLENBQUMsQ0FBQztRQUMxQixJQUFJLENBQUMsS0FBSyxHQUFHLENBQUMsS0FBSyxLQUFLLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLElBQUksU0FBUyxDQUFDLFlBQVksQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxTQUFTLEdBQUcsU0FBUyxJQUFJLElBQUksQ0FBQztRQUNuQyxJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sSUFBSSxFQUFFLENBQUM7UUFDM0IsSUFBSSxDQUFDLGVBQWUsR0FBRyxlQUFlLElBQUksa0JBQWtCLENBQUMsR0FBRyxDQUFDO1FBQ2pFLElBQUksQ0FBQyxhQUFhLEdBQUcsYUFBYSxJQUFJLEVBQUUsQ0FBQztRQUN6QyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsSUFBSSxDQUFDLENBQUM7SUFDOUMsQ0FBQztJQUNPLE1BQU0sQ0FBQyxLQUF5QjtRQUN0QyxJQUFJLENBQUMsS0FBSyxFQUFFO1lBQ1YsT0FBTyxFQUFFLENBQUM7U0FDWDtRQUNELE1BQU0sR0FBRyxHQUFHLEtBQUssWUFBWSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsRUFBRSxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUM7UUFDbkYsT0FBTyxJQUFJO2FBQ1IsVUFBVSxDQUFDLEdBQUcsQ0FBQzthQUNmLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDL0YsQ0FBQztJQUVPLGFBQWEsQ0FBQyxJQUFZO1FBQ2hDLElBQUksSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLElBQUksSUFBSSxZQUFZLENBQUMsQ0FBQyxNQUFNLEVBQUU7WUFDeEQsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQztZQUN6QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFTO2dCQUM5QixVQUFVLENBQUMsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDM0IsVUFBVSxDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQzNCLDJDQUEyQztnQkFDM0MsU0FBUyxDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQU8sQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztnQkFDdkgsV0FBVyxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN2RixVQUFVLENBQUMsQ0FBQyxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7Z0JBQ2xFLFNBQVMsQ0FBQyxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUNsRixXQUFXLENBQUMsQ0FBQyxJQUFJLE9BQU8sSUFBSSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDdEUsQ0FBQyxDQUFDO1NBQ0o7UUFDRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFTyxjQUFjLENBQUMsSUFBWTtRQUNqQyxNQUFNLENBQUMsR0FBdUIsRUFBRSxDQUFDO1FBQ2pDLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxNQUFNLENBQVM7WUFDakMsVUFBVSxDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsVUFBVSxDQUFDLENBQUMsSUFBSSxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDM0IsU0FBUyxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BFLFdBQVcsQ0FBQyxDQUFDO2dCQUNYLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUM5QixNQUFNLENBQUMsR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztnQkFDL0IsSUFBSSxDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssSUFBSSxDQUFPLENBQUMsQ0FBQyxLQUFLLEtBQUssSUFBSSxJQUFVLENBQUMsQ0FBQyxLQUFLLEtBQUssTUFBTSxDQUFDLEVBQUU7b0JBQzlFLE9BQU8sQ0FBQyxDQUFDO2lCQUNaO2dCQUNELElBQUksQ0FBQyxZQUFZLENBQUMsQ0FBQyxLQUFLLElBQUksQ0FBTyxDQUFDLENBQUMsS0FBSyxLQUFLLElBQUksSUFBVSxDQUFDLENBQUMsS0FBSyxLQUFLLE1BQU0sQ0FBQyxFQUFFO29CQUM5RSxPQUFPLENBQUMsQ0FBQztpQkFDWjtnQkFDRCxPQUFPLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUNqQyxDQUFDO1lBQ0QsVUFBVSxDQUFDLENBQUMsSUFBSSxPQUFPLElBQUksQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ2xFLFNBQVMsQ0FBQyxDQUFDO2dCQUNULElBQUksY0FBYyxLQUFLLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxJQUFJLENBQUMsTUFBTSxFQUFFO29CQUNwRCxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO29CQUN0QixJQUFJLEdBQUcsWUFBWSxDQUFDLENBQUMsS0FBSyxJQUFJLEdBQUcsQ0FBQyxLQUFLLEVBQUU7d0JBQ3ZDLENBQUMsQ0FBQyxLQUFLLEdBQUcsR0FBRyxDQUFDLEtBQUssQ0FBQzt3QkFDcEIsT0FBTyxJQUFJLENBQUMsQ0FBQyxLQUFLLENBQU8sSUFBSSxDQUFDLENBQUM7cUJBQ2hDO29CQUNELE1BQU0sSUFBSSxLQUFLLENBQUMsNENBQTRDLENBQUMsQ0FBQztpQkFDL0Q7Z0JBQ0QsT0FBTyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsR0FBRyxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDbkUsQ0FBQztZQUNELFdBQVcsQ0FBQyxDQUFDLElBQUksT0FBTyxJQUFJLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztTQUN0RSxDQUFDLENBQUM7UUFDSCxPQUFPO1lBQ0gsSUFBSSxFQUFFLE1BQU07WUFDWixLQUFLLEVBQUUsQ0FBQztTQUNYLENBQUM7SUFDSixDQUFDO0lBRUQsSUFBSSxnQkFBZ0I7UUFDbEIsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztJQUNyQyxDQUFDO0lBQ0QsSUFBSSxhQUFhO1FBQ2YsT0FBTyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUNsQyxDQUFDO0lBQ0QsTUFBTSxDQUFDLFNBQTBCO1FBQy9CLE1BQU0sQ0FBQyxHQUFHLFFBQVEsS0FBSyxPQUFPLFNBQVMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxDQUFDO1FBQ3pFLElBQUksQ0FBQyxDQUFDLENBQUMsWUFBWSxDQUFDLENBQUMsTUFBTSxDQUFDLEVBQUU7WUFDNUIsTUFBTSxTQUFTLENBQUMsdUNBQXVDLENBQUMsQ0FBQztTQUMxRDtRQUNELE9BQU8sSUFBSSxTQUFTLENBQ2xCLElBQUksQ0FBQyxJQUFJLEVBQ1QsSUFBSSxDQUFDLE1BQU0sRUFDWCxJQUFJLENBQUMsS0FBSyxFQUNWLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQzFDLElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLGVBQWUsRUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFDbEIsSUFBSSxDQUFDLGVBQWUsQ0FDckIsQ0FBQztJQUNKLENBQUM7SUFDRCxJQUFJLENBQUMsQ0FBUztRQUNaLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtZQUNYLE9BQU8sSUFBSSxDQUFDO1NBQ2I7UUFDRCxRQUFRLENBQUMsQ0FBQyxFQUFFLG1EQUFtRCxDQUFDLENBQUM7UUFDakUsT0FBTyxJQUFJLFNBQVMsQ0FDbEIsSUFBSSxDQUFDLElBQUksRUFDVCxDQUFDLEVBQUUsMkVBQTJFO1FBQzlFLElBQUksQ0FBQyxLQUFLLEVBQ1YsSUFBSSxDQUFDLFNBQVMsRUFDZCxJQUFJLENBQUMsTUFBTSxFQUNYLElBQUksQ0FBQyxlQUFlLEVBQ3BCLElBQUksQ0FBQyxhQUFhLEVBQ2xCLElBQUksQ0FBQyxlQUFlLENBQ3JCLENBQUM7SUFDSixDQUFDO0lBQ0QsSUFBSSxDQUFDLENBQVM7UUFDWixRQUFRLENBQUMsQ0FBQyxFQUFFLG1EQUFtRCxDQUFDLENBQUM7UUFDakUsT0FBTyxJQUFJLFNBQVMsQ0FDbEIsSUFBSSxDQUFDLElBQUksRUFDVCxJQUFJLENBQUMsTUFBTSxFQUNYLENBQUMsRUFDRCxJQUFJLENBQUMsU0FBUyxFQUNkLElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLGVBQWUsRUFDcEIsSUFBSSxDQUFDLGFBQWEsRUFDbEIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzFCLENBQUM7SUFDRCxPQUFPLENBQUMsUUFBZ0IsRUFBRSxTQUE4QjtRQUN0RCxPQUFPLElBQUksU0FBUyxDQUNsQixJQUFJLENBQUMsSUFBSSxFQUNULElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLEtBQUssRUFDVixJQUFJLENBQUMsU0FBUyxFQUNkLFFBQVEsRUFDUixTQUFTLElBQUksa0JBQWtCLENBQUMsR0FBRyxFQUNuQyxJQUFJLENBQUMsYUFBYSxFQUNsQixJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDMUIsQ0FBQztJQUNELGdCQUFnQixDQUFDLE9BQTRDLEVBQUUsT0FBaUI7UUFDOUUsTUFBTSxJQUFJLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLEVBQUUsSUFBSSxDQUFDLGFBQWEsRUFBRSxPQUFPLENBQUMsQ0FBQztRQUN4RixPQUFPLElBQUksU0FBUyxDQUNsQixJQUFJLENBQUMsSUFBSSxFQUNULElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLEtBQUssRUFDVixJQUFJLENBQUMsU0FBUyxFQUNkLElBQUksQ0FBQyxNQUFNLEVBQ1gsSUFBSSxDQUFDLGVBQWUsRUFDcEIsSUFBSSxFQUNKLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQUMxQixDQUFDO0lBQ0QsS0FBSyxDQUFDLEtBQUssQ0FBQyxZQUEwQjtRQUNwQyxJQUFJLFNBQWlCLENBQUM7UUFDdEIsSUFBSSxPQUEwQixDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLFNBQVMsR0FBRyxFQUFFLENBQUM7U0FDaEI7YUFBTTtZQUNMLElBQUksSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLEVBQUU7Z0JBQzVCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNqRCxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ25DLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNyQixJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3JFLFNBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUN2RDthQUNGO2lCQUFNO2dCQUNMLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUN6QztTQUNGO1FBQ0QsT0FBTyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDL0UsQ0FBQztJQUNELElBQUk7UUFDRixJQUFJLFNBQWlCLENBQUM7UUFDdEIsSUFBSSxPQUEwQixDQUFDO1FBQy9CLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFO1lBQ25CLFNBQVMsR0FBRyxFQUFFLENBQUM7U0FDaEI7YUFBTTtZQUNMLElBQUksSUFBSSxDQUFDLGVBQWUsR0FBRyxDQUFDLEVBQUU7Z0JBQzVCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDO2dCQUNqRCxTQUFTLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUM7Z0JBQ25DLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO2dCQUNyQixJQUFJLFNBQVMsSUFBSSxTQUFTLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLEVBQUU7b0JBQ3JFLFNBQVMsR0FBRyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxTQUFTLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUN2RDthQUNGO2lCQUFNO2dCQUNMLFNBQVMsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQzthQUN6QztTQUNGO1FBQ0QsMkNBQTJDO1FBQzNDLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxFQUFFLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxlQUFlLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxhQUFhLENBQUMsQ0FBQztJQUM1SCxDQUFDOztBQXBNTSxzQkFBWSxHQUFHLE1BQU0sQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFF1ZXJ5LCBSZXBvc2l0b3J5LCBRdWVyeVNvcnREaXJlY3Rpb24sIEtleVJlcG9zaXRvcnkgfSBmcm9tICcuL3JlcG9zaXRvcmllcyc7XG5pbXBvcnQgKiBhcyBRIGZyb20gJy4vcHJvdG9jb2wnO1xuaW1wb3J0IHsgZGVjb3JhdGVkRmV0Y2ggYXMgZmV0Y2gsIEh0dHBFcnJvciwgUmVzcG9uc2VMaWtlIH0gZnJvbSAnZG9wZWVzLWNvcmUvbGliL2ZldGNoJztcbmltcG9ydCAqIGFzIHV0ZjggZnJvbSAnZG9wZWVzLWNvcmUvbGliL3V0ZjgnO1xuaW1wb3J0IHsgQ2FuY2VsbGF0aW9uIH0gZnJvbSAnZG9wZWVzLWNvcmUvbGliL2NhbmNlbGxhdGlvbic7XG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBodHRwQ2xpZW50Q29uZmlndXJhdGlvbiB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi9odHRwJztcbmltcG9ydCB7IFVyaSB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi91cmknO1xuXG5jb25zdCBjaGVja051bSA9IChuOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZykgPT4ge1xuICBpZiAobiAlIDEgIT09IDAgfHwgbiA8PSAwKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihtZXNzYWdlKTtcbiAgfVxufTtcblxuaW50ZXJmYWNlIFJlc3RSZXBvc2l0b3J5T3B0aW9ucyB7XG4gIHR5cGU6IHN0cmluZztcbiAgZW5kcG9pbnQ6IHN0cmluZztcbiAga2V5UHJvcGVydHk/OiBzdHJpbmc7XG4gIHByb3RvY29sVmVyc2lvbj86IG51bWJlcjtcbiAgY29uZmlndXJhdGlvbj86IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBWMVF1ZXJ5IHtcbiAgcXVlcnk/OiBzdHJpbmc7XG4gIHR5cGU/OiBzdHJpbmc7XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzdFJlcG9zaXRvcnk8VD4gZXh0ZW5kcyBSZXBvc2l0b3J5PFQ+IHtcbiAgZXhlYyhcbiAgICBvZmZzZXQ6IG51bWJlcixcbiAgICBjb3VudDogbnVtYmVyLFxuICAgIHByZWRpY2F0ZTogc3RyaW5nLFxuICAgIHNvcnRCeT86IHN0cmluZyxcbiAgICBzb3J0QnlEaXJlY3Rpb24/OlxuICAgIFF1ZXJ5U29ydERpcmVjdGlvbixcbiAgICBxdWVyeT86IFYxUXVlcnksXG4gICAgY3VzdG9tT3B0aW9ucz86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfHVuZGVmaW5lZCB9LFxuICAgIGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvblxuICApOiBBc3luY0l0ZXJhYmxlPFQ+O1xuXG4gIHRvdGFsKFxuICAgIHByZWRpY2F0ZTogc3RyaW5nLFxuICAgIHF1ZXJ5OiBWMVF1ZXJ5fHVuZGVmaW5lZCxcbiAgICBjdXN0b21PcHRpb25zOiB7IFtrZXk6IHN0cmluZ106IHN0cmluZ3x1bmRlZmluZWQgfSxcbiAgICBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvblxuICApOiBQcm9taXNlPG51bWJlcj47XG59XG5cbmV4cG9ydCBjbGFzcyBLZXlSZXN0UmVwb3NpdG9yeTxURGF0YSwgVEtleT4gaW1wbGVtZW50cyBLZXlSZXBvc2l0b3J5PFREYXRhLCBUS2V5PiwgUmVzdFJlcG9zaXRvcnk8VERhdGE+IHtcbiAgcmVhZG9ubHkgY2xpZW50RmFjdG9yeTogKCkgPT4gSHR0cENsaWVudDtcbiAgcmVhZG9ubHkgb3B0aW9uczogUmVzdFJlcG9zaXRvcnlPcHRpb25zO1xuXG4gIGNvbnN0cnVjdG9yKG9wdGlvbnM6IFJlc3RSZXBvc2l0b3J5T3B0aW9ucykge1xuICAgIHRoaXMub3B0aW9ucyA9IG9wdGlvbnM7XG4gICAgY29uc3QgcmVzdE1lc3NhZ2VIYW5kbGVyID0gaHR0cENsaWVudENvbmZpZ3VyYXRpb24uZ2V0SGFuZGxlcigob3B0aW9ucyAmJiBvcHRpb25zLmNvbmZpZ3VyYXRpb24pIHx8ICdyZXN0Jyk7XG4gICAgdGhpcy5jbGllbnRGYWN0b3J5ID0gKCkgPT4gbmV3IEh0dHBDbGllbnQocmVzdE1lc3NhZ2VIYW5kbGVyKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0IGNvbGxlY3Rpb25FbmRwb2ludCgpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5lbmRwb2ludH0vJHt0aGlzLnR5cGV9YDtcbiAgfVxuXG4gIGdldCBwcm90b2NvbFZlcnNpb24oKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5wcm90b2NvbFZlcnNpb24gfHwgMjtcbiAgfVxuXG4gIGdldCB0eXBlKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMudHlwZTtcbiAgfVxuXG4gIGdldCBlbmRwb2ludCgpIHtcbiAgICByZXR1cm4gdGhpcy5vcHRpb25zLmVuZHBvaW50O1xuICB9XG5cbiAgZ2V0IGtleVByb3BlcnR5KCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMua2V5UHJvcGVydHkgfHwgJ2lkJztcbiAgfVxuXG4gIGdldCBpdGVtcygpOiBRdWVyeTxURGF0YT4ge1xuICAgIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxURGF0YT4odGhpcywgMCwgUmVzdFF1ZXJ5LmRlZmF1bHRDb3VudCwgbnVsbCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHt9LCB0aGlzLm9wdGlvbnMucHJvdG9jb2xWZXJzaW9uKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRLZXkoaXRlbTogVERhdGEpIHtcbiAgICByZXR1cm4gKGl0ZW0gYXMgYW55KVt0aGlzLmtleVByb3BlcnR5XSBhcyBUS2V5O1xuICB9XG5cbiAgcHJpdmF0ZSBoYXNLZXkoaXRlbTogVERhdGEpIHtcbiAgICByZXR1cm4gISF0aGlzLmdldEtleShpdGVtKTtcbiAgfVxuXG4gIHByaXZhdGUgaXRlbUVuZHBvaW50KGl0ZW06IFREYXRhKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuZW5kcG9pbnR9LyR7dGhpcy50eXBlfS8ke3RoaXMuZ2V0S2V5KGl0ZW0pfWA7XG4gIH1cblxuICBwcml2YXRlIF9fZ2V0RXJyb3IocmVzcG9uc2U6IFJlc3BvbnNlTGlrZSk6IEh0dHBFcnJvciB7XG4gICAgY29uc3QgbWVzc2FnZXMgPSByZXNwb25zZS5oZWFkZXJzLmdldCgnWC1NZXNzYWdlJyk7XG4gICAgaWYgKG1lc3NhZ2VzKSB7XG4gICAgICByZXR1cm4gbmV3IEh0dHBFcnJvcihyZXNwb25zZSwgbWVzc2FnZXMpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IEh0dHBFcnJvcihyZXNwb25zZSk7XG4gIH1cblxuICBhc3luYyBsb29rdXAoa2V5OiBUS2V5LCBjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFREYXRhPiB7XG4gICAgY29uc3QgdXJpID0gYCR7dGhpcy5lbmRwb2ludH0vJHt0aGlzLnR5cGV9LyR7a2V5fWA7XG4gICAgcmV0dXJuIHRoaXMuY2xpZW50RmFjdG9yeSgpLmdldEpzb24odXJpLCBjYW5jZWxsYXRpb24pO1xuICB9XG5cbiAgYXN5bmMgdXBkYXRlKGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFREYXRhPiB7XG4gICAgaWYgKCFpdGVtKSB7XG4gICAgICB0aHJvdyBuZXcgVHlwZUVycm9yKCd1bmFibGUgdG8gdXBkYXRlIGVtcHR5IHZhbHVlJyk7XG4gICAgfVxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgdGhpcy5jbGllbnRGYWN0b3J5KCkucHV0KHRoaXMuaXRlbUVuZHBvaW50KGl0ZW0pLCA8YW55PiBpdGVtLCBjYW5jZWxsYXRpb24pO1xuICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMubG9va3VwKHRoaXMuZ2V0S2V5KGl0ZW0pLCBjYW5jZWxsYXRpb24pO1xuICAgIH1cbiAgICB0aHJvdyB0aGlzLl9fZ2V0RXJyb3IocmVzcG9uc2UpO1xuICB9XG5cbiAgYXN5bmMgaW5zZXJ0KGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+IHtcbiAgICBpZiAoIWl0ZW0pIHtcbiAgICAgIHRocm93IG5ldyBUeXBlRXJyb3IoJ3VuYWJsZSB0byBpbnNlcnQgZW1wdHkgdmFsdWUnKTtcbiAgICB9XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudEZhY3RvcnkoKS5wb3N0KHRoaXMuY29sbGVjdGlvbkVuZHBvaW50LCA8YW55PiBpdGVtLCBjYW5jZWxsYXRpb24pO1xuICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgY29uc3QgdXJpID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ0xvY2F0aW9uJyk7XG4gICAgICBpZiAoIXVyaSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Jlc3QgaW5zZXJ0IGRpZCBub3QgcmV0dXJuIGEgbG9jYXRpb24nKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB0aGlzLmNsaWVudEZhY3RvcnkoKS5nZXRKc29uKHVyaSwgY2FuY2VsbGF0aW9uKTtcbiAgICB9XG4gICAgdGhyb3cgdGhpcy5fX2dldEVycm9yKHJlc3BvbnNlKTtcbiAgfVxuXG4gIGFzeW5jIHJlbW92ZShpdGVtOiBURGF0YSwgY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHRoaXMuY2xpZW50RmFjdG9yeSgpLmRlbGV0ZSh0aGlzLml0ZW1FbmRwb2ludChpdGVtKSwgY2FuY2VsbGF0aW9uKTtcbiAgICBpZiAoMjAwID09PSByZXNwb25zZS5zdGF0dXMgfHwgMjAyID09PSByZXNwb25zZS5zdGF0dXMgfHwgMjA0ID09PSByZXNwb25zZS5zdGF0dXMpIHtcbiAgICAgIC8vIHN1Y2Nlc3M7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRocm93IHRoaXMuX19nZXRFcnJvcihyZXNwb25zZSk7XG4gIH1cblxuICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gIGFzeW5jIHRvdGFsKHByZWRpY2F0ZTogc3RyaW5nLCBxdWVyeTogVjFRdWVyeXx1bmRlZmluZWQsIGN1c3RvbU9wdGlvbnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfHVuZGVmaW5lZCB9LCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIZWFkZXJzKCk7XG4gICAgaGVhZGVycy5hcHBlbmQoJ0FjY2VwdCcsICdhcHBsaWNhdGlvbi9qc29uJyk7XG4gICAgaGVhZGVycy5hcHBlbmQoJ1gtRmlsdGVyJywgcHJlZGljYXRlKTtcbiAgICBoZWFkZXJzLmFwcGVuZCgnWC1Db3VudCcsICcwJyk7XG4gICAgaWYgKHF1ZXJ5ICYmIHF1ZXJ5LnF1ZXJ5KSB7XG4gICAgICBoZWFkZXJzLmFwcGVuZCgnWC1RdWVyeScsIHF1ZXJ5LnF1ZXJ5KTtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLVNlYXJjaFR5cGUnLCBxdWVyeS50eXBlIHx8ICdwYXJ0aWFsJyk7XG4gICAgfVxuICAgIGNvbnN0IGN1c3RvbUtleXMgPSBPYmplY3Qua2V5cyhjdXN0b21PcHRpb25zIHx8IHt9KTtcbiAgICBjdXN0b21LZXlzLmZvckVhY2goKGtleSkgPT4ge1xuICAgICAgY29uc3QgdmFsdWUgPSBjdXN0b21PcHRpb25zW2tleV07XG4gICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgaGVhZGVycy5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCB0aGlzLmNsaWVudEZhY3RvcnkoKS5zZW5kKHtcbiAgICAgIHVyaTogbmV3IFVyaSh0aGlzLmNvbGxlY3Rpb25FbmRwb2ludCksXG4gICAgICBoZWFkZXJzXG4gICAgfSwgY2FuY2VsbGF0aW9uKTtcbiAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgIGNvbnN0IGhlYWRlciA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdYLVRvdGFsLUNvdW50Jyk7XG4gICAgICByZXR1cm4gaGVhZGVyID8gKHBhcnNlSW50KGhlYWRlciwgMTApIHx8IDApIDogMDtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBIaWJhIGzDqXBldHQgZmVsIGFkYXRvayBsZWvDqXJkZXrDqXNlIGvDtnpiZW46ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICB9XG4gIH1cblxuICBleGVjKFxuICAgIG9mZnNldDogbnVtYmVyLFxuICAgIGNvdW50OiBudW1iZXIsXG4gICAgcHJlZGljYXRlOiBzdHJpbmcsXG4gICAgc29ydEJ5Pzogc3RyaW5nLFxuICAgIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbixcbiAgICBxdWVyeT86IFYxUXVlcnksXG4gICAgY3VzdG9tT3B0aW9ucz86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfHVuZGVmaW5lZCB9LFxuICAgIGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvblxuICApOiBBc3luY0l0ZXJhYmxlPFREYXRhPiB7XG4gICAgY29uc3QgcmVwbyA9IHRoaXM7XG4gICAgbGV0IGVycm9yOiBhbnkgPSBudWxsO1xuICAgIGxldCBpdGVtczogVERhdGFbXXxudWxsID0gbnVsbDtcbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIHJldHVybiB7XG4gICAgICBbU3ltYm9sLmFzeW5jSXRlcmF0b3JdKCk6IEFzeW5jSXRlcmF0b3I8VERhdGE+IHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBhc3luYyBuZXh0KCk6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VERhdGE+PiB7XG4gICAgICAgICAgICBpZiAoY2FuY2VsbGF0aW9uKSB7XG4gICAgICAgICAgICAgIGNhbmNlbGxhdGlvbi50aHJvd0lmQ2FuY2VsbGVkKCk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAobnVsbCAhPT0gZXJyb3IpIHtcbiAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoIWl0ZW1zKSB7XG4gICAgICAgICAgICAgIC8vIEVsc8WRIG5leHQoKSBtZWdow612w6FzYWtvciBleiBmdXQgbGUuXG4gICAgICAgICAgICAgIGNvbnN0IGhlYWRlcnMgPSBuZXcgSGVhZGVycygpO1xuICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnQWNjZXB0JywgJ2FwcGxpY2F0aW9uL2pzb24nKTtcbiAgICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtT2Zmc2V0JywgU3RyaW5nKG9mZnNldCkpO1xuICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1Db3VudCcsIFN0cmluZyhjb3VudCkpO1xuICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1GaWx0ZXInLCBwcmVkaWNhdGUpO1xuICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1Tb3J0LUJ5Jywgc29ydEJ5IHx8ICcnKTtcbiAgICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtU29ydC1CeS1EaXJlY3Rpb24nLCBzb3J0QnlEaXJlY3Rpb24gfHwgJycpO1xuICAgICAgICAgICAgICBpZiAocXVlcnkgJiYgcXVlcnkucXVlcnkpIHtcbiAgICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1RdWVyeScsIHF1ZXJ5LnF1ZXJ5KTtcbiAgICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1TZWFyY2hUeXBlJywgcXVlcnkudHlwZSB8fCAncGFydGlhbCcpO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIGNvbnN0IGN1c3RvbUtleXMgPSBPYmplY3Qua2V5cyhjdXN0b21PcHRpb25zIHx8IHt9KTtcbiAgICAgICAgICAgICAgY3VzdG9tS2V5cy5mb3JFYWNoKChrZXkpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB2YWwgPSAoY3VzdG9tT3B0aW9ucyB8fCB7fSlba2V5XTtcbiAgICAgICAgICAgICAgICBpZiAodmFsKSB7XG4gICAgICAgICAgICAgICAgICBoZWFkZXJzLmFwcGVuZChrZXksIHZhbCk7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgLy8gY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChyZXBvLmNvbGxlY3Rpb25FbmRwb2ludCwgeyBoZWFkZXJzLCBzaWduYWw6IGFib3J0aW9uLnNpZ25hbCB9KTtcbiAgICAgICAgICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCByZXBvLmNsaWVudEZhY3RvcnkoKS5zZW5kKHtcbiAgICAgICAgICAgICAgICB1cmk6IFVyaS5mcm9tKHJlcG8uY29sbGVjdGlvbkVuZHBvaW50KSxcbiAgICAgICAgICAgICAgICBoZWFkZXJzXG4gICAgICAgICAgICAgIH0sIGNhbmNlbGxhdGlvbik7XG4gICAgICAgICAgICAgIGlmIChyZXNwb25zZS5vayAmJiByZXNwb25zZS5jb250ZW50KSB7XG4gICAgICAgICAgICAgICAgaXRlbXMgPSBhd2FpdCByZXNwb25zZS5jb250ZW50Lmpzb24oKTtcbiAgICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcihgSGliYSBsw6lwZXR0IGZlbCBhZGF0b2sgbGVrw6lyZGV6w6lzZSBrw7Z6YmVuOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XG4gICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXRlbXMpIHtcbiAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzaG91bGQgbmV2ZXIgaGFwcGVuJyk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAoaW5kZXggPj0gaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgICAgIHJldHVybiB7IGRvbmU6IHRydWUsIHZhbHVlOiA8YW55PiB1bmRlZmluZWQgfTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGNvbnN0IHZhbHVlID0gaXRlbXNbaW5kZXhdO1xuICAgICAgICAgICAgKytpbmRleDtcbiAgICAgICAgICAgIHJldHVybiB7IGRvbmU6IGZhbHNlLCB2YWx1ZSB9O1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9O1xuICB9XG59XG5cbmNvbnN0IHJlZ2V4ID0gL1tcXDAtXFx4MDhcXG4tXFx4MUZcXHg3Ri1cXHVGRkZGXS9nO1xuXG5leHBvcnQgY2xhc3MgUmVzdFF1ZXJ5PFQ+IGV4dGVuZHMgUXVlcnk8VD4ge1xuICBzdGF0aWMgZGVmYXVsdENvdW50ID0gMTAwMDAwO1xuICByZWFkb25seSByZXBvOiBSZXN0UmVwb3NpdG9yeTxUPjtcbiAgcmVhZG9ubHkgb2Zmc2V0OiBudW1iZXI7XG4gIHJlYWRvbmx5IGNvdW50OiBudW1iZXI7XG4gIHJlYWRvbmx5IHByZWRpY2F0ZTogUS5MYW1iZGF8bnVsbDtcbiAgcmVhZG9ubHkgc29ydEJ5OiBzdHJpbmc7XG4gIHJlYWRvbmx5IHNvcnRCeURpcmVjdGlvbjogUXVlcnlTb3J0RGlyZWN0aW9uO1xuICByZWFkb25seSBwcm90b2NvbFZlcnNpb246IG51bWJlcjtcbiAgcmVhZG9ubHkgY3VzdG9tT3B0aW9uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmd8dW5kZWZpbmVkIH07XG4gIC8vIHRzbGludDpkaXNhYmxlLW5leHQtbGluZTptYXgtbGluZS1sZW5ndGhcbiAgY29uc3RydWN0b3IocmVwbzogUmVzdFJlcG9zaXRvcnk8VD4sIG9mZnNldDogbnVtYmVyLCBjb3VudDogbnVtYmVyLCBwcmVkaWNhdGU/OiBRLkxhbWJkYXxudWxsLCBzb3J0Qnk/OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbiwgY3VzdG9tT3B0aW9ucz86IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfHVuZGVmaW5lZCB9LCBwcm90b2NvbFZlcnNpb24/OiBudW1iZXIpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMucmVwbyA9IHJlcG87XG4gICAgdGhpcy5vZmZzZXQgPSBvZmZzZXQgfHwgMDtcbiAgICB0aGlzLmNvdW50ID0gMCA9PT0gY291bnQgPyBjb3VudCA6IChjb3VudCB8fCBSZXN0UXVlcnkuZGVmYXVsdENvdW50KTtcbiAgICB0aGlzLnByZWRpY2F0ZSA9IHByZWRpY2F0ZSB8fCBudWxsO1xuICAgIHRoaXMuc29ydEJ5ID0gc29ydEJ5IHx8ICcnO1xuICAgIHRoaXMuc29ydEJ5RGlyZWN0aW9uID0gc29ydEJ5RGlyZWN0aW9uIHx8IFF1ZXJ5U29ydERpcmVjdGlvbi5Bc2M7XG4gICAgdGhpcy5jdXN0b21PcHRpb25zID0gY3VzdG9tT3B0aW9ucyB8fCB7fTtcbiAgICB0aGlzLnByb3RvY29sVmVyc2lvbiA9IHByb3RvY29sVmVyc2lvbiB8fCAyO1xuICB9XG4gIHByaXZhdGUgZXNjYXBlKGlucHV0OiBzdHJpbmd8US5FeHByfG51bGwpIHtcbiAgICBpZiAoIWlucHV0KSB7XG4gICAgICByZXR1cm4gJyc7XG4gICAgfVxuICAgIGNvbnN0IGlucCA9IGlucHV0IGluc3RhbmNlb2YgUS5FeHByID8gdGhpcy5hcHBseVByb3RvY29sKGlucHV0KS50b1N0cmluZygpIDogaW5wdXQ7XG4gICAgcmV0dXJuIHV0ZjhcbiAgICAgIC51dGY4ZW5jb2RlKGlucClcbiAgICAgIC5yZXBsYWNlKHJlZ2V4LCAobSkgPT4gJyUnICsgKCcwJyArIG0uY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKSkuc2xpY2UoLTIpKTtcbiAgfVxuXG4gIHByaXZhdGUgYXBwbHlQcm90b2NvbChleHByOiBRLkV4cHIpIHtcbiAgICBpZiAodGhpcy5wcm90b2NvbFZlcnNpb24gPCAyICYmIGV4cHIgaW5zdGFuY2VvZiBRLkxhbWJkYSkge1xuICAgICAgY29uc3QgcGFyYW0gPSBleHByLnBhcmFtO1xuICAgICAgcmV0dXJuIGV4cHIuYm9keS5hY2NlcHQ8US5FeHByPih7XG4gICAgICAgIHZpc2l0Q29uc3QoYykgeyByZXR1cm4gYzsgfSxcbiAgICAgICAgdmlzaXRQYXJhbShwKSB7IHJldHVybiBwOyB9LFxuICAgICAgICAvLyB0c2xpbnQ6ZGlzYWJsZS1uZXh0LWxpbmU6bWF4LWxpbmUtbGVuZ3RoXG4gICAgICAgIHZpc2l0UHJvcChwKSB7IHJldHVybiBwLmluc3RhbmNlLmVxKHBhcmFtKSA/IG5ldyBRLlBhcmFtKDxhbnk+IHAubmFtZSkgOiBuZXcgUS5Qcm9wKHAuaW5zdGFuY2UuYWNjZXB0KHRoaXMpLCBwLm5hbWUpOyB9LFxuICAgICAgICB2aXNpdEJpbmFyeShiKSB7IHJldHVybiBuZXcgUS5CaW5PcChiLmxlZnQuYWNjZXB0KHRoaXMpLCBiLm9wLCBiLnJpZ2h0LmFjY2VwdCh0aGlzKSk7IH0sXG4gICAgICAgIHZpc2l0VW5hcnkodSkgeyByZXR1cm4gbmV3IFEuVW5PcCh1Lm9wLCB1Lm9wZXJhbmQuYWNjZXB0KHRoaXMpKTsgfSxcbiAgICAgICAgdmlzaXRDYWxsKGMpIHsgcmV0dXJuIG5ldyBRLkNhbGwoYy5uYW1lLCBjLmFyZ3MubWFwKChhcmcpID0+IGFyZy5hY2NlcHQodGhpcykpKTsgfSxcbiAgICAgICAgdmlzaXRMYW1iZGEobCkgeyByZXR1cm4gbmV3IFEuTGFtYmRhKGwuYm9keS5hY2NlcHQodGhpcyksIGwucGFyYW0pOyB9XG4gICAgICB9KTtcbiAgICB9XG4gICAgcmV0dXJuIGV4cHI7XG4gIH1cblxuICBwcml2YXRlIGV4dHJhY3RWMVF1ZXJ5KGV4cHI6IFEuRXhwcikge1xuICAgIGNvbnN0IHE6IHsgcXVlcnk/OiBzdHJpbmcgfSA9IHt9O1xuICAgIGNvbnN0IHYxRXhwciA9IGV4cHIuYWNjZXB0PFEuRXhwcj4oe1xuICAgICAgdmlzaXRDb25zdChjKSB7IHJldHVybiBjOyB9LFxuICAgICAgdmlzaXRQYXJhbShwKSB7IHJldHVybiBwOyB9LFxuICAgICAgdmlzaXRQcm9wKHApIHsgcmV0dXJuIG5ldyBRLlByb3AocC5pbnN0YW5jZS5hY2NlcHQodGhpcyksIHAubmFtZSk7IH0sXG4gICAgICB2aXNpdEJpbmFyeShiKSB7XG4gICAgICAgIGNvbnN0IGwgPSBiLmxlZnQuYWNjZXB0KHRoaXMpO1xuICAgICAgICBjb25zdCByID0gYi5yaWdodC5hY2NlcHQodGhpcyk7XG4gICAgICAgIGlmIChsIGluc3RhbmNlb2YgUS5Db25zdCAmJiAoPGFueT4gbC52YWx1ZSA9PT0gdHJ1ZSB8fCA8YW55PiBsLnZhbHVlID09PSAndHJ1ZScpKSB7XG4gICAgICAgICAgICByZXR1cm4gcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAociBpbnN0YW5jZW9mIFEuQ29uc3QgJiYgKDxhbnk+IHIudmFsdWUgPT09IHRydWUgfHwgPGFueT4gci52YWx1ZSA9PT0gJ3RydWUnKSkge1xuICAgICAgICAgICAgcmV0dXJuIGw7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIG5ldyBRLkJpbk9wKGwsIGIub3AsIHIpO1xuICAgICAgfSxcbiAgICAgIHZpc2l0VW5hcnkodSkgeyByZXR1cm4gbmV3IFEuVW5PcCh1Lm9wLCB1Lm9wZXJhbmQuYWNjZXB0KHRoaXMpKTsgfSxcbiAgICAgIHZpc2l0Q2FsbChjKSB7XG4gICAgICAgIGlmICgncGFydGlhbE1hdGNoJyA9PT0gYy5uYW1lICYmIDIgPT09IGMuYXJncy5sZW5ndGgpIHtcbiAgICAgICAgICBjb25zdCBhcmcgPSBjLmFyZ3NbMV07XG4gICAgICAgICAgaWYgKGFyZyBpbnN0YW5jZW9mIFEuQ29uc3QgJiYgYXJnLnZhbHVlKSB7XG4gICAgICAgICAgICBxLnF1ZXJ5ID0gYXJnLnZhbHVlO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBRLkNvbnN0KDxhbnk+IHRydWUpO1xuICAgICAgICAgIH1cbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ25vdCBzdXBwb3J0ZWQgcGFydGlhbCBtYXRjaCBpbiBwcm90b2NvbCB2MScpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBuZXcgUS5DYWxsKGMubmFtZSwgYy5hcmdzLm1hcCgoYXJnKSA9PiBhcmcuYWNjZXB0KHRoaXMpKSk7XG4gICAgICB9LFxuICAgICAgdmlzaXRMYW1iZGEobCkgeyByZXR1cm4gbmV3IFEuTGFtYmRhKGwuYm9keS5hY2NlcHQodGhpcyksIGwucGFyYW0pOyB9XG4gICAgfSk7XG4gICAgcmV0dXJuIHtcbiAgICAgICAgZXhwcjogdjFFeHByLFxuICAgICAgICBxdWVyeTogcVxuICAgIH07XG4gIH1cblxuICBnZXQgZXNjYXBlZFByZWRpY2F0ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5lc2NhcGUodGhpcy5wcmVkaWNhdGUpO1xuICB9XG4gIGdldCBlc2NhcGVkU29ydEJ5KCkge1xuICAgIHJldHVybiB0aGlzLmVzY2FwZSh0aGlzLnNvcnRCeSk7XG4gIH1cbiAgZmlsdGVyKHByZWRpY2F0ZTogc3RyaW5nfFEuTGFtYmRhKSB7XG4gICAgY29uc3QgcCA9ICdzdHJpbmcnID09PSB0eXBlb2YgcHJlZGljYXRlID8gUS5wYXJzZShwcmVkaWNhdGUpIDogcHJlZGljYXRlO1xuICAgIGlmICghKHAgaW5zdGFuY2VvZiBRLkxhbWJkYSkpIHtcbiAgICAgIHRocm93IFR5cGVFcnJvcigncHJlZGljYXRlIG11c3QgYmUgYSBsYW1iZGEgZXhwcmVzc2lvbicpO1xuICAgIH1cbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIHRoaXMub2Zmc2V0LFxuICAgICAgdGhpcy5jb3VudCxcbiAgICAgIHRoaXMucHJlZGljYXRlID8gdGhpcy5wcmVkaWNhdGUuYW5kKHApIDogcCxcbiAgICAgIHRoaXMuc29ydEJ5LFxuICAgICAgdGhpcy5zb3J0QnlEaXJlY3Rpb24sXG4gICAgICB0aGlzLmN1c3RvbU9wdGlvbnMsXG4gICAgICB0aGlzLnByb3RvY29sVmVyc2lvblxuICAgICk7XG4gIH1cbiAgc2tpcChuOiBudW1iZXIpOiBRdWVyeTxUPiB7XG4gICAgaWYgKDAgPT09IG4pIHtcbiAgICAgIHJldHVybiB0aGlzO1xuICAgIH1cbiAgICBjaGVja051bShuLCAnc2tpcCBwYXJhbWV0ZXIgbXVzdCBiZSBub24tbmVnYXRpdmUgd2hvbGUgbnVtYmVyLicpO1xuICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5PFQ+KFxuICAgICAgdGhpcy5yZXBvLFxuICAgICAgbiwgLy8gVE9ETzogRXp0IHbDqWdpZyBrZWxsIGdvbmRvbG5pLCBtZXJ0IGxlaGV0ICh0aGlzLm9mZnNldCArIG4pIGtlbGxlbmUgaWRlP1xuICAgICAgdGhpcy5jb3VudCxcbiAgICAgIHRoaXMucHJlZGljYXRlLFxuICAgICAgdGhpcy5zb3J0QnksXG4gICAgICB0aGlzLnNvcnRCeURpcmVjdGlvbixcbiAgICAgIHRoaXMuY3VzdG9tT3B0aW9ucyxcbiAgICAgIHRoaXMucHJvdG9jb2xWZXJzaW9uXG4gICAgKTtcbiAgfVxuICB0YWtlKG46IG51bWJlcik6IFF1ZXJ5PFQ+IHtcbiAgICBjaGVja051bShuLCAndGFrZSBwYXJhbWV0ZXIgbXVzdCBiZSBub24tbmVnYXRpdmUgd2hvbGUgbnVtYmVyLicpO1xuICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5PFQ+KFxuICAgICAgdGhpcy5yZXBvLFxuICAgICAgdGhpcy5vZmZzZXQsXG4gICAgICBuLFxuICAgICAgdGhpcy5wcmVkaWNhdGUsXG4gICAgICB0aGlzLnNvcnRCeSxcbiAgICAgIHRoaXMuc29ydEJ5RGlyZWN0aW9uLFxuICAgICAgdGhpcy5jdXN0b21PcHRpb25zLFxuICAgICAgdGhpcy5wcm90b2NvbFZlcnNpb24pO1xuICB9XG4gIG9yZGVyQnkoc2VsZWN0b3I6IHN0cmluZywgZGlyZWN0aW9uPzogUXVlcnlTb3J0RGlyZWN0aW9uKTogUXVlcnk8VD4ge1xuICAgIHJldHVybiBuZXcgUmVzdFF1ZXJ5PFQ+KFxuICAgICAgdGhpcy5yZXBvLFxuICAgICAgdGhpcy5vZmZzZXQsXG4gICAgICB0aGlzLmNvdW50LFxuICAgICAgdGhpcy5wcmVkaWNhdGUsXG4gICAgICBzZWxlY3RvcixcbiAgICAgIGRpcmVjdGlvbiB8fCBRdWVyeVNvcnREaXJlY3Rpb24uQXNjLFxuICAgICAgdGhpcy5jdXN0b21PcHRpb25zLFxuICAgICAgdGhpcy5wcm90b2NvbFZlcnNpb24pO1xuICB9XG4gIHNldEN1c3RvbU9wdGlvbnMob3B0aW9uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmd8dW5kZWZpbmVkIH0sIHJlcGxhY2U/OiBib29sZWFuKTogUXVlcnk8VD4ge1xuICAgIGNvbnN0IG9wdHMgPSByZXBsYWNlID8gKG9wdGlvbnMgfHwge30pIDogT2JqZWN0LmFzc2lnbih7fSwgdGhpcy5jdXN0b21PcHRpb25zLCBvcHRpb25zKTtcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIHRoaXMub2Zmc2V0LFxuICAgICAgdGhpcy5jb3VudCxcbiAgICAgIHRoaXMucHJlZGljYXRlLFxuICAgICAgdGhpcy5zb3J0QnksXG4gICAgICB0aGlzLnNvcnRCeURpcmVjdGlvbixcbiAgICAgIG9wdHMsXG4gICAgICB0aGlzLnByb3RvY29sVmVyc2lvbik7XG4gIH1cbiAgYXN5bmMgdG90YWwoY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGxldCBwcmVkaWNhdGU6IHN0cmluZztcbiAgICBsZXQgdjFRdWVyeTogVjFRdWVyeXx1bmRlZmluZWQ7XG4gICAgaWYgKCF0aGlzLnByZWRpY2F0ZSkge1xuICAgICAgcHJlZGljYXRlID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLnByb3RvY29sVmVyc2lvbiA8IDIpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZXh0cmFjdFYxUXVlcnkodGhpcy5wcmVkaWNhdGUpO1xuICAgICAgICBwcmVkaWNhdGUgPSB0aGlzLmVzY2FwZShkYXRhLmV4cHIpO1xuICAgICAgICB2MVF1ZXJ5ID0gZGF0YS5xdWVyeTtcbiAgICAgICAgaWYgKHByZWRpY2F0ZSAmJiBwcmVkaWNhdGUuc3RhcnRzV2l0aCgnKCcpICYmIHByZWRpY2F0ZS5lbmRzV2l0aCgnKScpKSB7XG4gICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cigxLCBwcmVkaWNhdGUubGVuZ3RoIC0gMik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByZWRpY2F0ZSA9IHRoaXMuZXNjYXBlKHRoaXMucHJlZGljYXRlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHRoaXMucmVwby50b3RhbChwcmVkaWNhdGUsIHYxUXVlcnksIHRoaXMuY3VzdG9tT3B0aW9ucywgY2FuY2VsbGF0aW9uKTtcbiAgfVxuICBleGVjKCk6IEFzeW5jSXRlcmFibGU8VD4ge1xuICAgIGxldCBwcmVkaWNhdGU6IHN0cmluZztcbiAgICBsZXQgdjFRdWVyeTogVjFRdWVyeXx1bmRlZmluZWQ7XG4gICAgaWYgKCF0aGlzLnByZWRpY2F0ZSkge1xuICAgICAgcHJlZGljYXRlID0gJyc7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICh0aGlzLnByb3RvY29sVmVyc2lvbiA8IDIpIHtcbiAgICAgICAgY29uc3QgZGF0YSA9IHRoaXMuZXh0cmFjdFYxUXVlcnkodGhpcy5wcmVkaWNhdGUpO1xuICAgICAgICBwcmVkaWNhdGUgPSB0aGlzLmVzY2FwZShkYXRhLmV4cHIpO1xuICAgICAgICB2MVF1ZXJ5ID0gZGF0YS5xdWVyeTtcbiAgICAgICAgaWYgKHByZWRpY2F0ZSAmJiBwcmVkaWNhdGUuc3RhcnRzV2l0aCgnKCcpICYmIHByZWRpY2F0ZS5lbmRzV2l0aCgnKScpKSB7XG4gICAgICAgICAgcHJlZGljYXRlID0gcHJlZGljYXRlLnN1YnN0cigxLCBwcmVkaWNhdGUubGVuZ3RoIC0gMik7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHByZWRpY2F0ZSA9IHRoaXMuZXNjYXBlKHRoaXMucHJlZGljYXRlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgLy8gdHNsaW50OmRpc2FibGUtbmV4dC1saW5lOm1heC1saW5lLWxlbmd0aFxuICAgIHJldHVybiB0aGlzLnJlcG8uZXhlYyh0aGlzLm9mZnNldCwgdGhpcy5jb3VudCwgcHJlZGljYXRlLCB0aGlzLnNvcnRCeSwgdGhpcy5zb3J0QnlEaXJlY3Rpb24sIHYxUXVlcnksIHRoaXMuY3VzdG9tT3B0aW9ucyk7XG4gIH1cbn1cbiJdfQ==
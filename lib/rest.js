import { Query, QuerySortDirection } from "./repositories";
import * as Q from './protocol';
import { decoratedFetch as fetch } from 'dopees-core/lib/fetch';
import * as utf8 from 'dopees-core/lib/utf8';
const checkNum = (n, message) => {
    if (n % 1 !== 0 || n <= 0) {
        throw new TypeError(message);
    }
};
const supportsAbortController = (function () {
    if (window.AbortController) {
        return true;
    }
    return false;
}());
function linkAbortion(cancellation) {
    let signal;
    let subscription;
    if (undefined !== cancellation && supportsAbortController) {
        const abortController = new AbortController();
        signal = abortController.signal;
        subscription = cancellation.subscribe(() => abortController.abort());
    }
    else {
        signal = undefined;
        subscription = { remove() { } };
    }
    return { signal, subscription };
}
export class KeyRestRepository {
    constructor(options) {
        this.options = options;
    }
    get collectionEndpoint() {
        return `${this.endpoint}/${this.type}`;
    }
    get protocolVersion() {
        return this.options.protocolVersion || 2;
    }
    get type() {
        return this.options.type;
    }
    get endpoint() {
        return this.options.endpoint;
    }
    get keyProperty() {
        return this.options.keyProperty || 'id';
    }
    get items() {
        return new RestQuery(this, 0, RestQuery.defaultCount);
    }
    getKey(item) {
        return item[this.keyProperty];
    }
    hasKey(item) {
        return !!this.getKey(item);
    }
    itemEndpoint(item) {
        return `${this.endpoint}/${this.type}/${this.getKey(item)}`;
    }
    __getErrors(response) {
        const messages = response.headers.get('X-Message');
        if (messages) {
            const msgs = messages.split(',').map(decodeURIComponent);
            if (msgs.length === 1) {
                return msgs[0];
            }
            return msgs;
        }
        return response.statusText;
    }
    async lookup(key, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const uri = `${this.endpoint}/${this.type}/${key}`;
            const response = await fetch(uri, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
                signal: abortion.signal
            });
            if (response.ok) {
                return await response.json();
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    async update(item, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const response = await fetch(this.itemEndpoint(item), {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(item),
                signal: abortion.signal
            });
            if (response.ok) {
                return await this.lookup(this.getKey(item), cancellation);
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    async insert(item, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const response = await fetch(this.collectionEndpoint, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item),
                signal: abortion.signal
            });
            if (response.ok) {
                const uri = response.headers.get('Location');
                if (!uri) {
                    throw new Error('rest insert did not return a location');
                }
                const lookupAbortion = linkAbortion(cancellation);
                try {
                    const resp = await fetch(uri, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' },
                        signal: lookupAbortion.signal
                    });
                    if (resp.ok) {
                        return await resp.json();
                    }
                    throw this.__getErrors(resp);
                }
                finally {
                    lookupAbortion.subscription.remove();
                }
            }
            throw this.__getErrors(response);
        }
        finally {
            abortion.subscription.remove();
        }
    }
    remove(item, cancellation) {
        throw new Error("Method not implemented.");
    }
    async total(predicate, cancellation) {
        const abortion = linkAbortion(cancellation);
        try {
            const headers = new Headers();
            headers.append('Accept', 'application/json');
            headers.append('X-Filter', predicate);
            const response = await fetch(this.collectionEndpoint, { headers, signal: abortion.signal });
            if (response.ok) {
                const header = response.headers.get('X-Total-Count');
                return header ? (parseInt(header, 10) || 0) : 0;
            }
            else {
                throw new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
            }
        }
        finally {
            abortion.subscription.remove();
        }
    }
    exec(offset, count, predicate, sortBy, sortByDirection) {
        const repo = this;
        let error = null;
        let items = null;
        let index = 0;
        return {
            async next(cancellation) {
                cancellation && cancellation.throwIfCancelled();
                if (null !== error) {
                    throw error;
                }
                if (!items) {
                    // Első next() meghívásakor ez fut le.
                    const abortion = linkAbortion(cancellation);
                    try {
                        const headers = new Headers();
                        headers.append('Accept', 'application/json');
                        headers.append('X-Offset', String(offset));
                        headers.append('X-Count', String(count));
                        headers.append('X-Filter', predicate);
                        headers.append('X-Sort-By', sortBy || '');
                        headers.append('X-Sort-By-Direction', sortByDirection || '');
                        const response = await fetch(repo.collectionEndpoint, { headers, signal: abortion.signal });
                        if (response.ok) {
                            items = await response.json();
                        }
                        else {
                            error = new Error(`Hiba lépett fel adatok lekérdezése közben: ${response.statusText}`);
                            throw error;
                        }
                    }
                    finally {
                        abortion.subscription.remove();
                    }
                }
                if (!items) {
                    throw new Error('should never happen');
                }
                if (index >= items.length) {
                    return { done: true, value: undefined };
                }
                const value = items[index];
                ++index;
                return {
                    done: false,
                    value: value
                };
            },
            cancel() {
                //FIXME: implement
            }
        };
    }
}
const regex = /[\0-\x08\n-\x1F\x7F-\uFFFF]/g;
class RestQuery extends Query {
    constructor(repo, offset, count, predicate, sortBy, sortByDirection) {
        super();
        this.repo = repo;
        this.offset = offset || 0;
        this.count = 0 === count ? count : (count || RestQuery.defaultCount);
        this.predicate = predicate || null;
        this.sortBy = sortBy || '';
        this.sortByDirection = sortByDirection || QuerySortDirection.Asc;
    }
    escape(input) {
        if (!input) {
            return '';
        }
        const inp = input instanceof Q.Expr ? input.toString() : input;
        return utf8.utf8encode(inp).replace(regex, m => '%' + ('0' + m.charCodeAt(0).toString(16).toUpperCase()).slice(-2));
    }
    get escapedPredicate() {
        return this.escape(this.predicate);
    }
    get escapedSortBy() {
        return this.escape(this.sortBy);
    }
    filter(predicate) {
        const p = 'string' === typeof predicate ? Q.parse(predicate) : predicate;
        if (!(p instanceof Q.Lambda)) {
            throw TypeError('predicate must be a lambda expression');
        }
        return new RestQuery(this.repo, this.offset, this.count, this.predicate ? this.predicate.and(p) : p, this.sortBy, this.sortByDirection);
    }
    skip(n) {
        if (0 === n) {
            return this;
        }
        checkNum(n, 'skip parameter must be non-negative whole number.');
        return new RestQuery(this.repo, n, // TODO: Ezt végig kell gondolni, mert lehet (this.offset + n) kellene ide?
        this.count, this.predicate, this.sortBy, this.sortByDirection);
    }
    take(n) {
        checkNum(n, 'take parameter must be non-negative whole number.');
        return new RestQuery(this.repo, this.offset, n, this.predicate, this.sortBy, this.sortByDirection);
    }
    orderBy(selector, direction) {
        return new RestQuery(this.repo, this.offset, this.count, this.predicate, selector, direction || QuerySortDirection.Asc);
    }
    async total(cancellation) {
        return this.repo.total(this.escapedPredicate, cancellation);
    }
    exec() {
        return this.repo.exec(this.offset, this.count, this.escapedPredicate, this.sortBy, this.sortByDirection);
    }
}
RestQuery.defaultCount = 100000;
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9yZXN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxLQUFLLEVBQXdDLGtCQUFrQixFQUErQixNQUFNLGdCQUFnQixDQUFBO0FBQzdILE9BQU8sS0FBSyxDQUFDLE1BQU0sWUFBWSxDQUFBO0FBQy9CLE9BQU8sRUFBRSxjQUFjLElBQUksS0FBSyxFQUFFLE1BQU0sdUJBQXVCLENBQUM7QUFDaEUsT0FBTyxLQUFLLElBQUksTUFBTSxzQkFBc0IsQ0FBQztBQUc3QyxNQUFNLFFBQVEsR0FBRyxDQUFDLENBQVMsRUFBRSxPQUFlLEVBQUUsRUFBRTtJQUM5QyxJQUFJLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUU7UUFDekIsTUFBTSxJQUFJLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQztLQUM5QjtBQUNILENBQUMsQ0FBQTtBQVNELE1BQU0sdUJBQXVCLEdBQUcsQ0FBQztJQUMvQixJQUFLLE1BQWMsQ0FBQyxlQUFlLEVBQUU7UUFDbkMsT0FBTyxJQUFJLENBQUM7S0FDYjtJQUNELE9BQU8sS0FBSyxDQUFDO0FBQ2YsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQU9MLFNBQVMsWUFBWSxDQUFDLFlBQTJCO0lBQy9DLElBQUksTUFBNkIsQ0FBQztJQUNsQyxJQUFJLFlBQWdDLENBQUM7SUFDckMsSUFBSSxTQUFTLEtBQUssWUFBWSxJQUFJLHVCQUF1QixFQUFFO1FBQ3pELE1BQU0sZUFBZSxHQUFHLElBQUksZUFBZSxFQUFFLENBQUM7UUFDOUMsTUFBTSxHQUFHLGVBQWUsQ0FBQyxNQUFNLENBQUM7UUFDaEMsWUFBWSxHQUFHLFlBQVksQ0FBQyxTQUFTLENBQUMsR0FBRyxFQUFFLENBQUMsZUFBZSxDQUFDLEtBQUssRUFBRSxDQUFDLENBQUM7S0FDdEU7U0FBTTtRQUNMLE1BQU0sR0FBRyxTQUFTLENBQUM7UUFDbkIsWUFB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Z0JBQWdCLEVBQUUsWUFBWSxDQUFDLENBQUM7SUFDOUQsQ0FBQztJQUNELElBQUk7UUFDRixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsSUFBSSxDQUFDLE1BQU0sRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDM0csQ0FBQzs7QUFqRk0sc0JBQVksR0FBRyxNQUFNLENBQUE7QUFrRjdCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBRdWVyeSwgUmVwb3NpdG9yeSwgQ2FuY2VsbGFibGVBc3luY0l0ZXJhdG9yLCBRdWVyeVNvcnREaXJlY3Rpb24sIEtleVJlcG9zaXRvcnksIENhbmNlbGxhdGlvbiB9IGZyb20gXCIuL3JlcG9zaXRvcmllc1wiXG5pbXBvcnQgKiBhcyBRIGZyb20gJy4vcHJvdG9jb2wnXG5pbXBvcnQgeyBkZWNvcmF0ZWRGZXRjaCBhcyBmZXRjaCB9IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi9mZXRjaCc7XG5pbXBvcnQgKiBhcyB1dGY4IGZyb20gJ2RvcGVlcy1jb3JlL2xpYi91dGY4JztcblxuXG5jb25zdCBjaGVja051bSA9IChuOiBudW1iZXIsIG1lc3NhZ2U6IHN0cmluZykgPT4ge1xuICBpZiAobiAlIDEgIT09IDAgfHwgbiA8PSAwKSB7XG4gICAgdGhyb3cgbmV3IFR5cGVFcnJvcihtZXNzYWdlKTtcbiAgfVxufVxuXG5pbnRlcmZhY2UgUmVzdFJlcG9zaXRvcnlPcHRpb25zIHtcbiAgdHlwZTogc3RyaW5nO1xuICBlbmRwb2ludDogc3RyaW5nO1xuICBrZXlQcm9wZXJ0eT86IHN0cmluZztcbiAgcHJvdG9jb2xWZXJzaW9uPzogbnVtYmVyO1xufVxuXG5jb25zdCBzdXBwb3J0c0Fib3J0Q29udHJvbGxlciA9IChmdW5jdGlvbiAoKSB7XG4gIGlmICgod2luZG93IGFzIGFueSkuQWJvcnRDb250cm9sbGVyKSB7XG4gICAgcmV0dXJuIHRydWU7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufSgpKTtcblxuaW50ZXJmYWNlIEFib3J0aW9uIHtcbiAgc2lnbmFsOiBBYm9ydFNpZ25hbHx1bmRlZmluZWRcbiAgc3Vic2NyaXB0aW9uOiB7IHJlbW92ZSgpOiB2b2lkIH1cbn1cblxuZnVuY3Rpb24gbGlua0Fib3J0aW9uKGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvbik6IEFib3J0aW9uIHtcbiAgbGV0IHNpZ25hbDogQWJvcnRTaWduYWx8dW5kZWZpbmVkO1xuICBsZXQgc3Vic2NyaXB0aW9uOiB7IHJlbW92ZSgpOiB2b2lkIH07XG4gIGlmICh1bmRlZmluZWQgIT09IGNhbmNlbGxhdGlvbiAmJiBzdXBwb3J0c0Fib3J0Q29udHJvbGxlcikge1xuICAgIGNvbnN0IGFib3J0Q29udHJvbGxlciA9IG5ldyBBYm9ydENvbnRyb2xsZXIoKTtcbiAgICBzaWduYWwgPSBhYm9ydENvbnRyb2xsZXIuc2lnbmFsO1xuICAgIHN1YnNjcmlwdGlvbiA9IGNhbmNlbGxhdGlvbi5zdWJzY3JpYmUoKCkgPT4gYWJvcnRDb250cm9sbGVyLmFib3J0KCkpO1xuICB9IGVsc2Uge1xuICAgIHNpZ25hbCA9IHVuZGVmaW5lZDtcbiAgICBzdWJzY3JpcHRpb24gPSB7IHJlbW92ZSgpIHsgfSB9O1xuICB9XG4gIHJldHVybiB7IHNpZ25hbCwgc3Vic2NyaXB0aW9uIH07XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVzdFJlcG9zaXRvcnk8VD4gZXh0ZW5kcyBSZXBvc2l0b3J5PFQ+IHtcbiAgZXhlYyhvZmZzZXQ6IG51bWJlciwgY291bnQ6IG51bWJlciwgcHJlZGljYXRlOiBzdHJpbmcsIHNvcnRCeT86IHN0cmluZywgc29ydEJ5RGlyZWN0aW9uPzogUXVlcnlTb3J0RGlyZWN0aW9uKTogQ2FuY2VsbGFibGVBc3luY0l0ZXJhdG9yPFQ+O1xuICB0b3RhbChwcmVkaWNhdGU6IHN0cmluZywgY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPG51bWJlcj47XG59XG5cbmV4cG9ydCBjbGFzcyBLZXlSZXN0UmVwb3NpdG9yeTxURGF0YSwgVEtleT4gaW1wbGVtZW50cyBLZXlSZXBvc2l0b3J5PFREYXRhLCBUS2V5PiwgUmVzdFJlcG9zaXRvcnk8VERhdGE+IHtcbiAgcmVhZG9ubHkgb3B0aW9ucyA6IFJlc3RSZXBvc2l0b3J5T3B0aW9uc1xuICBjb25zdHJ1Y3RvcihvcHRpb25zOiBSZXN0UmVwb3NpdG9yeU9wdGlvbnMpIHtcbiAgICB0aGlzLm9wdGlvbnMgPSBvcHRpb25zO1xuICB9XG4gIHByaXZhdGUgZ2V0IGNvbGxlY3Rpb25FbmRwb2ludCAoKSB7XG4gICAgcmV0dXJuIGAke3RoaXMuZW5kcG9pbnR9LyR7dGhpcy50eXBlfWA7XG4gIH1cbiAgZ2V0IHByb3RvY29sVmVyc2lvbiAoKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5wcm90b2NvbFZlcnNpb24gfHwgMjtcbiAgfVxuICBnZXQgdHlwZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy50eXBlO1xuICB9XG4gIGdldCBlbmRwb2ludCAoKSB7XG4gICAgcmV0dXJuIHRoaXMub3B0aW9ucy5lbmRwb2ludDtcbiAgfVxuICBnZXQga2V5UHJvcGVydHkgKCkge1xuICAgIHJldHVybiB0aGlzLm9wdGlvbnMua2V5UHJvcGVydHkgfHwgJ2lkJztcbiAgfVxuICBnZXQgaXRlbXMoKTogUXVlcnk8VERhdGE+IHtcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxURGF0YT4odGhpcywgMCwgUmVzdFF1ZXJ5LmRlZmF1bHRDb3VudCk7XG4gIH1cbiAgcHJpdmF0ZSBnZXRLZXkoaXRlbTogVERhdGEpIHtcbiAgICByZXR1cm4gKGl0ZW0gYXMgYW55KVt0aGlzLmtleVByb3BlcnR5XSBhcyBUS2V5O1xuICB9XG4gIHByaXZhdGUgaGFzS2V5KGl0ZW06IFREYXRhKSB7XG4gICAgcmV0dXJuICEhdGhpcy5nZXRLZXkoaXRlbSk7XG4gIH1cbiAgcHJpdmF0ZSBpdGVtRW5kcG9pbnQoaXRlbTogVERhdGEpIHtcbiAgICByZXR1cm4gYCR7dGhpcy5lbmRwb2ludH0vJHt0aGlzLnR5cGV9LyR7dGhpcy5nZXRLZXkoaXRlbSl9YDtcbiAgfVxuICBwcml2YXRlIF9fZ2V0RXJyb3JzIChyZXNwb25zZTogUmVzcG9uc2UpIHtcbiAgICBjb25zdCBtZXNzYWdlcyA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdYLU1lc3NhZ2UnKTtcbiAgICBpZiAobWVzc2FnZXMpIHtcbiAgICAgIGNvbnN0IG1zZ3MgPSBtZXNzYWdlcy5zcGxpdCgnLCcpLm1hcChkZWNvZGVVUklDb21wb25lbnQpO1xuICAgICAgaWYgKG1zZ3MubGVuZ3RoID09PSAxKSB7XG4gICAgICAgIHJldHVybiBtc2dzWzBdO1xuICAgICAgfVxuICAgICAgcmV0dXJuIG1zZ3M7XG4gICAgfVxuICAgIHJldHVybiByZXNwb25zZS5zdGF0dXNUZXh0O1xuICB9XG4gIGFzeW5jIGxvb2t1cChrZXk6IFRLZXksIGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+IHtcbiAgICBjb25zdCBhYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB1cmkgPSBgJHt0aGlzLmVuZHBvaW50fS8ke3RoaXMudHlwZX0vJHtrZXl9YDtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godXJpLCB7XG4gICAgICAgIG1ldGhvZDogJ0dFVCcsXG4gICAgICAgIGhlYWRlcnM6IHsgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgICBzaWduYWw6IGFib3J0aW9uLnNpZ25hbFxuICAgICAgfSk7XG4gICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHJlc3BvbnNlLmpzb24oKTtcbiAgICAgIH1cbiAgICAgIHRocm93IHRoaXMuX19nZXRFcnJvcnMocmVzcG9uc2UpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBhYm9ydGlvbi5zdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgfVxuICB9XG4gIGFzeW5jIHVwZGF0ZShpdGVtOiBURGF0YSwgY2FuY2VsbGF0aW9uPzogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxURGF0YT4ge1xuICAgIGNvbnN0IGFib3J0aW9uID0gbGlua0Fib3J0aW9uKGNhbmNlbGxhdGlvbik7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godGhpcy5pdGVtRW5kcG9pbnQoaXRlbSksIHtcbiAgICAgICAgbWV0aG9kOiAnUFVUJyxcbiAgICAgICAgaGVhZGVyczoge1xuICAgICAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbidcbiAgICAgICAgfSxcbiAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoaXRlbSksXG4gICAgICAgIHNpZ25hbDogYWJvcnRpb24uc2lnbmFsXG4gICAgICB9KTtcbiAgICAgIGlmIChyZXNwb25zZS5vaykge1xuICAgICAgICByZXR1cm4gYXdhaXQgdGhpcy5sb29rdXAodGhpcy5nZXRLZXkoaXRlbSksIGNhbmNlbGxhdGlvbik7XG4gICAgICB9XG4gICAgICB0aHJvdyB0aGlzLl9fZ2V0RXJyb3JzKHJlc3BvbnNlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuICBhc3luYyBpbnNlcnQoaXRlbTogVERhdGEsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxURGF0YT4ge1xuICAgIGNvbnN0IGFib3J0aW9uID0gbGlua0Fib3J0aW9uKGNhbmNlbGxhdGlvbik7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godGhpcy5jb2xsZWN0aW9uRW5kcG9pbnQsIHtcbiAgICAgICAgbWV0aG9kOiAnUE9TVCcsXG4gICAgICAgIGhlYWRlcnM6IHsgJ0NvbnRlbnQtVHlwZSc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgICBib2R5OiBKU09OLnN0cmluZ2lmeShpdGVtKSxcbiAgICAgICAgc2lnbmFsOiBhYm9ydGlvbi5zaWduYWxcbiAgICAgIH0pO1xuICAgICAgaWYgKHJlc3BvbnNlLm9rKSB7XG4gICAgICAgIGNvbnN0IHVyaSA9IHJlc3BvbnNlLmhlYWRlcnMuZ2V0KCdMb2NhdGlvbicpO1xuICAgICAgICBpZiAoIXVyaSkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcigncmVzdCBpbnNlcnQgZGlkIG5vdCByZXR1cm4gYSBsb2NhdGlvbicpO1xuICAgICAgICB9XG4gICAgICAgIGNvbnN0IGxvb2t1cEFib3J0aW9uID0gbGlua0Fib3J0aW9uKGNhbmNlbGxhdGlvbik7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgcmVzcCA9IGF3YWl0IGZldGNoKHVyaSwge1xuICAgICAgICAgICAgbWV0aG9kOiAnR0VUJyxcbiAgICAgICAgICAgIGhlYWRlcnM6IHsgJ0FjY2VwdCc6ICdhcHBsaWNhdGlvbi9qc29uJyB9LFxuICAgICAgICAgICAgc2lnbmFsOiBsb29rdXBBYm9ydGlvbi5zaWduYWxcbiAgICAgICAgICB9KVxuICAgICAgICAgIGlmIChyZXNwLm9rKSB7XG4gICAgICAgICAgICByZXR1cm4gYXdhaXQgcmVzcC5qc29uKCk7XG4gICAgICAgICAgfVxuICAgICAgICAgIHRocm93IHRoaXMuX19nZXRFcnJvcnMocmVzcCk7XG4gICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgbG9va3VwQWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICB0aHJvdyB0aGlzLl9fZ2V0RXJyb3JzKHJlc3BvbnNlKTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgYWJvcnRpb24uc3Vic2NyaXB0aW9uLnJlbW92ZSgpO1xuICAgIH1cbiAgfVxuICByZW1vdmUoaXRlbTogVERhdGEsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiTWV0aG9kIG5vdCBpbXBsZW1lbnRlZC5cIik7XG4gIH1cbiAgYXN5bmMgdG90YWwocHJlZGljYXRlOiBzdHJpbmcsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBjb25zdCBhYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoKTtcbiAgICAgIGhlYWRlcnMuYXBwZW5kKCdBY2NlcHQnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtRmlsdGVyJywgcHJlZGljYXRlKTtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2godGhpcy5jb2xsZWN0aW9uRW5kcG9pbnQsIHsgaGVhZGVycywgc2lnbmFsOiBhYm9ydGlvbi5zaWduYWwgfSk7XG4gICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgY29uc3QgaGVhZGVyID0gcmVzcG9uc2UuaGVhZGVycy5nZXQoJ1gtVG90YWwtQ291bnQnKTtcbiAgICAgICAgcmV0dXJuIGhlYWRlciA/IChwYXJzZUludChoZWFkZXIsIDEwKSB8fCAwKSA6IDA7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEhpYmEgbMOpcGV0dCBmZWwgYWRhdG9rIGxla8OpcmRlesOpc2Uga8O2emJlbjogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICBhYm9ydGlvbi5zdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgfVxuICB9XG4gIGV4ZWMob2Zmc2V0OiBudW1iZXIsIGNvdW50OiBudW1iZXIsIHByZWRpY2F0ZTogc3RyaW5nLCBzb3J0Qnk/OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbik6IENhbmNlbGxhYmxlQXN5bmNJdGVyYXRvcjxURGF0YT4ge1xuICAgIGNvbnN0IHJlcG8gPSB0aGlzO1xuICAgIGxldCBlcnJvciA6IGFueSA9IG51bGw7XG4gICAgbGV0IGl0ZW1zIDogVERhdGFbXXxudWxsID0gbnVsbDtcbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIHJldHVybiB7XG4gICAgICBhc3luYyBuZXh0KGNhbmNlbGxhdGlvbj86IENhbmNlbGxhdGlvbik6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VERhdGE+PiB7XG4gICAgICAgIGNhbmNlbGxhdGlvbiAmJiBjYW5jZWxsYXRpb24udGhyb3dJZkNhbmNlbGxlZCgpO1xuICAgICAgICBpZiAobnVsbCAhPT0gZXJyb3IpIHtcbiAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoIWl0ZW1zKSB7XG4gICAgICAgICAgLy8gRWxzxZEgbmV4dCgpIG1lZ2jDrXbDoXNha29yIGV6IGZ1dCBsZS5cbiAgICAgICAgICBjb25zdCBhYm9ydGlvbiA9IGxpbmtBYm9ydGlvbihjYW5jZWxsYXRpb24pO1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCBoZWFkZXJzID0gbmV3IEhlYWRlcnMoKTtcbiAgICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKCdBY2NlcHQnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtT2Zmc2V0JywgU3RyaW5nKG9mZnNldCkpO1xuICAgICAgICAgICAgaGVhZGVycy5hcHBlbmQoJ1gtQ291bnQnLCBTdHJpbmcoY291bnQpKTtcbiAgICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLUZpbHRlcicsIHByZWRpY2F0ZSk7XG4gICAgICAgICAgICBoZWFkZXJzLmFwcGVuZCgnWC1Tb3J0LUJ5Jywgc29ydEJ5IHx8ICcnKTtcbiAgICAgICAgICAgIGhlYWRlcnMuYXBwZW5kKCdYLVNvcnQtQnktRGlyZWN0aW9uJywgc29ydEJ5RGlyZWN0aW9uIHx8ICcnKTtcbiAgICAgICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgZmV0Y2gocmVwby5jb2xsZWN0aW9uRW5kcG9pbnQsIHsgaGVhZGVycywgc2lnbmFsOiBhYm9ydGlvbi5zaWduYWwgfSk7XG4gICAgICAgICAgICBpZiAocmVzcG9uc2Uub2spIHtcbiAgICAgICAgICAgICAgaXRlbXMgPSBhd2FpdCByZXNwb25zZS5qc29uKCk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBlcnJvciA9IG5ldyBFcnJvcihgSGliYSBsw6lwZXR0IGZlbCBhZGF0b2sgbGVrw6lyZGV6w6lzZSBrw7Z6YmVuOiAke3Jlc3BvbnNlLnN0YXR1c1RleHR9YCk7XG4gICAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH0gZmluYWxseSB7XG4gICAgICAgICAgICBhYm9ydGlvbi5zdWJzY3JpcHRpb24ucmVtb3ZlKCk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICAgIGlmICghaXRlbXMpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3Nob3VsZCBuZXZlciBoYXBwZW4nKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAoaW5kZXggPj0gaXRlbXMubGVuZ3RoKSB7XG4gICAgICAgICAgcmV0dXJuIHsgZG9uZTogdHJ1ZSwgdmFsdWU6IDxURGF0YT48dW5rbm93bj51bmRlZmluZWQgfVxuICAgICAgICB9XG4gICAgICAgIGNvbnN0IHZhbHVlID0gaXRlbXNbaW5kZXhdO1xuICAgICAgICArK2luZGV4O1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGRvbmU6IGZhbHNlLFxuICAgICAgICAgIHZhbHVlOiB2YWx1ZVxuICAgICAgICB9O1xuICAgICAgfSxcbiAgICAgIGNhbmNlbCgpIHtcbiAgICAgICAgICAvL0ZJWE1FOiBpbXBsZW1lbnRcbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cblxuY29uc3QgcmVnZXggPSAvW1xcMC1cXHgwOFxcbi1cXHgxRlxceDdGLVxcdUZGRkZdL2c7XG5cbmNsYXNzIFJlc3RRdWVyeTxUPiBleHRlbmRzIFF1ZXJ5PFQ+IHtcbiAgc3RhdGljIGRlZmF1bHRDb3VudCA9IDEwMDAwMFxuICByZWFkb25seSByZXBvOiBSZXN0UmVwb3NpdG9yeTxUPlxuICByZWFkb25seSBvZmZzZXQ6IG51bWJlclxuICByZWFkb25seSBjb3VudDogbnVtYmVyXG4gIHJlYWRvbmx5IHByZWRpY2F0ZTogUS5MYW1iZGF8bnVsbFxuICByZWFkb25seSBzb3J0Qnk6IHN0cmluZ1xuICByZWFkb25seSBzb3J0QnlEaXJlY3Rpb246IFF1ZXJ5U29ydERpcmVjdGlvblxuICBjb25zdHJ1Y3RvciAocmVwbzogUmVzdFJlcG9zaXRvcnk8VD4sIG9mZnNldDogbnVtYmVyLCBjb3VudDogbnVtYmVyLCBwcmVkaWNhdGU/OiBRLkxhbWJkYXxudWxsLCBzb3J0Qnk/OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbj86IFF1ZXJ5U29ydERpcmVjdGlvbikge1xuICAgIHN1cGVyKCk7XG4gICAgdGhpcy5yZXBvID0gcmVwbztcbiAgICB0aGlzLm9mZnNldCA9IG9mZnNldCB8fCAwO1xuICAgIHRoaXMuY291bnQgPSAwID09PSBjb3VudCA/IGNvdW50IDogKGNvdW50IHx8IFJlc3RRdWVyeS5kZWZhdWx0Q291bnQpO1xuICAgIHRoaXMucHJlZGljYXRlID0gcHJlZGljYXRlIHx8IG51bGw7XG4gICAgdGhpcy5zb3J0QnkgPSBzb3J0QnkgfHwgJyc7XG4gICAgdGhpcy5zb3J0QnlEaXJlY3Rpb24gPSBzb3J0QnlEaXJlY3Rpb24gfHwgUXVlcnlTb3J0RGlyZWN0aW9uLkFzYztcbiAgfVxuICBwcml2YXRlIGVzY2FwZSAoaW5wdXQ6IHN0cmluZ3xRLkV4cHJ8bnVsbCkge1xuICAgIGlmICghaW5wdXQpIHtcbiAgICAgIHJldHVybiAnJztcbiAgICB9XG4gICAgY29uc3QgaW5wID0gaW5wdXQgaW5zdGFuY2VvZiBRLkV4cHIgPyBpbnB1dC50b1N0cmluZygpIDogaW5wdXQ7XG4gICAgcmV0dXJuIHV0ZjgudXRmOGVuY29kZShpbnApLnJlcGxhY2UocmVnZXgsIG0gPT4gJyUnICsgKCcwJyArIG0uY2hhckNvZGVBdCgwKS50b1N0cmluZygxNikudG9VcHBlckNhc2UoKSkuc2xpY2UoLTIpKTtcbiAgfVxuICBnZXQgZXNjYXBlZFByZWRpY2F0ZSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZXNjYXBlKHRoaXMucHJlZGljYXRlKTtcbiAgfVxuICBnZXQgZXNjYXBlZFNvcnRCeSAoKSB7XG4gICAgcmV0dXJuIHRoaXMuZXNjYXBlKHRoaXMuc29ydEJ5KTtcbiAgfVxuICBmaWx0ZXIgKHByZWRpY2F0ZTogc3RyaW5nfFEuTGFtYmRhKTogUXVlcnk8VD4ge1xuICAgIGNvbnN0IHAgPSAnc3RyaW5nJyA9PT0gdHlwZW9mIHByZWRpY2F0ZSA/IFEucGFyc2UocHJlZGljYXRlKSA6IHByZWRpY2F0ZTtcbiAgICBpZiAoIShwIGluc3RhbmNlb2YgUS5MYW1iZGEpKSB7XG4gICAgICB0aHJvdyBUeXBlRXJyb3IoJ3ByZWRpY2F0ZSBtdXN0IGJlIGEgbGFtYmRhIGV4cHJlc3Npb24nKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBSZXN0UXVlcnk8VD4oXG4gICAgICB0aGlzLnJlcG8sXG4gICAgICB0aGlzLm9mZnNldCxcbiAgICAgIHRoaXMuY291bnQsXG4gICAgICB0aGlzLnByZWRpY2F0ZSA/IHRoaXMucHJlZGljYXRlLmFuZChwKSA6IHAsXG4gICAgICB0aGlzLnNvcnRCeSxcbiAgICAgIHRoaXMuc29ydEJ5RGlyZWN0aW9uXG4gICAgKTtcbiAgfVxuICBza2lwKG46IG51bWJlcik6IFF1ZXJ5PFQ+IHtcbiAgICBpZiAoMCA9PT0gbikge1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICAgIGNoZWNrTnVtKG4sICdza2lwIHBhcmFtZXRlciBtdXN0IGJlIG5vbi1uZWdhdGl2ZSB3aG9sZSBudW1iZXIuJyk7XG4gICAgcmV0dXJuIG5ldyBSZXN0UXVlcnk8VD4oXG4gICAgICB0aGlzLnJlcG8sXG4gICAgICBuLCAvLyBUT0RPOiBFenQgdsOpZ2lnIGtlbGwgZ29uZG9sbmksIG1lcnQgbGVoZXQgKHRoaXMub2Zmc2V0ICsgbikga2VsbGVuZSBpZGU/XG4gICAgICB0aGlzLmNvdW50LFxuICAgICAgdGhpcy5wcmVkaWNhdGUsXG4gICAgICB0aGlzLnNvcnRCeSxcbiAgICAgIHRoaXMuc29ydEJ5RGlyZWN0aW9uLFxuICAgICk7XG4gIH1cbiAgdGFrZShuOiBudW1iZXIpOiBRdWVyeTxUPiB7XG4gICAgY2hlY2tOdW0obiwgJ3Rha2UgcGFyYW1ldGVyIG11c3QgYmUgbm9uLW5lZ2F0aXZlIHdob2xlIG51bWJlci4nKTtcbiAgICByZXR1cm4gbmV3IFJlc3RRdWVyeTxUPihcbiAgICAgIHRoaXMucmVwbyxcbiAgICAgIHRoaXMub2Zmc2V0LFxuICAgICAgbixcbiAgICAgIHRoaXMucHJlZGljYXRlLFxuICAgICAgdGhpcy5zb3J0QnksXG4gICAgICB0aGlzLnNvcnRCeURpcmVjdGlvbik7XG4gIH1cbiAgb3JkZXJCeShzZWxlY3Rvcjogc3RyaW5nLCBkaXJlY3Rpb24/OiBRdWVyeVNvcnREaXJlY3Rpb24pOiBRdWVyeTxUPiB7XG4gICAgcmV0dXJuIG5ldyBSZXN0UXVlcnk8VD4oXG4gICAgICB0aGlzLnJlcG8sXG4gICAgICB0aGlzLm9mZnNldCxcbiAgICAgIHRoaXMuY291bnQsXG4gICAgICB0aGlzLnByZWRpY2F0ZSxcbiAgICAgIHNlbGVjdG9yLFxuICAgICAgZGlyZWN0aW9uIHx8IFF1ZXJ5U29ydERpcmVjdGlvbi5Bc2MpO1xuICB9XG4gIGFzeW5jIHRvdGFsKGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICByZXR1cm4gdGhpcy5yZXBvLnRvdGFsKHRoaXMuZXNjYXBlZFByZWRpY2F0ZSwgY2FuY2VsbGF0aW9uKTtcbiAgfVxuICBleGVjKCk6IENhbmNlbGxhYmxlQXN5bmNJdGVyYXRvcjxUPiB7XG4gICAgcmV0dXJuIHRoaXMucmVwby5leGVjKHRoaXMub2Zmc2V0LCB0aGlzLmNvdW50LCB0aGlzLmVzY2FwZWRQcmVkaWNhdGUsIHRoaXMuc29ydEJ5LCB0aGlzLnNvcnRCeURpcmVjdGlvbik7XG4gIH1cbn07Il19
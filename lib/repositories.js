export class CancelledError extends Error {
    constructor() { super('operation has been cancelled'); }
}
const dummySubscription = {
    remove() { }
};
export class Cancellation {
    throwIfCancelled() {
        if (this.cancelled) {
            throw new CancelledError();
        }
    }
}
Cancellation.none = {
    cancelled: false,
    subscribe(_) { return dummySubscription; },
    throwIfCancelled() { }
};
export const None = {};
export class CancellationSource extends Cancellation {
    constructor() {
        super(...arguments);
        this.callbacks = new Array();
        this.cancelled = false;
    }
    static link(cancellation1, cancellation2) {
        return { get cancelled() { return cancellation1.cancelled || cancellation2.cancelled; } };
    }
    get cancellation() { return this; }
    cancel() {
        this.cancelled = true;
        this.callbacks.forEach(callback => callback());
        this.callbacks.splice(0, this.callbacks.length);
    }
    subscribe(callback) {
        if (this.callbacks.some(x => x === callback)) {
            throw new Error('callback already registered');
        }
        this.callbacks.push(callback);
        const that = this;
        return {
            remove() {
                const index = that.callbacks.indexOf(callback);
                if (-1 !== index) {
                    that.callbacks.splice(index, 1);
                }
            }
        };
    }
}
export var QuerySortDirection;
(function (QuerySortDirection) {
    QuerySortDirection["Asc"] = "asc";
    QuerySortDirection["Desc"] = "desc";
})(QuerySortDirection || (QuerySortDirection = {}));
export class Query {
    async forEach(callback, cancellation) {
        const iterator = this.exec();
        let index = 0;
        const runner = async () => {
            const res = await iterator.next(cancellation);
            if (res.done) {
                return;
            }
            await callback(res.value, index);
            ++index;
            return await runner();
        };
        await runner();
    }
    async toArray(cancellation) {
        const result = new Array();
        await this.forEach(async (item) => result.push(item), cancellation);
        return result;
    }
    async first(cancellation) {
        const iterator = this.exec();
        try {
            const first = await iterator.next(cancellation);
            if (first.done) {
                throw new Error('sequence contains no elements');
            }
            return first.value;
        }
        finally {
            iterator.cancel();
        }
    }
    async tryFirst(cancellation) {
        const iterator = this.exec();
        try {
            const first = await iterator.next(cancellation);
            return first.done ? None : first.value;
        }
        finally {
            iterator.cancel();
        }
    }
    async single(cancellation) {
        const iterator = this.exec();
        try {
            const first = await iterator.next(cancellation);
            if (first.done) {
                throw new Error('sequence contains no elements');
            }
            const next = await iterator.next(cancellation);
            if (!next.done) {
                throw new Error('sequence contains more than 1 element elements');
            }
            return first.value;
        }
        finally {
            iterator.cancel();
        }
    }
    async trySingle(cancellation) {
        const iterator = this.exec();
        try {
            const first = await iterator.next(cancellation);
            if (first.done) {
                return None;
            }
            const next = await iterator.next(cancellation);
            if (!next.done) {
                throw new Error('sequence contains more than 1 element elements');
            }
            return first.value;
        }
        finally {
            iterator.cancel();
        }
    }
}
export class RepositoryStore {
    constructor() {
        this.store = {};
    }
    __get(name) {
        const factory = this.store[name];
        if (!factory) {
            throw new Error(`no repository has been registered for ${name}`);
        }
        return factory();
    }
    register(name, factory) {
        this.store[name] = factory;
    }
    get(name) { return this.__get(name); }
    getRepository(name) { return this.__get(name); }
}
const repositories = new RepositoryStore();
export { repositories };
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yaWVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3JlcG9zaXRvcmllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxNQUFNLE9BQU8sY0FBZSxTQUFRLEtBQUs7SUFDdkMsZ0JBQWdCLEtBQUssQ0FBQyw4QkFBOEIsQ0FBQyxDQUFDLENBQUMsQ0FBQztDQUN6RDtBQUVELE1BQU0saUJBQWlCLEdBQUc7SUFDeEIsTUFBTSxLQUFLLENBQUM7Q0FDYixDQUFDO0FBRUYsTUFBTSxPQUFnQixZQUFZO0lBUWhDLGdCQUFnQjtRQUNkLElBQUksSUFBSSxDQUFDLFNBQVMsRUFBRTtZQUNsQixNQUFNLElBQUksY0FBYyxFQUFFLENBQUM7U0FDNUI7SUFDSCxDQUFDOztBQVhNLGlCQUFJLEdBQWtCO0lBQzNCLFNBQVMsRUFBRSxLQUFLO0lBQ2hCLFNBQVMsQ0FBQyxDQUFXLElBQUksT0FBTyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7SUFDcEQsZ0JBQWdCLEtBQUssQ0FBQztDQUN2QixDQUFDO0FBWUosTUFBTSxDQUFDLE1BQU0sSUFBSSxHQUFVLEVBQUUsQ0FBQztBQU85QixNQUFNLE9BQU8sa0JBQW1CLFNBQVEsWUFBWTtJQUFwRDs7UUFJVyxjQUFTLEdBQUcsSUFBSSxLQUFLLEVBQVksQ0FBQztRQUMzQyxjQUFTLEdBQUcsS0FBSyxDQUFBO0lBc0JuQixDQUFDO0lBMUJDLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBNEIsRUFBRSxhQUE0QjtRQUNwRSxPQUFPLEVBQUUsSUFBSSxTQUFTLEtBQU0sT0FBTyxhQUFhLENBQUMsU0FBUyxJQUFJLGFBQWEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQTtJQUM1RixDQUFDO0lBR0QsSUFBSSxZQUFZLEtBQXFCLE9BQU8sSUFBSSxDQUFDLENBQUMsQ0FBQztJQUNuRCxNQUFNO1FBQ0osSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUM7UUFDdEIsSUFBSSxDQUFD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QUksQ0FBQyxZQUFZLENBQUMsQ0FBQztZQUMvQyxJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRTtnQkFDZCxNQUFNLElBQUksS0FBSyxDQUFDLGdEQUFnRCxDQUFDLENBQUM7YUFDbkU7WUFDRCxPQUFPLEtBQUssQ0FBQyxLQUFLLENBQUM7U0FDcEI7Z0JBQVM7WUFDUixRQUFRLENBQUMsTUFBTSxFQUFFLENBQUM7U0FDbkI7SUFDSCxDQUFDO0NBQ0Y7QUFpQkQsTUFBTSxPQUFPLGVBQWU7SUFBNUI7UUFDRSxVQUFLLEdBQWUsRUFBRSxDQUFDO0lBYXpCLENBQUM7SUFaQyxLQUFLLENBQUMsSUFBWTtRQUNoQixNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO1FBQ2pDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDWixNQUFNLElBQUksS0FBSyxDQUFDLHlDQUF5QyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1NBQ2xFO1FBQ0QsT0FBTyxPQUFPLEVBQUUsQ0FBQztJQUNuQixDQUFDO0lBQ0QsUUFBUSxDQUFjLElBQVksRUFBRSxPQUF5QztRQUMzRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQztJQUM3QixDQUFDO0lBQ0QsR0FBRyxDQUFJLElBQVksSUFBbUIsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNoRSxhQUFhLENBQWMsSUFBWSxJQUFnQyxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0NBQ2xHO0FBRUQsTUFBTSxZQUFZLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQztBQUUzQyxPQUFPLEVBQUUsWUFBWSxFQUFFLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBRIGZyb20gJy4vcHJvdG9jb2wnXG5cbmV4cG9ydCBjbGFzcyBDYW5jZWxsZWRFcnJvciBleHRlbmRzIEVycm9yIHtcbiAgY29uc3RydWN0b3IoKSB7IHN1cGVyKCdvcGVyYXRpb24gaGFzIGJlZW4gY2FuY2VsbGVkJyk7IH1cbn1cblxuY29uc3QgZHVtbXlTdWJzY3JpcHRpb24gPSB7XG4gIHJlbW92ZSgpIHsgfVxufTtcblxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIENhbmNlbGxhdGlvbiB7XG4gIHN0YXRpYyBub25lIDogQ2FuY2VsbGF0aW9uID0ge1xuICAgIGNhbmNlbGxlZDogZmFsc2UsXG4gICAgc3Vic2NyaWJlKF86IEZ1bmN0aW9uKSB7IHJldHVybiBkdW1teVN1YnNjcmlwdGlvbjsgfSxcbiAgICB0aHJvd0lmQ2FuY2VsbGVkKCkgeyB9XG4gIH07XG4gIGFic3RyYWN0IGNhbmNlbGxlZCA6IGJvb2xlYW5cbiAgYWJzdHJhY3Qgc3Vic2NyaWJlKGNhbGxiYWNrOiBGdW5jdGlvbik6IHsgcmVtb3ZlKCk6IHZvaWQgfVxuICB0aHJvd0lmQ2FuY2VsbGVkKCkge1xuICAgIGlmICh0aGlzLmNhbmNlbGxlZCkge1xuICAgICAgdGhyb3cgbmV3IENhbmNlbGxlZEVycm9yKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgTm9uZSB7IH1cblxuZXhwb3J0IGNvbnN0IE5vbmUgOiBOb25lID0ge307XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ2FuY2VsbGFibGVBc3luY0l0ZXJhdG9yPFQ+IHtcbiAgbmV4dChjYW5jZWxsYXRpb24/IDogQ2FuY2VsbGF0aW9uKSA6IFByb21pc2U8SXRlcmF0b3JSZXN1bHQ8VD4+XG4gIGNhbmNlbCgpIDogdm9pZFxufVxuXG5leHBvcnQgY2xhc3MgQ2FuY2VsbGF0aW9uU291cmNlIGV4dGVuZHMgQ2FuY2VsbGF0aW9uIHtcbiAgc3RhdGljIGxpbmsoY2FuY2VsbGF0aW9uMSA6IENhbmNlbGxhdGlvbiwgY2FuY2VsbGF0aW9uMiA6IENhbmNlbGxhdGlvbikge1xuICAgIHJldHVybiB7IGdldCBjYW5jZWxsZWQgKCkgeyByZXR1cm4gY2FuY2VsbGF0aW9uMS5jYW5jZWxsZWQgfHwgY2FuY2VsbGF0aW9uMi5jYW5jZWxsZWQ7IH0gfVxuICB9XG4gIHJlYWRvbmx5IGNhbGxiYWNrcyA9IG5ldyBBcnJheTxGdW5jdGlvbj4oKTtcbiAgY2FuY2VsbGVkID0gZmFsc2VcbiAgZ2V0IGNhbmNlbGxhdGlvbiAoKSA6IENhbmNlbGxhdGlvbiB7IHJldHVybiB0aGlzOyB9XG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLmNhbmNlbGxlZCA9IHRydWU7XG4gICAgdGhpcy5jYWxsYmFja3MuZm9yRWFjaChjYWxsYmFjayA9PiBjYWxsYmFjaygpKTtcbiAgICB0aGlzLmNhbGxiYWNrcy5zcGxpY2UoMCwgdGhpcy5jYWxsYmFja3MubGVuZ3RoKTtcbiAgfVxuICBzdWJzY3JpYmUoY2FsbGJhY2s6IEZ1bmN0aW9uKSB7XG4gICAgaWYgKHRoaXMuY2FsbGJhY2tzLnNvbWUoeCA9PiB4ID09PSBjYWxsYmFjaykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignY2FsbGJhY2sgYWxyZWFkeSByZWdpc3RlcmVkJyk7XG4gICAgfVxuICAgIHRoaXMuY2FsbGJhY2tzLnB1c2goY2FsbGJhY2spO1xuICAgIGNvbnN0IHRoYXQgPSB0aGlzO1xuICAgIHJldHVybiB7XG4gICAgICAgIHJlbW92ZSgpIHtcbiAgICAgICAgICBjb25zdCBpbmRleCA9IHRoYXQuY2FsbGJhY2tzLmluZGV4T2YoY2FsbGJhY2spO1xuICAgICAgICAgIGlmICgtMSAhPT0gaW5kZXgpIHtcbiAgICAgICAgICAgIHRoYXQuY2FsbGJhY2tzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBlbnVtIFF1ZXJ5U29ydERpcmVjdGlvbiB7XG4gICAgQXNjID0gJ2FzYycsXG4gICAgRGVzYyA9ICdkZXNjJ1xufVxuXG5leHBvcnQgYWJzdHJhY3QgY2xhc3MgUXVlcnk8VD4ge1xuICBhYnN0cmFjdCBleGVjKCk6IENhbmNlbGxhYmxlQXN5bmNJdGVyYXRvcjxUPlxuICBhYnN0cmFjdCBmaWx0ZXIocHJlZGljYXRlOiBzdHJpbmd8US5FeHByKTogUXVlcnk8VD47XG4gIGFic3RyYWN0IHNraXAobjogbnVtYmVyKTogUXVlcnk8VD47XG4gIGFic3RyYWN0IHRha2UobjogbnVtYmVyKTogUXVlcnk8VD47XG4gIGFic3RyYWN0IG9yZGVyQnkoc29ydEJ5OiBzdHJpbmcsIHNvcnRCeURpcmVjdGlvbjogUXVlcnlTb3J0RGlyZWN0aW9uKTogUXVlcnk8VD47XG4gIGFic3RyYWN0IHNldEN1c3RvbU9wdGlvbnMob3B0aW9uczogeyBba2V5OiBzdHJpbmddOiBzdHJpbmd8dW5kZWZpbmVkIH0sIHJlcGxhY2U/OiBib29sZWFuKTogUXVlcnk8VD47XG4gIGFic3RyYWN0IHRvdGFsKGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxudW1iZXI+XG5cbiAgYXN5bmMgZm9yRWFjaChjYWxsYmFjayA6IChpdGVtIDogVCwgaW5kZXggOiBudW1iZXIpID0+IFByb21pc2U8YW55PiwgY2FuY2VsbGF0aW9uPyA6IENhbmNlbGxhdGlvbikge1xuICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5leGVjKCk7XG4gICAgbGV0IGluZGV4ID0gMDtcbiAgICBjb25zdCBydW5uZXIgPSBhc3luYyAoKSA6IFByb21pc2U8dm9pZD4gPT4ge1xuICAgICAgY29uc3QgcmVzID0gYXdhaXQgaXRlcmF0b3IubmV4dChjYW5jZWxsYXRpb24pO1xuICAgICAgaWYgKHJlcy5kb25lKSB7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgfVxuICAgICAgYXdhaXQgY2FsbGJhY2socmVzLnZhbHVlLCBpbmRleCk7XG4gICAgICArK2luZGV4O1xuICAgICAgcmV0dXJuIGF3YWl0IHJ1bm5lcigpO1xuICAgIH1cbiAgICBhd2FpdCBydW5uZXIoKTtcbiAgfVxuICBhc3luYyB0b0FycmF5KGNhbmNlbGxhdGlvbj8gOiBDYW5jZWxsYXRpb24pIHtcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXk8VD4oKTtcbiAgICBhd2FpdCB0aGlzLmZvckVhY2goYXN5bmMgaXRlbSA9PiByZXN1bHQucHVzaChpdGVtKSwgY2FuY2VsbGF0aW9uKTtcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIGFzeW5jIGZpcnN0KGNhbmNlbGxhdGlvbj8gOiBDYW5jZWxsYXRpb24pIHtcbiAgICBjb25zdCBpdGVyYXRvciA9IHRoaXMuZXhlYygpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBmaXJzdCA9IGF3YWl0IGl0ZXJhdG9yLm5leHQoY2FuY2VsbGF0aW9uKTtcbiAgICAgIGlmIChmaXJzdC5kb25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignc2VxdWVuY2UgY29udGFpbnMgbm8gZWxlbWVudHMnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmaXJzdC52YWx1ZTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgaXRlcmF0b3IuY2FuY2VsKCk7XG4gICAgfVxuICB9XG4gIGFzeW5jIHRyeUZpcnN0KGNhbmNlbGxhdGlvbj8gOiBDYW5jZWxsYXRpb24pIDogUHJvbWlzZTxUIHwgTm9uZT4ge1xuICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5leGVjKCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpcnN0ID0gYXdhaXQgaXRlcmF0b3IubmV4dChjYW5jZWxsYXRpb24pO1xuICAgICAgcmV0dXJuIGZpcnN0LmRvbmUgPyBOb25lIDogZmlyc3QudmFsdWU7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGl0ZXJhdG9yLmNhbmNlbCgpO1xuICAgIH1cbiAgfVxuICBhc3luYyBzaW5nbGUoY2FuY2VsbGF0aW9uPyA6IENhbmNlbGxhdGlvbikge1xuICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5leGVjKCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpcnN0ID0gYXdhaXQgaXRlcmF0b3IubmV4dChjYW5jZWxsYXRpb24pO1xuICAgICAgaWYgKGZpcnN0LmRvbmUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdzZXF1ZW5jZSBjb250YWlucyBubyBlbGVtZW50cycpO1xuICAgICAgfVxuICAgICAgY29uc3QgbmV4dCA9IGF3YWl0IGl0ZXJhdG9yLm5leHQoY2FuY2VsbGF0aW9uKTtcbiAgICAgIGlmICghbmV4dC5kb25lKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignc2VxdWVuY2UgY29udGFpbnMgbW9yZSB0aGFuIDEgZWxlbWVudCBlbGVtZW50cycpO1xuICAgICAgfVxuICAgICAgcmV0dXJuIGZpcnN0LnZhbHVlO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBpdGVyYXRvci5jYW5jZWwoKTtcbiAgICB9XG4gIH1cbiAgYXN5bmMgdHJ5U2luZ2xlKGNhbmNlbGxhdGlvbj8gOiBDYW5jZWxsYXRpb24pIDogUHJvbWlzZTxUIHwgTm9uZT4ge1xuICAgIGNvbnN0IGl0ZXJhdG9yID0gdGhpcy5leGVjKCk7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGZpcnN0ID0gYXdhaXQgaXRlcmF0b3IubmV4dChjYW5jZWxsYXRpb24pO1xuICAgICAgaWYgKGZpcnN0LmRvbmUpIHtcbiAgICAgICAgcmV0dXJuIE5vbmVcbiAgICAgIH1cbiAgICAgIGNvbnN0IG5leHQgPSBhd2FpdCBpdGVyYXRvci5uZXh0KGNhbmNlbGxhdGlvbik7XG4gICAgICBpZiAoIW5leHQuZG9uZSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcXVlbmNlIGNvbnRhaW5zIG1vcmUgdGhhbiAxIGVsZW1lbnQgZWxlbWVudHMnKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBmaXJzdC52YWx1ZTtcbiAgICB9IGZpbmFsbHkge1xuICAgICAgaXRlcmF0b3IuY2FuY2VsKCk7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgUmVwb3NpdG9yeTxURGF0YT4ge1xuICBpdGVtczogUXVlcnk8VERhdGE+XG4gIHVwZGF0ZShpdGVtOiBURGF0YSwgY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFREYXRhPlxuICBpbnNlcnQoaXRlbTogVERhdGEsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxURGF0YT5cbiAgcmVtb3ZlKGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8dm9pZD5cbn1cblxuZXhwb3J0IGludGVyZmFjZSBLZXlSZXBvc2l0b3J5PFREYXRhLCBUS2V5PiBleHRlbmRzIFJlcG9zaXRvcnk8VERhdGE+IHtcbiAgbG9va3VwKGtleTogVEtleSwgY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFREYXRhPlxufVxuXG5pbnRlcmZhY2UgRmFjdG9yeU1hcCB7XG4gIFtrZXk6IHN0cmluZ106ICgoKSA9PiBhbnkpfHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGNsYXNzIFJlcG9zaXRvcnlTdG9yZSB7XG4gIHN0b3JlOiBGYWN0b3J5TWFwID0ge307XG4gIF9fZ2V0KG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnN0b3JlW25hbWVdO1xuICAgIGlmICghZmFjdG9yeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyByZXBvc2l0b3J5IGhhcyBiZWVuIHJlZ2lzdGVyZWQgZm9yICR7bmFtZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhY3RvcnkoKTtcbiAgfVxuICByZWdpc3RlcjxURGF0YSwgVEtleT4obmFtZTogc3RyaW5nLCBmYWN0b3J5OiAoKSA9PiBLZXlSZXBvc2l0b3J5PFREYXRhLCBUS2V5Pikge1xuICAgIHRoaXMuc3RvcmVbbmFtZV0gPSBmYWN0b3J5O1xuICB9XG4gIGdldDxUPihuYW1lOiBzdHJpbmcpOiBSZXBvc2l0b3J5PFQ+IHsgcmV0dXJuIHRoaXMuX19nZXQobmFtZSk7IH1cbiAgZ2V0UmVwb3NpdG9yeTxURGF0YSwgVEtleT4obmFtZTogc3RyaW5nKTogS2V5UmVwb3NpdG9yeTxURGF0YSwgVEtleT4geyByZXR1cm4gdGhpcy5fX2dldChuYW1lKTsgfVxufVxuXG5jb25zdCByZXBvc2l0b3JpZXMgPSBuZXcgUmVwb3NpdG9yeVN0b3JlKCk7XG5cbmV4cG9ydCB7IHJlcG9zaXRvcmllcyB9OyJdfQ==
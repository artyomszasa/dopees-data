import { CancellationSource } from 'dopees-core/lib/cancellation';
export class None {
}
export const none = new None();
export var QuerySortDirection;
(function (QuerySortDirection) {
    QuerySortDirection["Asc"] = "asc";
    QuerySortDirection["Desc"] = "desc";
})(QuerySortDirection || (QuerySortDirection = {}));
// ensure asyncIterator is present...
if (!Symbol.asyncIterator) {
    Symbol.asyncIterator = Symbol('asyncIterator');
}
// POLYFILL --> for await (xx in yy) is not yet supported :(
async function asyncForEach(iterable, callback) {
    // when supported this should be used...
    // for await (const item of iterable) {
    //   await callback(item);
    // }
    const iterator = iterable[Symbol.asyncIterator]();
    let res = await iterator.next();
    while (!res.done) {
        await callback(res.value);
        res = await iterator.next();
    }
}
export class Query {
    async forEach(callback, cancellation) {
        const iterable = this.exec(cancellation);
        let index = 0;
        // FIXME: when implemented replace with "for await"
        await asyncForEach(iterable, (item) => callback(item, index++));
    }
    async toArray(cancellation) {
        const result = new Array();
        await this.forEach(async (item) => result.push(item), cancellation);
        return result;
    }
    async first(cancellation) {
        const firstDone = new CancellationSource();
        const iterable = this.exec(cancellation ? CancellationSource.link(firstDone, cancellation) : firstDone);
        // TODO: when implemented replace with the one below
        const iterator = iterable[Symbol.asyncIterator]();
        const res = await iterator.next();
        if (!res.done) {
            firstDone.cancel();
            return res;
        }
        // for await (const item of iterable) {
        //   firstDone.cancel();
        //   return item;
        // }
        throw new Error('sequence contains no elements');
    }
    async tryFirst(cancellation) {
        const firstDone = new CancellationSource();
        const iterable = this.exec(cancellation ? CancellationSource.link(firstDone, cancellation) : firstDone);
        // TODO: when implemented replace with the one below
        const iterator = iterable[Symbol.asyncIterator]();
        const res = await iterator.next();
        if (!res.done) {
            firstDone.cancel();
            return res;
        }
        // for await (const item of iterable) {
        //   firstDone.cancel();
        //   return item;
        // }
        return none;
    }
    async single(cancellation) {
        let result = none;
        const iterable = this.exec(cancellation);
        // TODO: when implemented replace with the one below
        const iterator = iterable[Symbol.asyncIterator]();
        let res = await iterator.next();
        if (!res.done) {
            result = res.value;
        }
        else {
            throw new Error('sequence contains no elements');
        }
        res = await iterator.next();
        if (!res.done) {
            throw new Error('sequence contains more than 1 element elements');
        }
        // for await (const item of iterable) {
        //   if (none !== result) {
        //     throw new Error('sequence contains more than 1 element elements');
        //   } else {
        //     result = item;
        //   }
        // }
        // if (none === result) {
        //   throw new Error('sequence contains no elements');
        // }
        return result;
    }
    async trySingle(cancellation) {
        let result = none;
        const iterable = this.exec(cancellation);
        // TODO: when implemented replace with the one below
        const iterator = iterable[Symbol.asyncIterator]();
        let res = await iterator.next();
        if (!res.done) {
            result = res.value;
        }
        else {
            return none;
        }
        res = await iterator.next();
        if (!res.done) {
            throw new Error('sequence contains more than 1 element elements');
        }
        // for await (const item of iterable) {
        //   if (none !== result) {
        //     throw new Error('sequence contains more than 1 element elements');
        //   } else {
        //     result = item;
        //   }
        // }
        return result;
    }
}
export class RepositoryStore {
    constructor() {
        this.store = {};
    }
    __get(name) {
        const factory = this.store[name];
        if (!factory) {
            throw new Error(`no repository has been registered for ${name}`);
        }
        return factory();
    }
    register(name, factory) {
        this.store[name] = factory;
    }
    get(name) { return this.__get(name); }
    getRepository(name) { return this.__get(name); }
}
export const repositories = new RepositoryStore();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVwb3NpdG9yaWVzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL3JlcG9zaXRvcmllcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQWdCLGtCQUFrQixFQUFFLE1BQU0sOEJBQThCLENBQUM7QUFHaEYsTUFBTSxPQUFPLElBQUk7Q0FBSTtBQUVyQixNQUFNLENBQUMsTUFBTSxJQUFJLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztBQUUvQixNQUFNLENBQU4sSUFBWSxrQkFHWDtBQUhELFdBQVksa0JBQWtCO0lBQzFCLGlDQUFXLENBQUE7SUFDWCxtQ0FBYSxDQUFBO0FBQ2pCLENBQUMsRUFIVyxrQkFBa0IsS0FBbEIsa0JBQWtCLFFBRzdCO0FBRUQscUNBQXFDO0FBQ3JDLElBQUksQ0FBQyxNQUFNLENBQUMsYUFBYSxFQUFFO0lBQ2xCLE1BQU8sQ0FBQyxhQUFhLEdBQUcsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0NBQ3hEO0FBRUQsNERBQTREO0FBQzVELEtBQUssVUFBVSxZQUFZLENBQUksUUFBMEIsRUFBRSxRQUFxQztJQUM5Rix3Q0FBd0M7SUFDeEMsdUNBQXVDO0lBQ3ZDLDBCQUEwQjtJQUMxQixJQUFJO0lBQ0osTUFBTSxRQUFRLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxhQUFhLENBQUMsRUFBRSxDQUFDO0lBQ2xELElBQUksR0FBRyxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksRUFBRSxDQUFDO0lBQ2hDLE9BQU8sQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFO1FBQ2hCLE1BQU0sUUFBUSxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxQixHQUFHLEdBQUcsTUFBTSxRQUFRLENBQUMsSUFBSSxFQUFFLENBQUM7S0FDN0I7QUFDSCxDQUFDO0FBRUQsTUFBTSxPQUFnQixLQUFLO0lBU3pCLEtBQUssQ0FBQyxPQUFPLENBQUMsUUFBa0QsRUFBRSxZQUEyQjtRQUMzRixNQUFNLFFBQVEs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QU8sZUFBZTtJQUE1QjtRQUNFLFVBQUssR0FBZSxFQUFFLENBQUM7SUFhekIsQ0FBQztJQVpDLEtBQUssQ0FBQyxJQUFZO1FBQ2hCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDakMsSUFBSSxDQUFDLE9BQU8sRUFBRTtZQUNaLE1BQU0sSUFBSSxLQUFLLENBQUMseUNBQXlDLElBQUksRUFBRSxDQUFDLENBQUM7U0FDbEU7UUFDRCxPQUFPLE9BQU8sRUFBRSxDQUFDO0lBQ25CLENBQUM7SUFDRCxRQUFRLENBQWMsSUFBWSxFQUFFLE9BQXlDO1FBQzNFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDO0lBQzdCLENBQUM7SUFDRCxHQUFHLENBQUksSUFBWSxJQUFtQixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2hFLGFBQWEsQ0FBYyxJQUFZLElBQWdDLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7Q0FDbEc7QUFFRCxNQUFNLENBQUMsTUFBTSxZQUFZLEdBQUcsSUFBSSxlQUFlLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IENhbmNlbGxhdGlvbiwgQ2FuY2VsbGF0aW9uU291cmNlIH0gZnJvbSAnZG9wZWVzLWNvcmUvbGliL2NhbmNlbGxhdGlvbic7XG5pbXBvcnQgKiBhcyBRIGZyb20gJy4vcHJvdG9jb2wnO1xuXG5leHBvcnQgY2xhc3MgTm9uZSB7IH1cblxuZXhwb3J0IGNvbnN0IG5vbmUgPSBuZXcgTm9uZSgpO1xuXG5leHBvcnQgZW51bSBRdWVyeVNvcnREaXJlY3Rpb24ge1xuICAgIEFzYyA9ICdhc2MnLFxuICAgIERlc2MgPSAnZGVzYydcbn1cblxuLy8gZW5zdXJlIGFzeW5jSXRlcmF0b3IgaXMgcHJlc2VudC4uLlxuaWYgKCFTeW1ib2wuYXN5bmNJdGVyYXRvcikge1xuICAoPGFueT4gU3ltYm9sKS5hc3luY0l0ZXJhdG9yID0gU3ltYm9sKCdhc3luY0l0ZXJhdG9yJyk7XG59XG5cbi8vIFBPTFlGSUxMIC0tPiBmb3IgYXdhaXQgKHh4IGluIHl5KSBpcyBub3QgeWV0IHN1cHBvcnRlZCA6KFxuYXN5bmMgZnVuY3Rpb24gYXN5bmNGb3JFYWNoPFQ+KGl0ZXJhYmxlOiBBc3luY0l0ZXJhYmxlPFQ+LCBjYWxsYmFjazogKGl0ZW06IFQpID0+IFByb21pc2VMaWtlPFQ+KSB7XG4gIC8vIHdoZW4gc3VwcG9ydGVkIHRoaXMgc2hvdWxkIGJlIHVzZWQuLi5cbiAgLy8gZm9yIGF3YWl0IChjb25zdCBpdGVtIG9mIGl0ZXJhYmxlKSB7XG4gIC8vICAgYXdhaXQgY2FsbGJhY2soaXRlbSk7XG4gIC8vIH1cbiAgY29uc3QgaXRlcmF0b3IgPSBpdGVyYWJsZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTtcbiAgbGV0IHJlcyA9IGF3YWl0IGl0ZXJhdG9yLm5leHQoKTtcbiAgd2hpbGUgKCFyZXMuZG9uZSkge1xuICAgIGF3YWl0IGNhbGxiYWNrKHJlcy52YWx1ZSk7XG4gICAgcmVzID0gYXdhaXQgaXRlcmF0b3IubmV4dCgpO1xuICB9XG59XG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBRdWVyeTxUPiB7XG4gIGFic3RyYWN0IGV4ZWMoY2FuY2VsbGF0aW9uPzogQ2FuY2VsbGF0aW9uKTogQXN5bmNJdGVyYWJsZTxUPjtcbiAgYWJzdHJhY3QgZmlsdGVyKHByZWRpY2F0ZTogc3RyaW5nfFEuRXhwcik6IFF1ZXJ5PFQ+O1xuICBhYnN0cmFjdCBza2lwKG46IG51bWJlcik6IFF1ZXJ5PFQ+O1xuICBhYnN0cmFjdCB0YWtlKG46IG51bWJlcik6IFF1ZXJ5PFQ+O1xuICBhYnN0cmFjdCBvcmRlckJ5KHNvcnRCeTogc3RyaW5nLCBzb3J0QnlEaXJlY3Rpb246IFF1ZXJ5U29ydERpcmVjdGlvbik6IFF1ZXJ5PFQ+O1xuICBhYnN0cmFjdCBzZXRDdXN0b21PcHRpb25zKG9wdGlvbnM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nfHVuZGVmaW5lZCB9LCByZXBsYWNlPzogYm9vbGVhbik6IFF1ZXJ5PFQ+O1xuICBhYnN0cmFjdCB0b3RhbChjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPG51bWJlcj47XG5cbiAgYXN5bmMgZm9yRWFjaChjYWxsYmFjazogKGl0ZW06IFQsIGluZGV4OiBudW1iZXIpID0+IFByb21pc2U8YW55PiwgY2FuY2VsbGF0aW9uPzogQ2FuY2VsbGF0aW9uKSB7XG4gICAgY29uc3QgaXRlcmFibGUgPSB0aGlzLmV4ZWMoY2FuY2VsbGF0aW9uKTtcbiAgICBsZXQgaW5kZXggPSAwO1xuICAgIC8vIEZJWE1FOiB3aGVuIGltcGxlbWVudGVkIHJlcGxhY2Ugd2l0aCBcImZvciBhd2FpdFwiXG4gICAgYXdhaXQgYXN5bmNGb3JFYWNoKGl0ZXJhYmxlLCAoaXRlbSkgPT4gY2FsbGJhY2soaXRlbSwgaW5kZXgrKykpO1xuICB9XG5cbiAgYXN5bmMgdG9BcnJheShjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pIHtcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgQXJyYXk8VD4oKTtcbiAgICBhd2FpdCB0aGlzLmZvckVhY2goYXN5bmMgKGl0ZW0pID0+IHJlc3VsdC5wdXNoKGl0ZW0pLCBjYW5jZWxsYXRpb24pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH1cblxuICBhc3luYyBmaXJzdChjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pIHtcbiAgICBjb25zdCBmaXJzdERvbmUgPSBuZXcgQ2FuY2VsbGF0aW9uU291cmNlKCk7XG4gICAgY29uc3QgaXRlcmFibGUgPSB0aGlzLmV4ZWMoY2FuY2VsbGF0aW9uID8gQ2FuY2VsbGF0aW9uU291cmNlLmxpbmsoZmlyc3REb25lLCBjYW5jZWxsYXRpb24pIDogZmlyc3REb25lKTtcbiAgICAvLyBUT0RPOiB3aGVuIGltcGxlbWVudGVkIHJlcGxhY2Ugd2l0aCB0aGUgb25lIGJlbG93XG4gICAgY29uc3QgaXRlcmF0b3IgPSBpdGVyYWJsZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG4gICAgaWYgKCFyZXMuZG9uZSkge1xuICAgICAgZmlyc3REb25lLmNhbmNlbCgpO1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gICAgLy8gZm9yIGF3YWl0IChjb25zdCBpdGVtIG9mIGl0ZXJhYmxlKSB7XG4gICAgLy8gICBmaXJzdERvbmUuY2FuY2VsKCk7XG4gICAgLy8gICByZXR1cm4gaXRlbTtcbiAgICAvLyB9XG4gICAgdGhyb3cgbmV3IEVycm9yKCdzZXF1ZW5jZSBjb250YWlucyBubyBlbGVtZW50cycpO1xuICB9XG5cbiAgYXN5bmMgdHJ5Rmlyc3QoY2FuY2VsbGF0aW9uPzogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxUfE5vbmU+IHtcbiAgICBjb25zdCBmaXJzdERvbmUgPSBuZXcgQ2FuY2VsbGF0aW9uU291cmNlKCk7XG4gICAgY29uc3QgaXRlcmFibGUgPSB0aGlzLmV4ZWMoY2FuY2VsbGF0aW9uID8gQ2FuY2VsbGF0aW9uU291cmNlLmxpbmsoZmlyc3REb25lLCBjYW5jZWxsYXRpb24pIDogZmlyc3REb25lKTtcbiAgICAvLyBUT0RPOiB3aGVuIGltcGxlbWVudGVkIHJlcGxhY2Ugd2l0aCB0aGUgb25lIGJlbG93XG4gICAgY29uc3QgaXRlcmF0b3IgPSBpdGVyYWJsZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTtcbiAgICBjb25zdCByZXMgPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG4gICAgaWYgKCFyZXMuZG9uZSkge1xuICAgICAgZmlyc3REb25lLmNhbmNlbCgpO1xuICAgICAgcmV0dXJuIHJlcztcbiAgICB9XG4gICAgLy8gZm9yIGF3YWl0IChjb25zdCBpdGVtIG9mIGl0ZXJhYmxlKSB7XG4gICAgLy8gICBmaXJzdERvbmUuY2FuY2VsKCk7XG4gICAgLy8gICByZXR1cm4gaXRlbTtcbiAgICAvLyB9XG4gICAgcmV0dXJuIG5vbmU7XG4gIH1cblxuICBhc3luYyBzaW5nbGUoY2FuY2VsbGF0aW9uPzogQ2FuY2VsbGF0aW9uKSB7XG4gICAgbGV0IHJlc3VsdDogTm9uZXxUID0gbm9uZTtcbiAgICBjb25zdCBpdGVyYWJsZSA9IHRoaXMuZXhlYyhjYW5jZWxsYXRpb24pO1xuICAgIC8vIFRPRE86IHdoZW4gaW1wbGVtZW50ZWQgcmVwbGFjZSB3aXRoIHRoZSBvbmUgYmVsb3dcbiAgICBjb25zdCBpdGVyYXRvciA9IGl0ZXJhYmxlW1N5bWJvbC5hc3luY0l0ZXJhdG9yXSgpO1xuICAgIGxldCByZXMgPSBhd2FpdCBpdGVyYXRvci5uZXh0KCk7XG4gICAgaWYgKCFyZXMuZG9uZSkge1xuICAgICAgcmVzdWx0ID0gcmVzLnZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcXVlbmNlIGNvbnRhaW5zIG5vIGVsZW1lbnRzJyk7XG4gICAgfVxuICAgIHJlcyA9IGF3YWl0IGl0ZXJhdG9yLm5leHQoKTtcbiAgICBpZiAoIXJlcy5kb25lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcXVlbmNlIGNvbnRhaW5zIG1vcmUgdGhhbiAxIGVsZW1lbnQgZWxlbWVudHMnKTtcbiAgICB9XG4gICAgLy8gZm9yIGF3YWl0IChjb25zdCBpdGVtIG9mIGl0ZXJhYmxlKSB7XG4gICAgLy8gICBpZiAobm9uZSAhPT0gcmVzdWx0KSB7XG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcignc2VxdWVuY2UgY29udGFpbnMgbW9yZSB0aGFuIDEgZWxlbWVudCBlbGVtZW50cycpO1xuICAgIC8vICAgfSBlbHNlIHtcbiAgICAvLyAgICAgcmVzdWx0ID0gaXRlbTtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgLy8gaWYgKG5vbmUgPT09IHJlc3VsdCkge1xuICAgIC8vICAgdGhyb3cgbmV3IEVycm9yKCdzZXF1ZW5jZSBjb250YWlucyBubyBlbGVtZW50cycpO1xuICAgIC8vIH1cbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG4gIGFzeW5jIHRyeVNpbmdsZShjYW5jZWxsYXRpb24/OiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPFR8Tm9uZT4ge1xuICAgIGxldCByZXN1bHQ6IE5vbmV8VCA9IG5vbmU7XG4gICAgY29uc3QgaXRlcmFibGUgPSB0aGlzLmV4ZWMoY2FuY2VsbGF0aW9uKTtcbiAgICAvLyBUT0RPOiB3aGVuIGltcGxlbWVudGVkIHJlcGxhY2Ugd2l0aCB0aGUgb25lIGJlbG93XG4gICAgY29uc3QgaXRlcmF0b3IgPSBpdGVyYWJsZVtTeW1ib2wuYXN5bmNJdGVyYXRvcl0oKTtcbiAgICBsZXQgcmVzID0gYXdhaXQgaXRlcmF0b3IubmV4dCgpO1xuICAgIGlmICghcmVzLmRvbmUpIHtcbiAgICAgIHJlc3VsdCA9IHJlcy52YWx1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIG5vbmU7XG4gICAgfVxuICAgIHJlcyA9IGF3YWl0IGl0ZXJhdG9yLm5leHQoKTtcbiAgICBpZiAoIXJlcy5kb25lKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ3NlcXVlbmNlIGNvbnRhaW5zIG1vcmUgdGhhbiAxIGVsZW1lbnQgZWxlbWVudHMnKTtcbiAgICB9XG4gICAgLy8gZm9yIGF3YWl0IChjb25zdCBpdGVtIG9mIGl0ZXJhYmxlKSB7XG4gICAgLy8gICBpZiAobm9uZSAhPT0gcmVzdWx0KSB7XG4gICAgLy8gICAgIHRocm93IG5ldyBFcnJvcignc2VxdWVuY2UgY29udGFpbnMgbW9yZSB0aGFuIDEgZWxlbWVudCBlbGVtZW50cycpO1xuICAgIC8vICAgfSBlbHNlIHtcbiAgICAvLyAgICAgcmVzdWx0ID0gaXRlbTtcbiAgICAvLyAgIH1cbiAgICAvLyB9XG4gICAgcmV0dXJuIHJlc3VsdDtcbiAgfVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIFJlcG9zaXRvcnk8VERhdGE+IHtcbiAgaXRlbXM6IFF1ZXJ5PFREYXRhPjtcbiAgdXBkYXRlKGl0ZW06IFREYXRhLCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+O1xuICBpbnNlcnQoaXRlbTogVERhdGEsIGNhbmNlbGxhdGlvbjogQ2FuY2VsbGF0aW9uKTogUHJvbWlzZTxURGF0YT47XG4gIHJlbW92ZShpdGVtOiBURGF0YSwgY2FuY2VsbGF0aW9uOiBDYW5jZWxsYXRpb24pOiBQcm9taXNlPHZvaWQ+O1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEtleVJlcG9zaXRvcnk8VERhdGEsIFRLZXk+IGV4dGVuZHMgUmVwb3NpdG9yeTxURGF0YT4ge1xuICBsb29rdXAoa2V5OiBUS2V5LCBjYW5jZWxsYXRpb246IENhbmNlbGxhdGlvbik6IFByb21pc2U8VERhdGE+O1xufVxuXG5pbnRlcmZhY2UgRmFjdG9yeU1hcCB7XG4gIFtrZXk6IHN0cmluZ106ICgoKSA9PiBhbnkpfHVuZGVmaW5lZDtcbn1cblxuZXhwb3J0IGNsYXNzIFJlcG9zaXRvcnlTdG9yZSB7XG4gIHN0b3JlOiBGYWN0b3J5TWFwID0ge307XG4gIF9fZ2V0KG5hbWU6IHN0cmluZykge1xuICAgIGNvbnN0IGZhY3RvcnkgPSB0aGlzLnN0b3JlW25hbWVdO1xuICAgIGlmICghZmFjdG9yeSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBubyByZXBvc2l0b3J5IGhhcyBiZWVuIHJlZ2lzdGVyZWQgZm9yICR7bmFtZX1gKTtcbiAgICB9XG4gICAgcmV0dXJuIGZhY3RvcnkoKTtcbiAgfVxuICByZWdpc3RlcjxURGF0YSwgVEtleT4obmFtZTogc3RyaW5nLCBmYWN0b3J5OiAoKSA9PiBLZXlSZXBvc2l0b3J5PFREYXRhLCBUS2V5Pikge1xuICAgIHRoaXMuc3RvcmVbbmFtZV0gPSBmYWN0b3J5O1xuICB9XG4gIGdldDxUPihuYW1lOiBzdHJpbmcpOiBSZXBvc2l0b3J5PFQ+IHsgcmV0dXJuIHRoaXMuX19nZXQobmFtZSk7IH1cbiAgZ2V0UmVwb3NpdG9yeTxURGF0YSwgVEtleT4obmFtZTogc3RyaW5nKTogS2V5UmVwb3NpdG9yeTxURGF0YSwgVEtleT4geyByZXR1cm4gdGhpcy5fX2dldChuYW1lKTsgfVxufVxuXG5leHBvcnQgY29uc3QgcmVwb3NpdG9yaWVzID0gbmV3IFJlcG9zaXRvcnlTdG9yZSgpO1xuIl19